<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;title&gt;C++&nbsp;ABI:&nbsp;&nbsp;COMDAT&nbsp;Proposal&lt;/title&gt;<br>
<br>
&lt;font&nbsp;size=6&gt;&lt;i&gt;&lt;b&gt;<br>
&lt;p&gt;<br>
C++&nbsp;ABI:&nbsp;&nbsp;COMDAT&nbsp;Proposal<br>
&lt;/b&gt;&lt;/i&gt;&lt;/font&gt;<br>
<br>
&lt;p&gt;<br>
&lt;i&gt;Revised&nbsp;4&nbsp;October&nbsp;1999&lt;/i&gt;<br>
<br>
&lt;/head&gt;<br>
&lt;body&gt;<br>
<br>
&lt;p&gt;<br>
&lt;hr&nbsp;WIDTH=&quot;100%&quot;&gt;<br>
<br>
&lt;p&gt;<br>
&lt;h3&gt;&nbsp;Introduction&nbsp;&lt;/h3&gt;<br>
<br>
&lt;p&gt;<br>
C++&nbsp;has&nbsp;many&nbsp;situations&nbsp;where&nbsp;the&nbsp;compiler&nbsp;may&nbsp;need&nbsp;to&nbsp;emit&nbsp;code&nbsp;or&nbsp;data,<br>
but&nbsp;may&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;identify&nbsp;a&nbsp;unique&nbsp;compilation&nbsp;unit<br>
where&nbsp;it&nbsp;should&nbsp;be&nbsp;emitted.<br>
The&nbsp;approach&nbsp;chosen&nbsp;by&nbsp;the&nbsp;C++&nbsp;ABI&nbsp;group&nbsp;to&nbsp;deal&nbsp;with&nbsp;this&nbsp;problem,<br>
is&nbsp;to&nbsp;allow&nbsp;the&nbsp;compiler&nbsp;to&nbsp;emit&nbsp;the&nbsp;required&nbsp;information&nbsp;in&nbsp;multiple<br>
compilation&nbsp;units,<br>
in&nbsp;a&nbsp;form&nbsp;which&nbsp;allows&nbsp;the&nbsp;linker&nbsp;to&nbsp;remove&nbsp;all&nbsp;but&nbsp;one&nbsp;copy.<br>
This&nbsp;is&nbsp;essentially&nbsp;the&nbsp;idea&nbsp;called&nbsp;COMDAT&nbsp;in&nbsp;several&nbsp;existing<br>
implementations.<br>
<br>
&lt;p&gt;<br>
Our&nbsp;objectives&nbsp;include:<br>
<br>
&lt;ul&gt;<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
Use&nbsp;existing&nbsp;structures&nbsp;as&nbsp;far&nbsp;as&nbsp;possible,<br>
to&nbsp;minimize&nbsp;impact&nbsp;on&nbsp;existing&nbsp;tools.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
Minimize&nbsp;impact&nbsp;on&nbsp;the&nbsp;linker&nbsp;by&nbsp;defining&nbsp;the&nbsp;unit&nbsp;of&nbsp;duplication<br>
as&nbsp;a&nbsp;section.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
Maximize&nbsp;generality.<br>
The&nbsp;C++&nbsp;needs&nbsp;are&nbsp;rather&nbsp;varied,<br>
and&nbsp;similar&nbsp;needs&nbsp;from&nbsp;other&nbsp;languages&nbsp;should&nbsp;also&nbsp;be&nbsp;handled.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
In&nbsp;general,&nbsp;duplicated&nbsp;code&nbsp;or&nbsp;data&nbsp;sections&nbsp;are&nbsp;accompanied&nbsp;by<br>
additional&nbsp;duplicated&nbsp;sections,&nbsp;e.g.&nbsp;containing&nbsp;debug&nbsp;information.<br>
We&nbsp;want&nbsp;to&nbsp;define&nbsp;a&nbsp;mechanism&nbsp;which&nbsp;can&nbsp;deal&nbsp;with&nbsp;arbitrary&nbsp;such<br>
associations,&nbsp;without&nbsp;predicting&nbsp;them&nbsp;in&nbsp;advance.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
It&nbsp;is&nbsp;conceivable&nbsp;that&nbsp;duplicates&nbsp;may&nbsp;occur&nbsp;for&nbsp;something&nbsp;which&nbsp;is&nbsp;not<br>
recognized&nbsp;as&nbsp;a&nbsp;full&nbsp;duplicate&nbsp;at&nbsp;compile&nbsp;time.<br>
A&nbsp;possible&nbsp;example&nbsp;is&nbsp;a&nbsp;template&nbsp;instantiation&nbsp;which&nbsp;duplicates&nbsp;a<br>
full&nbsp;specialization&nbsp;in&nbsp;some&nbsp;compilation&nbsp;unit.<br>
It&nbsp;is&nbsp;desirable&nbsp;to&nbsp;deal&nbsp;with&nbsp;this&nbsp;case&nbsp;if&nbsp;possible.<br>
<br>
&lt;/ul&gt;<br>
<br>
&lt;p&gt;<br>
&lt;h3&gt;&nbsp;Proposal&nbsp;&lt;/h3&gt;<br>
<br>
&lt;p&gt;<br>
The&nbsp;proposal&nbsp;below&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;HP&nbsp;definition,<br>
with&nbsp;minor&nbsp;modifications&nbsp;and&nbsp;more&nbsp;precise&nbsp;definitions.<br>
<br>
&lt;p&gt;<br>
&lt;h4&gt;&nbsp;SHF_COMDAT:&nbsp;Potentially&nbsp;Duplicate&nbsp;Sections&nbsp;&lt;/h4&gt;<br>
<br>
A&nbsp;section&nbsp;which&nbsp;may&nbsp;be&nbsp;duplicated,<br>
and&nbsp;for&nbsp;which&nbsp;only&nbsp;one&nbsp;copy&nbsp;is&nbsp;required,<br>
is&nbsp;identified&nbsp;by&nbsp;a&nbsp;new&nbsp;section&nbsp;header&nbsp;attribute:<br>
<br>
&lt;dl&gt;<br>
&lt;dt&gt;&nbsp;SHF_COMDAT<br>
&lt;dd&gt;&nbsp;This&nbsp;section&nbsp;is&nbsp;subject&nbsp;to&nbsp;duplication&nbsp;in&nbsp;other&nbsp;relocatable&nbsp;objects,<br>
&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;the&nbsp;linker&nbsp;should&nbsp;choose&nbsp;only&nbsp;one&nbsp;copy&nbsp;to&nbsp;retain.<br>
&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;section&nbsp;must&nbsp;be&nbsp;referenced&nbsp;in&nbsp;a&nbsp;SHT_COMDAT_GROUP&nbsp;section&nbsp;(see&nbsp;below).<br>
&lt;/dl&gt;<br>
<br>
&lt;p&gt;<br>
This&nbsp;attribute&nbsp;flag&nbsp;may&nbsp;be&nbsp;set&nbsp;in&nbsp;any&nbsp;section&nbsp;header,<br>
and&nbsp;no&nbsp;other&nbsp;modification&nbsp;or&nbsp;indication&nbsp;is&nbsp;made&nbsp;in&nbsp;the&nbsp;potentially<br>
duplicated&nbsp;sections.<br>
All&nbsp;additional&nbsp;information&nbsp;is&nbsp;contained&nbsp;in&nbsp;the&nbsp;associated<br>
SHT_COMDAT_GROUP&nbsp;section&nbsp;(see&nbsp;below).<br>
<br>
&lt;p&gt;<br>
&lt;h4&gt;&nbsp;SHT_COMDAT_GROUP:&nbsp;COMDAT&nbsp;Group&nbsp;Definition&nbsp;&lt;/h4&gt;<br>
<br>
&lt;p&gt;<br>
COMDAT&nbsp;sections&nbsp;are&nbsp;assumed&nbsp;to&nbsp;occur&nbsp;in&nbsp;interrelated&nbsp;groups.<br>
For&nbsp;instance,&nbsp;an&nbsp;out-of-line&nbsp;definition&nbsp;of&nbsp;an&nbsp;inline&nbsp;function&nbsp;might&nbsp;require,<br>
in&nbsp;addition&nbsp;to&nbsp;its&nbsp;.text&nbsp;section,<br>
a&nbsp;read-only&nbsp;data&nbsp;section&nbsp;containing&nbsp;literals&nbsp;referenced,<br>
one&nbsp;or&nbsp;more&nbsp;debug&nbsp;information&nbsp;sections,<br>
and/or&nbsp;other&nbsp;informational&nbsp;sections.<br>
Furthermore,&nbsp;there&nbsp;may&nbsp;be&nbsp;internal&nbsp;references&nbsp;among&nbsp;these&nbsp;sections&nbsp;that<br>
would&nbsp;not&nbsp;make&nbsp;sense&nbsp;if&nbsp;one&nbsp;of&nbsp;them&nbsp;were&nbsp;replaced&nbsp;by&nbsp;a&nbsp;duplicate&nbsp;from<br>
another&nbsp;object.<br>
Therefore,&nbsp;we&nbsp;assume&nbsp;that&nbsp;such&nbsp;groups&nbsp;are&nbsp;to&nbsp;be&nbsp;included&nbsp;or&nbsp;omitted<br>
from&nbsp;the&nbsp;linked&nbsp;object&nbsp;as&nbsp;a&nbsp;unit.<br>
To&nbsp;facilitate&nbsp;this,&nbsp;we&nbsp;define&nbsp;a&nbsp;SHT_COMDAT_GROUP&nbsp;section:<br>
<br>
&lt;p&gt;<br>
The&nbsp;section&nbsp;header&nbsp;attributes&nbsp;of&nbsp;a&nbsp;COMDAT&nbsp;Group&nbsp;Section&nbsp;are:<br>
<br>
&lt;p&gt;<br>
&lt;TABLE&nbsp;align=center&nbsp;BORDER=2&nbsp;CELLSPACING=2&nbsp;CELLPADDING=2&gt;<br>
<br>
&lt;TR&gt;<br>
&lt;TD&gt;&lt;b&gt;&nbsp;name&nbsp;&lt;/b&gt;&lt;/TD&gt;<br>
&lt;TD&gt;&lt;code&gt;&nbsp;.COMDAT_group&nbsp;&lt;/codet&gt;&lt;/TD&gt;<br>
&lt;/TR&gt;<br>
<br>
&lt;TR&gt;<br>
&lt;TD&gt;&lt;code&gt;&nbsp;sh_type&nbsp;&lt;/code&gt;&lt;/TD&gt;<br>
&lt;TD&gt;&lt;code&gt;&nbsp;SHT_COMDAT_GROUP&nbsp;&lt;/code&gt;&lt;/TD&gt;<br>
&lt;/TR&gt;<br>
<br>
&lt;TR&gt;<br>
&lt;TD&gt;&lt;code&gt;&nbsp;sh_link&nbsp;&lt;/code&gt;&lt;/TD&gt;<br>
&lt;TD&gt;&lt;code&gt;&nbsp;.symtab&nbsp;&lt;/code&gt;&nbsp;section&nbsp;index&nbsp;&lt;/TD&gt;<br>
&lt;/TR&gt;<br>
<br>
&lt;TR&gt;<br>
&lt;TD&gt;&lt;code&gt;&nbsp;sh_info&nbsp;&lt;/code&gt;&lt;/TD&gt;<br>
&lt;TD&gt;&nbsp;symbol&nbsp;index&nbsp;&lt;/TD&gt;<br>
&lt;/TR&gt;<br>
<br>
&lt;TR&gt;<br>
&lt;TD&gt;&lt;code&gt;&nbsp;sh_flags&nbsp;&lt;/code&gt;&lt;/TD&gt;<br>
&lt;TD&gt;&nbsp;none&nbsp;&lt;/TD&gt;<br>
&lt;/TR&gt;<br>
<br>
&lt;TR&gt;<br>
&lt;TD&gt;&lt;code&gt;&nbsp;sh_entsize&nbsp;&lt;/code&gt;&lt;/TD&gt;<br>
&lt;TD&gt;&nbsp;size&nbsp;of&nbsp;section&nbsp;indices&nbsp;(&lt;code&gt;4&lt;/code&gt;)&nbsp;&lt;/TD&gt;<br>
&lt;/TR&gt;<br>
<br>
&lt;TR&gt;<br>
&lt;TD&gt;&nbsp;requirements&nbsp;&lt;/TD&gt;<br>
&lt;TD&gt;&nbsp;may&nbsp;not&nbsp;be&nbsp;stripped&nbsp;&lt;/TD&gt;<br>
&lt;/TR&gt;<br>
<br>
&lt;/TABLE&gt;<br>
<br>
&lt;p&gt;<br>
The&nbsp;COMDAT&nbsp;group's&nbsp;&lt;code&gt;&nbsp;sh_link&nbsp;&lt;/code&gt;&nbsp;field&nbsp;identifies&nbsp;a&nbsp;symbol<br>
table&nbsp;section,&nbsp;and&nbsp;its&nbsp;&lt;code&gt;&nbsp;sh_info&nbsp;&lt;/code&gt;&nbsp;field&nbsp;the&nbsp;index&nbsp;of&nbsp;a<br>
symbol&nbsp;in&nbsp;that&nbsp;section.<br>
The&nbsp;name&nbsp;of&nbsp;that&nbsp;symbol&nbsp;is&nbsp;treated&nbsp;as&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;COMDAT&nbsp;group.<br>
If&nbsp;multiple&nbsp;COMDAT&nbsp;groups&nbsp;in&nbsp;different&nbsp;object&nbsp;files&nbsp;are&nbsp;identified<br>
by&nbsp;symbols&nbsp;with&nbsp;the&nbsp;same&nbsp;name,<br>
the&nbsp;linker&nbsp;should&nbsp;remove&nbsp;all&nbsp;but&nbsp;one&nbsp;of&nbsp;the&nbsp;groups.<br>
If&nbsp;the&nbsp;identifying&nbsp;symbol&nbsp;is&nbsp;defined&nbsp;in&nbsp;a&nbsp;non-COMDAT&nbsp;section&nbsp;in<br>
some&nbsp;object,&nbsp;the&nbsp;linker&nbsp;should&nbsp;remove&nbsp;all&nbsp;of&nbsp;the&nbsp;COMDAT&nbsp;groups<br>
identified&nbsp;by&nbsp;that&nbsp;symbol.<br>
<br>
&lt;p&gt;<br>
The&nbsp;section&nbsp;data&nbsp;of&nbsp;a&nbsp;SHT_COMDAT_GROUP&nbsp;section&nbsp;is&nbsp;a&nbsp;flag&nbsp;word<br>
followed&nbsp;by&nbsp;a&nbsp;sequence&nbsp;of&nbsp;section&nbsp;indices.<br>
The&nbsp;flag&nbsp;word&nbsp;may&nbsp;contain&nbsp;the&nbsp;following&nbsp;flags:<br>
<br>
&lt;ul&gt;<br>
&lt;To&nbsp;be&nbsp;defined&gt;<br>
&lt;/ul&gt;<br>
<br>
&lt;p&gt;<br>
The&nbsp;section&nbsp;indices&nbsp;in&nbsp;the&nbsp;SHT_COMDAT_GROUP&nbsp;section&nbsp;identify<br>
the&nbsp;sections&nbsp;which&nbsp;make&nbsp;up&nbsp;the&nbsp;group.<br>
Either&nbsp;none&nbsp;of&nbsp;them&nbsp;or&nbsp;all&nbsp;of&nbsp;them&nbsp;will&nbsp;be&nbsp;removed&nbsp;by&nbsp;the&nbsp;linker.<br>
<br>
&lt;p&gt;<br>
The&nbsp;&lt;code&gt;sh_size&lt;/code&gt;&nbsp;value&nbsp;is&nbsp;&lt;code&gt;sh_entsize&lt;/code&gt;&nbsp;times<br>
one&nbsp;plus&nbsp;the&nbsp;number&nbsp;of&nbsp;sections&nbsp;in&nbsp;the&nbsp;group.<br>
<br>
&lt;p&gt;<br>
&lt;h4&gt;&nbsp;Requirements&nbsp;&lt;/h4&gt;<br>
<br>
&lt;ul&gt;<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
References&nbsp;to&nbsp;the&nbsp;sections&nbsp;comprising&nbsp;a&nbsp;COMDAT&nbsp;group,<br>
from&nbsp;sections&nbsp;outside&nbsp;the&nbsp;group,<br>
must&nbsp;be&nbsp;made&nbsp;via&nbsp;global&nbsp;symbols.<br>
They&nbsp;may&nbsp;not&nbsp;reference&nbsp;local&nbsp;symbols&nbsp;for&nbsp;addresses&nbsp;in&nbsp;the&nbsp;group's<br>
sections,&nbsp;including&nbsp;section&nbsp;symbols.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
There&nbsp;may&nbsp;not&nbsp;be&nbsp;non-symbol&nbsp;references&nbsp;to&nbsp;the&nbsp;sections&nbsp;comprising&nbsp;a<br>
COMDAT&nbsp;group&nbsp;from&nbsp;sections&nbsp;outside&nbsp;the&nbsp;group,&nbsp;e.g.&nbsp;in&nbsp;sh_link&nbsp;fields.<br>
For&nbsp;example,&nbsp;relocations&nbsp;of&nbsp;one&nbsp;of&nbsp;the&nbsp;group's&nbsp;sections&nbsp;must&nbsp;be&nbsp;in&nbsp;a<br>
relocation&nbsp;section&nbsp;which&nbsp;is&nbsp;also&nbsp;part&nbsp;of&nbsp;the&nbsp;group.<br>
<br>
&lt;p&gt;<br>
The&nbsp;above&nbsp;rules&nbsp;allow&nbsp;a&nbsp;COMDAT&nbsp;group&nbsp;to&nbsp;be&nbsp;removed&nbsp;without&nbsp;leaving<br>
dangling&nbsp;references,&nbsp;with&nbsp;only&nbsp;minimal&nbsp;processing&nbsp;of&nbsp;the&nbsp;symbol&nbsp;table.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
An&nbsp;entry&nbsp;in&nbsp;a&nbsp;symbol&nbsp;table&nbsp;section&nbsp;not&nbsp;in&nbsp;the&nbsp;COMDAT&nbsp;group,<br>
defined&nbsp;as&nbsp;an&nbsp;address&nbsp;in&nbsp;one&nbsp;of&nbsp;the&nbsp;group's&nbsp;sections,<br>
should&nbsp;be&nbsp;handled&nbsp;as&nbsp;follows:<br>
&lt;ul&gt;<br>
&lt;li&gt;&nbsp;If&nbsp;global&nbsp;but&nbsp;not&nbsp;referenced,&nbsp;remove&nbsp;it.<br>
&lt;li&gt;&nbsp;If&nbsp;global&nbsp;and&nbsp;referenced,&nbsp;change&nbsp;it&nbsp;to&nbsp;UNDEF.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(This&nbsp;may&nbsp;cause&nbsp;a&nbsp;link&nbsp;error&nbsp;if&nbsp;the&nbsp;retained&nbsp;version&nbsp;of&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COMDAT&nbsp;group&nbsp;does&nbsp;not&nbsp;define&nbsp;the&nbsp;same&nbsp;symbol.)<br>
&lt;li&gt;&nbsp;If&nbsp;local,&nbsp;remove&nbsp;it.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(This&nbsp;will&nbsp;cause&nbsp;a&nbsp;link&nbsp;error&nbsp;if&nbsp;the&nbsp;symbol&nbsp;is&nbsp;referenced.)<br>
&lt;/ul&gt;<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
The&nbsp;SHT_COMDAT_GROUP&nbsp;section&nbsp;must&nbsp;precede&nbsp;the&nbsp;sections&nbsp;in&nbsp;the&nbsp;group<br>
(in&nbsp;the&nbsp;section&nbsp;table).<br>
<br>
&lt;/ul&gt;<br>
<br>
&lt;p&gt;<br>
&lt;h4&gt;&nbsp;Questions&nbsp;&lt;/h4&gt;<br>
<br>
&lt;ul&gt;<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
Do&nbsp;we&nbsp;want&nbsp;flags&nbsp;to&nbsp;specify&nbsp;checking&nbsp;prior&nbsp;to&nbsp;removal&nbsp;of&nbsp;duplicates,<br>
e.g.&nbsp;for&nbsp;identical&nbsp;sections,&nbsp;same&nbsp;defined&nbsp;global&nbsp;symbols,&nbsp;etc.?<br>
If&nbsp;so,&nbsp;should&nbsp;there&nbsp;be&nbsp;one&nbsp;flags&nbsp;word&nbsp;per&nbsp;section&nbsp;index,<br>
instead&nbsp;of&nbsp;per&nbsp;group?<br>
(We&nbsp;don't&nbsp;see&nbsp;a&nbsp;need,&nbsp;but&nbsp;this&nbsp;was&nbsp;suggested&nbsp;in&nbsp;other&nbsp;proposals.)<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
Do&nbsp;we&nbsp;want&nbsp;more&nbsp;control&nbsp;over&nbsp;when&nbsp;global&nbsp;symbols&nbsp;are&nbsp;removed&nbsp;vs.&nbsp;being<br>
converted&nbsp;to&nbsp;UNDEF?<br>
Alternatively,&nbsp;should&nbsp;we&nbsp;simply&nbsp;require&nbsp;that&nbsp;all&nbsp;symbols&nbsp;defined&nbsp;as<br>
addresses&nbsp;in&nbsp;the&nbsp;group&nbsp;be&nbsp;removed,<br>
and&nbsp;that&nbsp;references&nbsp;to&nbsp;them&nbsp;from&nbsp;outside&nbsp;do&nbsp;so&nbsp;via&nbsp;distinct&nbsp;UNDEF<br>
global&nbsp;symbols?<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
Do&nbsp;we&nbsp;want&nbsp;to&nbsp;replace&nbsp;the&nbsp;symbol&nbsp;rule&nbsp;by&nbsp;simply&nbsp;requiring&nbsp;that&nbsp;any<br>
symbols&nbsp;defined&nbsp;as&nbsp;addresses&nbsp;in&nbsp;the&nbsp;group&nbsp;be&nbsp;defined&nbsp;in&nbsp;a&nbsp;.symtab<br>
section&nbsp;that&nbsp;is&nbsp;itself&nbsp;in&nbsp;the&nbsp;group?<br>
<br>
&lt;/ul&gt;<br>
<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
