<tt>
&lt;html&gt;&lt;body&gt;<br>
&lt;p&gt;&lt;tt&gt;Lawrence&nbsp;Crowl&nbsp;&lt;crowl@google.com&gt;&nbsp;wrote&nbsp;on&nbsp;02/22/2010&nbsp;04:50:46&nbsp;PM:&lt;br&gt;<br>
&gt;&nbsp;On&nbsp;2/22/10,&nbsp;Mark&nbsp;Mitchell&nbsp;&lt;mark@codesourcery.com&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;Alasdair&nbsp;Grant&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;Implementations&nbsp;(at&nbsp;least&nbsp;of&nbsp;the&nbsp;ARM&nbsp;variant&nbsp;of&nbsp;the&nbsp;ABI)&nbsp;seem&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;to&nbsp;differ&nbsp;about&nbsp;whether&nbsp;the&nbsp;code&nbsp;above&nbsp;should&nbsp;define&nbsp;the&nbsp;vtable&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;for&nbsp;G_key_nodef&lt;int&gt;.&nbsp;&nbsp;GCC&nbsp;4.4&nbsp;for&nbsp;ARM&nbsp;does&nbsp;define&nbsp;the&nbsp;vtable&nbsp;-&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;which&nbsp;suggests&nbsp;it&nbsp;is&nbsp;not&nbsp;treating&nbsp;G_key_nodef&lt;int&gt;::f()&nbsp;as&nbsp;a&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;key&nbsp;function&nbsp;(if&nbsp;it&nbsp;did,&nbsp;it&nbsp;could&nbsp;rely&nbsp;on&nbsp;some&nbsp;other&nbsp;unit&nbsp;to&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;be&nbsp;defining&nbsp;f(),&nbsp;and&nbsp;hence&nbsp;the&nbsp;vtable).&lt;br&gt;<br>
&gt;&nbsp;&gt;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;Given&nbsp;that&nbsp;there&nbsp;is&nbsp;vague&nbsp;linkage&nbsp;involved,&nbsp;how&nbsp;does&nbsp;this&nbsp;matter?&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;It&nbsp;sounds&nbsp;to&nbsp;me&nbsp;like&nbsp;GCC&nbsp;is&nbsp;being&nbsp;wasteful,&nbsp;in&nbsp;that&nbsp;it's&nbsp;defining&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;a&nbsp;vtable&nbsp;not&nbsp;needed&nbsp;in&nbsp;this&nbsp;object&nbsp;file,&nbsp;and&nbsp;guaranteed&nbsp;to&nbsp;be&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;present&nbsp;anyhow,&nbsp;but&nbsp;as&nbsp;vague&nbsp;linkage&nbsp;will&nbsp;collapse&nbsp;the&nbsp;definitions,&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;it&nbsp;sounds&nbsp;like&nbsp;this&nbsp;is&nbsp;&quot;just&quot;&nbsp;a&nbsp;waste&nbsp;of&nbsp;space&nbsp;in&nbsp;object&nbsp;files,&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;not&nbsp;in&nbsp;final&nbsp;executables.&lt;br&gt;<br>
&gt;&nbsp;&gt;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;Even&nbsp;if&nbsp;--&nbsp;as&nbsp;on&nbsp;Symbian,&nbsp;where&nbsp;I&nbsp;suspect&nbsp;this&nbsp;question&nbsp;arises&nbsp;:-)&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;--&nbsp;the&nbsp;waste&nbsp;makes&nbsp;it&nbsp;into&nbsp;a&nbsp;DSO,&nbsp;how&nbsp;is&nbsp;that&nbsp;an&nbsp;ABI&nbsp;conformance&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;problem?&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;How&nbsp;about&nbsp;the&nbsp;following&nbsp;scenario?&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;A&nbsp;translation&nbsp;unit&nbsp;declares&nbsp;an&nbsp;&quot;extern&nbsp;template&quot;&nbsp;specialization&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;of&nbsp;G_key_defined&lt;int&gt;::f().&nbsp;&nbsp;The&nbsp;compiler&nbsp;infers&nbsp;that&nbsp;the&nbsp;virtual&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;table&nbsp;need&nbsp;not&nbsp;be&nbsp;generated&nbsp;even&nbsp;though&nbsp;the&nbsp;translation&nbsp;unit&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;otherwise&nbsp;instantiates&nbsp;G_key_defined&lt;int&gt;.&nbsp;&nbsp;The&nbsp;specialization&nbsp;of&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;f()&nbsp;is&nbsp;not&nbsp;subsequently&nbsp;used,&nbsp;and&nbsp;so&nbsp;the&nbsp;vtable&nbsp;will&nbsp;fail&nbsp;to&nbsp;exist.&lt;br&gt;<br>
&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;I&nbsp;have&nbsp;a&nbsp;related&nbsp;issue&nbsp;for&nbsp;which&nbsp;I&nbsp;would&nbsp;like&nbsp;to&nbsp;get&nbsp;clarification.&nbsp;&nbsp;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;There&nbsp;seems&nbsp;to&nbsp;be&nbsp;a&nbsp;contradiction&nbsp;between&nbsp;ABI&nbsp;and&nbsp;C++&nbsp;Standard.&nbsp;&nbsp;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;Given&nbsp;the&nbsp;following.&lt;/tt&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;tt&gt;/*&nbsp;t1.h&nbsp;*/&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;class&nbsp;A&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;{&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&nbsp;virtual&nbsp;int&nbsp;foo()&nbsp;=&nbsp;0;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&nbsp;};&lt;/tt&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;tt&gt;&nbsp;struct&nbsp;B&nbsp;:&nbsp;public&nbsp;A&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&nbsp;{&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&nbsp;int&nbsp;foo();&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&nbsp;};&lt;/tt&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;tt&gt;/*&nbsp;t1.cpp&nbsp;*/&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;#include&nbsp;&quot;t1.h&quot;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;inline&nbsp;int&nbsp;B::foo()&nbsp;{&nbsp;return&nbsp;55;&nbsp;}&lt;/tt&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;tt&gt;/*&nbsp;t2.cpp&nbsp;*/&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;#include&nbsp;&quot;t1.h&quot;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;int&nbsp;main()&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;{&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&nbsp;B&nbsp;b;&nbsp;//&nbsp;this&nbsp;line&nbsp;forces&nbsp;to&nbsp;generate&nbsp;vft&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&nbsp;&nbsp;return&nbsp;b.foo();&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;}&lt;/tt&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;tt&gt;The&nbsp;g++&nbsp;compiler&nbsp;will&nbsp;compile&nbsp;and&nbsp;link&nbsp;fine&nbsp;since&nbsp;B::foo()&nbsp;will&nbsp;be&nbsp;generated&nbsp;as&nbsp;part&nbsp;of&nbsp;t1.o.&nbsp;&nbsp;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;XL&nbsp;(IBM)&nbsp;compiler&nbsp;comes&nbsp;back&nbsp;with&nbsp;&quot;Undefined&nbsp;symbol:&nbsp;.B::foo()&quot;.&nbsp;&nbsp;This&nbsp;is&nbsp;because&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;t1.o&nbsp;does&nbsp;not&nbsp;have&nbsp;its&nbsp;definition.&nbsp;&nbsp;It&nbsp;was&nbsp;optimized&nbsp;out&nbsp;since&nbsp;XL&nbsp;didn't&nbsp;find&nbsp;any&nbsp;reference&nbsp;to&nbsp;it&nbsp;in&nbsp;t1.cpp.&lt;/tt&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;tt&gt;According&nbsp;to&nbsp;C++&nbsp;Standard&nbsp;the&nbsp;above&nbsp;TC&nbsp;is&nbsp;invalid&nbsp;because&nbsp;it&nbsp;violates&nbsp;the&nbsp;last&nbsp;sentence&nbsp;from&nbsp;3.2.3:&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&quot;An&nbsp;inline&nbsp;function&nbsp;shall&nbsp;be&nbsp;defined&nbsp;in&nbsp;every&nbsp;translation&nbsp;unit&nbsp;in&nbsp;which&nbsp;it&nbsp;is&nbsp;used.&quot;&lt;/tt&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;tt&gt;However&nbsp;C++ABI&nbsp;by&nbsp;last&nbsp;sentence&nbsp;in&nbsp;sec.&nbsp;5.2.3&nbsp;(Virtual&nbsp;Tables)&nbsp;makes&nbsp;this&nbsp;TC&nbsp;valid.&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&quot;Note&nbsp;that&nbsp;if&nbsp;the&nbsp;key&nbsp;function&nbsp;is&nbsp;not&nbsp;declared&nbsp;inline&nbsp;in&nbsp;the&nbsp;class&nbsp;definition,&nbsp;but&nbsp;its&nbsp;definition&nbsp;later&nbsp;is&nbsp;always&nbsp;declared&nbsp;inline,&nbsp;it&nbsp;will&nbsp;be&nbsp;emitted&nbsp;in&nbsp;every&nbsp;object&nbsp;containing&nbsp;the&nbsp;definition.&quot;&lt;/tt&gt;&lt;br&gt;<br>
&lt;/body&gt;&lt;/html&gt;
</tt>
