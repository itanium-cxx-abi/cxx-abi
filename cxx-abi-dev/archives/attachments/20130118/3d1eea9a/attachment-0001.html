<tt>
&lt;html&gt;&lt;body&gt;<br>
&lt;p&gt;&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;John&nbsp;McCall&nbsp;&lt;rjmccall@apple.com&gt;&nbsp;wrote&nbsp;on&nbsp;01/18/2013&nbsp;02:52:52&nbsp;AM:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;From:&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;John&nbsp;McCall&nbsp;&lt;rjmccall@apple.com&gt;&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;To:&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Richard&nbsp;Smith&nbsp;&lt;richardsmith@google.com&gt;&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Cc:&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Michael&nbsp;Wong/Toronto/IBM@IBMCA,&nbsp;&quot;cxx-abi-dev@codesourcery.com&quot;&nbsp;&lt;cxx-&lt;br&gt;<br>
&gt;&nbsp;abi-dev@codesourcery.com&gt;,&nbsp;Lawrence&nbsp;Crowl&nbsp;&lt;crowl@googlers.com&gt;&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Date:&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;01/18/2013&nbsp;02:52&nbsp;AM&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Subject:&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Re:&nbsp;[cxx-abi-dev]&nbsp;lambda&nbsp;ABI&nbsp;inline&nbsp;function&nbsp;ODR&nbsp;compatibility&nbsp;issue&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;On&nbsp;Jan&nbsp;17,&nbsp;2013,&nbsp;at&nbsp;6:38&nbsp;PM,&nbsp;Richard&nbsp;Smith&nbsp;&lt;richardsmith@google.com&gt;&nbsp;wrote:&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;On&nbsp;Thu,&nbsp;Jan&nbsp;17,&nbsp;2013&nbsp;at&nbsp;6:01&nbsp;PM,&nbsp;John&nbsp;McCall&nbsp;&lt;rjmccall@apple.com&gt;&nbsp;wrote:&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;On&nbsp;Jan&nbsp;17,&nbsp;2013,&nbsp;at&nbsp;4:12&nbsp;PM,&nbsp;Richard&nbsp;Smith&nbsp;&lt;richardsmith@google.com&gt;&nbsp;wrote:&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;On&nbsp;Thu,&nbsp;Jan&nbsp;17,&nbsp;2013&nbsp;at&nbsp;2:35&nbsp;PM,&nbsp;Michael&nbsp;Wong&nbsp;&lt;michaelw@ca.ibm.com&gt;&nbsp;wrote:&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;Lawrence&nbsp;Crowl&nbsp;&lt;crowl@googlers.com&gt;&nbsp;wrote&nbsp;on&nbsp;01/17/2013&nbsp;04:50:52&nbsp;PM:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;From:&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;Lawrence&nbsp;Crowl&nbsp;&lt;crowl@googlers.com&gt;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;To:&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;Michael&nbsp;Wong/Toronto/IBM@IBMCA&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;Cc:&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;cxx-abi-dev@codesourcery.com&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;Date:&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;01/17/2013&nbsp;04:50&nbsp;PM&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;Subject:&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;Re:&nbsp;[cxx-abi-dev]&nbsp;lambda&nbsp;ABI&nbsp;inline&nbsp;function&nbsp;ODR&nbsp;compatibility&nbsp;issue&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;On&nbsp;1/16/13,&nbsp;Michael&nbsp;Wong&nbsp;&lt;michaelw@ca.ibm.com&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;Does&nbsp;the&nbsp;C++&nbsp;Standard&nbsp;committee&nbsp;intend&nbsp;for&nbsp;the&nbsp;ODR&nbsp;to&nbsp;imply&nbsp;that&nbsp;lambdas&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;need&nbsp;to&nbsp;have&nbsp;an&nbsp;ABI&nbsp;specified&nbsp;layout&nbsp;in&nbsp;order&nbsp;to&nbsp;deal&nbsp;with&nbsp;inline&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;functions.&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&gt;&nbsp;I&nbsp;believe&nbsp;that&nbsp;we&nbsp;thought&nbsp;it&nbsp;was&nbsp;not&nbsp;an&nbsp;issue.&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;Consider&nbsp;the&nbsp;following&nbsp;with&nbsp;one&nbsp;object&nbsp;compiled&nbsp;with&nbsp;-DMAIN&nbsp;and&nbsp;another&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;without:&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;-&nbsp;in&nbsp;one&nbsp;case&nbsp;the&nbsp;layout&nbsp;needs&nbsp;to&nbsp;be&nbsp;compatible&nbsp;between&nbsp;different&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;implementations&nbsp;since&nbsp;the&nbsp;static&nbsp;local&nbsp;is&nbsp;shared&nbsp;between&nbsp;translation&nbsp;units&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;/data/a.o:&nbsp;In&nbsp;function&nbsp;`main':&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;a.cpp:(.text+0x18):&nbsp;undefined&nbsp;reference&nbsp;to&nbsp;`bar()'&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;collect2:&nbsp;error:&nbsp;ld&nbsp;returned&nbsp;1&nbsp;exit&nbsp;status&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;-&nbsp;in&nbsp;the&nbsp;other&nbsp;case,&nbsp;the&nbsp;layout&nbsp;needs&nbsp;to&nbsp;be&nbsp;compatible&nbsp;between&nbsp;different&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;implementations&nbsp;in&nbsp;order&nbsp;to&nbsp;satisfy&nbsp;the&nbsp;ODR&nbsp;requirement&nbsp;that&nbsp;the&nbsp;program&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;behave&nbsp;as&nbsp;if&nbsp;there&nbsp;was&nbsp;only&nbsp;one&nbsp;definition&nbsp;of&nbsp;the&nbsp;inline&nbsp;function&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;extern&nbsp;&quot;C&quot;&nbsp;int&nbsp;printf(const&nbsp;char&nbsp;*,&nbsp;...);&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;extern&nbsp;long&nbsp;gz;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;inline&nbsp;void&nbsp;foo()&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;long&nbsp;x&nbsp;=&nbsp;0,&nbsp;q&nbsp;=&nbsp;0,&nbsp;&amp;z&nbsp;=&nbsp;gz;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;auto&nbsp;f&nbsp;=&nbsp;[=,&nbsp;&amp;z]()&nbsp;mutable&nbsp;{&nbsp;q&nbsp;+=&nbsp;++x;&nbsp;gz&nbsp;=&nbsp;q&nbsp;+&nbsp;x;&nbsp;};&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;long&nbsp;a,&nbsp;b;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;auto&nbsp;ff&nbsp;=&nbsp;[=]{&nbsp;sizeof(a&nbsp;/*not&nbsp;an&nbsp;odr-use*/),&nbsp;printf(&quot;%u\n&quot;,&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&amp;b&nbsp;&lt;&nbsp;&amp;a);&nbsp;};&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;f();&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;ff();&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;void&nbsp;bar();&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;#if&nbsp;!&nbsp;MAIN&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;void&nbsp;bar()&nbsp;{&nbsp;foo();&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;#else&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;long&nbsp;gz;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;int&nbsp;main()&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;foo();&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;bar();&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;foo();&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;gz;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&gt;&nbsp;#endif&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&gt;&nbsp;And&nbsp;this&nbsp;code&nbsp;demonstrates&nbsp;that&nbsp;it&nbsp;is&nbsp;an&nbsp;issue.&lt;br&gt;<br>
&gt;&nbsp;Agreed.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;Do&nbsp;you&nbsp;have&nbsp;a&nbsp;proposal?&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Probably&nbsp;2&nbsp;thoughts:&lt;br&gt;<br>
&gt;&nbsp;1.&nbsp;Make&nbsp;a&nbsp;static&nbsp;in&nbsp;an&nbsp;inline&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;ODR&nbsp;rule&nbsp;in&nbsp;the&nbsp;C++&lt;br&gt;<br>
&gt;&nbsp;Std&nbsp;(add&nbsp;in&nbsp;suitable&nbsp;wording&nbsp;covering&nbsp;all&nbsp;uses&nbsp;with&nbsp;external&nbsp;linkage)or&nbsp;&lt;br&gt;<br>
&gt;&nbsp;2.&nbsp;create&nbsp;an&nbsp;ABI&nbsp;binding&nbsp;in&nbsp;the&nbsp;C++&nbsp;ABI&nbsp;such&nbsp;that&nbsp;all&nbsp;vendors&nbsp;follow&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;same&nbsp;behavior&nbsp;in&nbsp;this&nbsp;case&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;think&nbsp;I&nbsp;am&nbsp;OK&nbsp;with&nbsp;either&nbsp;solution.&lt;br&gt;<br>
&gt;&nbsp;There&nbsp;may&nbsp;be&nbsp;other&nbsp;solutions&nbsp;I&nbsp;have&nbsp;not&nbsp;entertained&nbsp;yet&nbsp;...&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;For&nbsp;option&nbsp;1,&nbsp;we&nbsp;would&nbsp;only&nbsp;need&nbsp;to&nbsp;disallow&nbsp;static&nbsp;local&nbsp;variables&nbsp;&lt;br&gt;<br>
&gt;&nbsp;from&nbsp;having&nbsp;types&nbsp;involving&nbsp;local&nbsp;lambdas&nbsp;with&nbsp;captures,&nbsp;right?&nbsp;All&nbsp;&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;other&nbsp;problems&nbsp;I&nbsp;can&nbsp;think&nbsp;of&nbsp;would&nbsp;be&nbsp;handled&nbsp;by&nbsp;putting&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&nbsp;lambda's&nbsp;symbols&nbsp;in&nbsp;a&nbsp;COMDAT&nbsp;with&nbsp;the&nbsp;containing&nbsp;function.&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;We&nbsp;could&nbsp;also&nbsp;have&nbsp;problems&nbsp;with&nbsp;template&nbsp;specializations&nbsp;involving&nbsp;&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;lambda&nbsp;type,&nbsp;no?&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;template&nbsp;&lt;class&nbsp;T&gt;&nbsp;InstanceCount&nbsp;{&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&nbsp;&nbsp;static&nbsp;int&nbsp;count;&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;};&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;template&nbsp;&lt;class&nbsp;T&gt;&nbsp;int&nbsp;InstanceCount&lt;T&gt;::count&nbsp;=&nbsp;0;&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;inline&nbsp;void&nbsp;foo(int&nbsp;x)&nbsp;{&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&nbsp;&nbsp;auto&nbsp;lambda&nbsp;=&nbsp;[=]&nbsp;{&nbsp;return&nbsp;x;&nbsp;};&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&nbsp;&nbsp;InstanceCount&lt;decltype(lambda)&gt;::count++;&nbsp;//&nbsp;is&nbsp;this&nbsp;count&nbsp;&lt;br&gt;<br>
&gt;&nbsp;consistent&nbsp;across&nbsp;translation&nbsp;units?&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;}&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;That's&nbsp;OK;&nbsp;it&nbsp;just&nbsp;needs&nbsp;the&nbsp;mangling&nbsp;of&nbsp;the&nbsp;lambda's&nbsp;type.&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;Banning&nbsp;ODR&nbsp;wil&nbsp;lalso&nbsp;fix&nbsp;this&nbsp;case,&nbsp;I&nbsp;think,&nbsp;not&nbsp;that&nbsp;I&nbsp;am&nbsp;saying&nbsp;we&nbsp;should&nbsp;do&nbsp;that.&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;This&nbsp;case&nbsp;seems&nbsp;more&nbsp;problematic:&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;void&nbsp;*p;&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;inline&nbsp;void&nbsp;f(int&nbsp;a,&nbsp;int&nbsp;b)&nbsp;{&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&nbsp;&nbsp;auto&nbsp;lambda&nbsp;=&nbsp;[=]&nbsp;{&nbsp;return&nbsp;a&nbsp;+&nbsp;b;&nbsp;};&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&nbsp;&nbsp;if&nbsp;(p)&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(*reinterpret_cast&lt;decltype(lambda)*&gt;(p))();&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&nbsp;&nbsp;else&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p&nbsp;=&nbsp;new&nbsp;auto(lambda);&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;}&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;Banning&nbsp;ODR&nbsp;fixes&nbsp;this&nbsp;one&nbsp;too.&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&lt;br&gt;<br>
&gt;&nbsp;Right,&nbsp;sorry,&nbsp;I&nbsp;assumed&nbsp;it&nbsp;would&nbsp;be&nbsp;taken&nbsp;as&nbsp;given&nbsp;that&nbsp;a&nbsp;template&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;specialization&nbsp;could&nbsp;do&nbsp;something&nbsp;that&nbsp;actually&nbsp;relied&nbsp;on&nbsp;the&nbsp;layout&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;of&nbsp;the&nbsp;lambda&nbsp;type.&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Basically,&nbsp;different&nbsp;translation&nbsp;units&nbsp;either&nbsp;agree&nbsp;that&nbsp;the&nbsp;lambda&nbsp;type&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;is&nbsp;the&nbsp;same&nbsp;or&nbsp;they&nbsp;don't.&nbsp;&nbsp;If&nbsp;they&nbsp;don't,&nbsp;my&nbsp;example&nbsp;breaks.&nbsp;&nbsp;If&nbsp;they&nbsp;do,&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;then&nbsp;(almost)&nbsp;any&nbsp;template&nbsp;specialization&nbsp;used&nbsp;which&nbsp;involves&nbsp;that&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;type&nbsp;or&nbsp;properties&nbsp;thereof&nbsp;(char_buffer&lt;sizeof(lambda)&gt;!&nbsp;&nbsp;Enjoy&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;reasoning&nbsp;about&nbsp;that!)&nbsp;becomes&nbsp;an&nbsp;ODR&nbsp;violation&nbsp;if&nbsp;the&nbsp;translation&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;units&nbsp;disagree.&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Normally,&nbsp;in&nbsp;a&nbsp;situation&nbsp;like&nbsp;this,&nbsp;I&nbsp;would&nbsp;say&nbsp;that&nbsp;the&nbsp;right&nbsp;thing&nbsp;to&nbsp;do&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;is&nbsp;to&nbsp;make&nbsp;strong&nbsp;guarantees&nbsp;but&nbsp;liberally&nbsp;exploit&nbsp;as-if.&nbsp;&nbsp;Unfortunately,&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;as-if&nbsp;reasoning&nbsp;about&nbsp;lambda&nbsp;types&nbsp;is&nbsp;probably&nbsp;infeasible&nbsp;for&nbsp;nearly&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;every&nbsp;interesting&nbsp;use&nbsp;case.&nbsp;&nbsp;By&nbsp;design,&nbsp;the&nbsp;feature&nbsp;just&nbsp;bleeds&nbsp;the&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;lambda&nbsp;type&nbsp;onto&nbsp;everything;&nbsp;&nbsp;it&nbsp;escapes&nbsp;in&nbsp;ways&nbsp;that&nbsp;would&nbsp;be&nbsp;challenging&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;to&nbsp;limit.&nbsp;&nbsp;Those&nbsp;few&nbsp;library&nbsp;features&nbsp;(like&nbsp;std::function)&nbsp;that&nbsp;do&nbsp;erase&nbsp;the&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;lambda&nbsp;type&nbsp;necessarily&nbsp;use&nbsp;things&nbsp;like&nbsp;polymorphic&nbsp;classes&nbsp;that&nbsp;are&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;quite&nbsp;challenging&nbsp;to&nbsp;reason&nbsp;about.&nbsp;&nbsp;We'd&nbsp;likely&nbsp;end&nbsp;up&nbsp;just&nbsp;white-listing&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;those&nbsp;templates,&nbsp;maybe&nbsp;with&nbsp;an&nbsp;attribute.&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;see&nbsp;three&nbsp;options:&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;1.&nbsp;&nbsp;Guarantee&nbsp;the&nbsp;layout&nbsp;of&nbsp;lambdas&nbsp;in&nbsp;functions&nbsp;with&nbsp;weak&nbsp;linkage.&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;We'd&nbsp;still&nbsp;be&nbsp;able&nbsp;to&nbsp;optimize&nbsp;all&nbsp;other&nbsp;lambdas,&nbsp;so&nbsp;this&nbsp;isn't&nbsp;really&nbsp;that&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;bad;&nbsp;&nbsp;it's&nbsp;just&nbsp;a&nbsp;bit&nbsp;disappointing&nbsp;for&nbsp;us&nbsp;compiler&nbsp;hackers&nbsp;and&nbsp;(a&nbsp;subset&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;of)&nbsp;our&nbsp;users.&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;2.&nbsp;&nbsp;Ban&nbsp;lambdas&nbsp;in&nbsp;functions&nbsp;with&nbsp;weak&nbsp;linkage,&nbsp;similar&nbsp;to&nbsp;how&nbsp;C&nbsp;bans&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;static&nbsp;variables&nbsp;in&nbsp;(C's&nbsp;definition&nbsp;of)&nbsp;inline&nbsp;functions.&nbsp;&nbsp;Of&nbsp;course,&nbsp;&quot;weak&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;linkage&quot;&nbsp;is&nbsp;not&nbsp;a&nbsp;concept&nbsp;in&nbsp;the&nbsp;standard,&nbsp;and&nbsp;you'd&nbsp;have&nbsp;to&nbsp;formalize&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;that&nbsp;quite&nbsp;carefully&nbsp;to&nbsp;avoid&nbsp;sweeping&nbsp;up&nbsp;a&nbsp;ton&nbsp;of&nbsp;interesting&nbsp;cases&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;involving&nbsp;anonymous&nbsp;namespaces.&nbsp;&nbsp;And,&nbsp;of&nbsp;course,&nbsp;this&nbsp;would&nbsp;mean&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;banning&nbsp;a&nbsp;bunch&nbsp;of&nbsp;code&nbsp;that&nbsp;doesn't&nbsp;actually&nbsp;run&nbsp;afoul&nbsp;of&nbsp;this.&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;3.&nbsp;&nbsp;Give&nbsp;lambdas&nbsp;internal&nbsp;linkage&nbsp;by&nbsp;fiat&nbsp;and&nbsp;hack&nbsp;the&nbsp;ODR&nbsp;to&nbsp;make&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;that&nbsp;work&nbsp;out.&nbsp;&nbsp;I&nbsp;imagine&nbsp;this&nbsp;rule&nbsp;would&nbsp;come&nbsp;across&nbsp;like&nbsp;&quot;lambdas&nbsp;in&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;inline&nbsp;functions&nbsp;will&nbsp;behave&nbsp;like&nbsp;they&nbsp;have&nbsp;different&nbsp;types&nbsp;in&nbsp;different&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;translation&nbsp;units,&nbsp;and&nbsp;that's&nbsp;not&nbsp;a&nbsp;formal&nbsp;ODR&nbsp;violation,&nbsp;but&nbsp;if&nbsp;it&nbsp;affects&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;the&nbsp;semantics&nbsp;of&nbsp;your&nbsp;program,&nbsp;tough&nbsp;cookies.&quot;&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;#3&nbsp;matches&nbsp;our&nbsp;suggestion&nbsp;for&nbsp;the&nbsp;fix&nbsp;exactly.&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;tend&nbsp;to&nbsp;favor&nbsp;#3,&nbsp;but&nbsp;I'll&nbsp;admit&nbsp;to&nbsp;not&nbsp;having&nbsp;really&nbsp;considered&nbsp;the&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;consequences.&lt;/font&gt;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;John.&lt;/font&gt;&lt;/tt&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
