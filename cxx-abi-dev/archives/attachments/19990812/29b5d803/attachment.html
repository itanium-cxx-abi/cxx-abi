<tt>
&lt;!DOCTYPE&nbsp;HTML&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;3.2//EN&quot;&gt;<br>
&lt;HTML&gt;<br>
&lt;HEAD&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;TITLE&gt;RTTI&nbsp;Implementation&nbsp;In&nbsp;ABI2&lt;/TITLE&gt;<br>
&lt;/HEAD&gt;<br>
&lt;BODY&gt;<br>
&lt;H1&nbsp;ALIGN=CENTER&gt;RTTI&nbsp;Implementation&nbsp;in&nbsp;ABI2&lt;/H1&gt;<br>
<br>
&lt;p&gt;The&nbsp;typeinfo&nbsp;object&nbsp;is&nbsp;implemented&nbsp;as:<br>
&lt;PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;type_info&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;public&nbsp;interface&nbsp;ignored<br>
&nbsp;&nbsp;&nbsp;&nbsp;private:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_type_info*&nbsp;static_data;<br>
&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/PRE<br>
<br>
&lt;P&gt;The&nbsp;static_type_info&nbsp;objects&nbsp;are&nbsp;shared&nbsp;with&nbsp;the&nbsp;exception&nbsp;implementation.<br>
The&nbsp;static&nbsp;data&nbsp;has&nbsp;the&nbsp;following&nbsp;format.&nbsp;&nbsp;In&nbsp;this&nbsp;description&nbsp;we<br>
make&nbsp;heavy&nbsp;use&nbsp;of&nbsp;self-relative&nbsp;pointers&nbsp;for&nbsp;position&nbsp;independence.<br>
We&nbsp;denote&nbsp;self-relative&nbsp;pointers&nbsp;by&nbsp;&quot;$&quot;&nbsp;instead&nbsp;of&nbsp;&quot;*&quot;.&nbsp;&nbsp;They&nbsp;are<br>
represented&nbsp;in&nbsp;the&nbsp;structures&nbsp;as&nbsp;lvalues&nbsp;of&nbsp;type&nbsp;ptr_diff_t.<br>
For&nbsp;example,&nbsp;we&nbsp;might&nbsp;have&nbsp;a&nbsp;field:<br>
&lt;PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;base_block$&nbsp;bases;&nbsp;&nbsp;//&nbsp;base&nbsp;information.<br>
&lt;/PRE&gt;<br>
&lt;P&gt;These&nbsp;are&nbsp;converted&nbsp;to&nbsp;real&nbsp;pointers&nbsp;using&nbsp;the&nbsp;following&nbsp;template.<br>
&lt;PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;template&nbsp;&lt;class&nbsp;T&gt;&nbsp;to_real_ptr(ptr_diff_t&amp;&nbsp;p)<br>
&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(T)((char*)p&nbsp;+&nbsp;*p);<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/PRE&gt;<br>
&lt;P&gt;Thus&nbsp;a&nbsp;self-relative&nbsp;pointer&nbsp;to&nbsp;a&nbsp;&quot;base_block&quot;&nbsp;is&nbsp;accessed&nbsp;by<br>
&lt;PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;*to_rel_ptr&lt;base_block*&gt;(ti-&gt;bases);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;static_type_info&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char$&nbsp;ty_name;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;print&nbsp;name&nbsp;for&nbsp;the&nbsp;type<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr_diff_t&nbsp;reserved;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Can&nbsp;be&nbsp;filled&nbsp;as&nbsp;described&nbsp;below<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class_base_descr$&nbsp;base_table;&nbsp;&nbsp;&nbsp;//&nbsp;base&nbsp;class&nbsp;information&nbsp;for&nbsp;cast<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32&nbsp;type_hash[4];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;unique&nbsp;identifier<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32&nbsp;flags;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;notes&nbsp;on&nbsp;the&nbsp;type<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32&nbsp;cv_qualifiers;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;const-vol&nbsp;qualifiers<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32&nbsp;pointer_count()&nbsp;const;&nbsp;&nbsp;&nbsp;//&nbsp;pointer&nbsp;level&nbsp;count;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32&nbsp;voidstar_flag()&nbsp;const;&nbsp;&nbsp;&nbsp;//&nbsp;non-zero&nbsp;if&nbsp;void*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32&nbsp;dotdotdot_flag()&nbsp;const;&nbsp;&nbsp;//&nbsp;non-zero&nbsp;if&nbsp;&quot;...&quot;&nbsp;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;};<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;class_base_descr&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32&nbsp;type_hash[4];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;unique&nbsp;identifier<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;offset;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;offset&nbsp;in&nbsp;most-derived<br>
&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/PRE&gt;<br>
&lt;DL&gt;<br>
&lt;DT&gt;ty_name:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;DD&gt;Pointer&nbsp;to&nbsp;a&nbsp;null-terminated&nbsp;name&nbsp;for&nbsp;the&nbsp;type.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;general&nbsp;this&nbsp;name&nbsp;should&nbsp;be&nbsp;a&nbsp;utf8&nbsp;value<br>
<br>
&lt;DT&gt;reserved:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;DD&gt;A&nbsp;tool&nbsp;for&nbsp;extending&nbsp;the&nbsp;typeinfo&nbsp;object&nbsp;in&nbsp;an<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orthogonal&nbsp;direction.&nbsp;For&nbsp;example,&nbsp;this&nbsp;could&nbsp;be&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self-relative&nbsp;pointer&nbsp;to&nbsp;a&nbsp;Java&nbsp;data&nbsp;block.&nbsp;&nbsp;For&nbsp;C++&nbsp;types,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;extension&nbsp;should&nbsp;probably&nbsp;be&nbsp;by&nbsp;derivation.<br>
<br>
&lt;DT&gt;base_table:&nbsp;&nbsp;&nbsp;&lt;DD&gt;For&nbsp;all&nbsp;classes&nbsp;this&nbsp;is&nbsp;a&nbsp;self-relative&nbsp;pointer&nbsp;to&nbsp;an&nbsp;array<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;class_base_descr&nbsp;entries.&nbsp;&nbsp;Each&nbsp;entry&nbsp;contains&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hash&nbsp;for&nbsp;that&nbsp;class&nbsp;and&nbsp;the&nbsp;offset&nbsp;of&nbsp;that&nbsp;class&nbsp;within<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;most&nbsp;derived&nbsp;class.&nbsp;&nbsp;The&nbsp;most&nbsp;significant&nbsp;two&nbsp;bits<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;the&nbsp;offset&nbsp;are&nbsp;used&nbsp;as&nbsp;flags.&nbsp;The&nbsp;msb&nbsp;is&nbsp;set&nbsp;to&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indicate&nbsp;the&nbsp;last&nbsp;entry&nbsp;in&nbsp;the&nbsp;array,&nbsp;and&nbsp;the&nbsp;next<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msb&nbsp;is&nbsp;set&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;path&nbsp;from&nbsp;most&nbsp;derived<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;the&nbsp;entry&nbsp;is&nbsp;private.&nbsp;&nbsp;The&nbsp;entries&nbsp;are&nbsp;in&nbsp;depth-first<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left-to-right&nbsp;order&nbsp;based&nbsp;on&nbsp;the&nbsp;inheritance&nbsp;dag,&nbsp;except<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;that&nbsp;each&nbsp;subobject&nbsp;is&nbsp;represented&nbsp;exactly&nbsp;once.&nbsp;&nbsp;The&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;most&nbsp;derived&nbsp;class&nbsp;is&nbsp;the&nbsp;last&nbsp;entry.&nbsp;&nbsp;Its&nbsp;offset&nbsp;entry&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will&nbsp;always&nbsp;have&nbsp;only&nbsp;the&nbsp;sign&nbsp;bit&nbsp;set,&nbsp;since&nbsp;it&nbsp;has&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zero&nbsp;offset,&nbsp;and&nbsp;is&nbsp;never&nbsp;private&nbsp;or&nbsp;ambiguous.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pointers&nbsp;to&nbsp;classes&nbsp;will&nbsp;share&nbsp;the&nbsp;same&nbsp;base_table&nbsp;as<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;class&nbsp;itself.<br>
<br>
&lt;DT&gt;type_hash:&nbsp;&nbsp;&nbsp;&nbsp;&lt;DD&gt;A&nbsp;hash&nbsp;function&nbsp;representing&nbsp;the&nbsp;type.&nbsp;&nbsp;This&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obtained&nbsp;by&nbsp;applying&nbsp;the&nbsp;NIST&nbsp;Secure&nbsp;Hash&nbsp;Algorithm&nbsp;(SHA)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;the&nbsp;mangled&nbsp;name&nbsp;for&nbsp;the&nbsp;representative&nbsp;type.&nbsp;&nbsp;The<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;representative&nbsp;type&nbsp;is&nbsp;chosen&nbsp;to&nbsp;make&nbsp;exception&nbsp;type<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matching&nbsp;easy,&nbsp;and&nbsp;is&nbsp;determined&nbsp;as&nbsp;follows:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;UL&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;LI&gt;For&nbsp;pointers&nbsp;to&nbsp;class,&nbsp;the&nbsp;class.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;LI&gt;For&nbsp;all&nbsp;other&nbsp;pointers&nbsp;to&nbsp;objects,&nbsp;the&nbsp;pointer&nbsp;with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cv-qualification&nbsp;removed&nbsp;at&nbsp;all&nbsp;levels.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;LI&gt;For&nbsp;other&nbsp;types,&nbsp;the&nbsp;type&nbsp;itself<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;LI&gt;For&nbsp;&quot;...&quot;&nbsp;the&nbsp;mangled&nbsp;name&nbsp;is&nbsp;the&nbsp;empty&nbsp;string<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/UL&gt;<br>
<br>
&lt;DT&gt;flags:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;DD&gt;This&nbsp;contains&nbsp;bitflags&nbsp;used&nbsp;to&nbsp;describe&nbsp;a&nbsp;type.&nbsp;&nbsp;If<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;type&nbsp;is&nbsp;not&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;object,&nbsp;this&nbsp;word&nbsp;contains<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zero.&nbsp;&nbsp;There&nbsp;are&nbsp;two&nbsp;flag&nbsp;values.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;UL&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TABLE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TR&gt;&lt;TD&gt;void*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TD&gt;0x80000000<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TR&gt;&lt;TD&gt;any&nbsp;type&nbsp;(...)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TD&gt;0x40000000<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/TABLE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/UL&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;value&nbsp;is&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;number&nbsp;of&nbsp;pointer&nbsp;levels&gt;&nbsp;+&nbsp;flags.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;There&nbsp;are&nbsp;no&nbsp;references,&nbsp;as&nbsp;they&nbsp;are&nbsp;irrelevent&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;all&nbsp;contexts&nbsp;in&nbsp;which&nbsp;these&nbsp;objects&nbsp;are&nbsp;used.<br>
<br>
&lt;DT&gt;cv_qualifiers:&nbsp;&nbsp;&lt;DD&gt;A&nbsp;bitmask&nbsp;representing&nbsp;the&nbsp;cv&nbsp;qualifications&nbsp;for&nbsp;any<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pointer&nbsp;levels.&nbsp;&nbsp;The&nbsp;number&nbsp;of&nbsp;pointer&nbsp;levels&nbsp;is&nbsp;part<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;the&nbsp;pointer_flags&nbsp;field.&nbsp;&nbsp;Two&nbsp;bits&nbsp;are&nbsp;used&nbsp;for&nbsp;each<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;level&nbsp;of&nbsp;pointers.&nbsp;0x2&nbsp;implies&nbsp;that&nbsp;the&nbsp;level&nbsp;points&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;constant,&nbsp;while&nbsp;0x1&nbsp;implies&nbsp;that&nbsp;it&nbsp;points&nbsp;to&nbsp;volatile.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;These&nbsp;bits&nbsp;are&nbsp;built&nbsp;up&nbsp;with&nbsp;the&nbsp;outermost&nbsp;pointer&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;left,&nbsp;and&nbsp;the&nbsp;entire&nbsp;set&nbsp;is&nbsp;right&nbsp;justified.&nbsp;&nbsp;For<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;example&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;UL&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TABLE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TR&gt;&lt;TD&gt;const&nbsp;char*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TD&gt;-&gt;&nbsp;0x2&lt;TD&gt;(10)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TR&gt;&lt;TD&gt;const&nbsp;char**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TD&gt;-&gt;&nbsp;0x8&lt;TD&gt;(1000)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TR&gt;&lt;TD&gt;const&nbsp;char*const*&nbsp;&nbsp;&nbsp;&lt;TD&gt;-&gt;&nbsp;0xA&lt;TD&gt;(1010)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TR&gt;&lt;TD&gt;const&nbsp;char*volatile*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TD&gt;-&gt;&nbsp;0x9&lt;TD&gt;(1001)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/TABLE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/UL&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;can&nbsp;only&nbsp;represent&nbsp;16&nbsp;levels&nbsp;of&nbsp;pointer,&nbsp;but&nbsp;IR<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;can&nbsp;only&nbsp;represent&nbsp;13,&nbsp;so&nbsp;this&nbsp;works.&nbsp;&nbsp;If&nbsp;desired,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;a&nbsp;more&nbsp;reasonable&nbsp;IR,&nbsp;we&nbsp;can&nbsp;extend&nbsp;this&nbsp;field<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;by&nbsp;replacing&nbsp;it&nbsp;with&nbsp;a&nbsp;self-relative&nbsp;pointer&nbsp;to&nbsp;multiple<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;words.&nbsp;&nbsp;This&nbsp;would&nbsp;be&nbsp;triggered&nbsp;by&nbsp;the&nbsp;pointer_levels<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value&nbsp;in&nbsp;&quot;flags&quot;.&nbsp;&nbsp;It&nbsp;is&nbsp;not&nbsp;currently&nbsp;used.&nbsp;&nbsp;<br>
<br>
&lt;DT&gt;pointer_count()&nbsp;const:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;DD&gt;&nbsp;The&nbsp;pointer&nbsp;level&nbsp;count.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;returns&nbsp;the&nbsp;lower&nbsp;16&nbsp;bits&nbsp;of&nbsp;the&nbsp;flags<br>
<br>
&lt;DT&gt;voidstar_flag()&nbsp;const:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;DD&gt;&nbsp;Nonzero&nbsp;if&nbsp;thisis&nbsp;void*.&nbsp;&nbsp;This&nbsp;just<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;masks&nbsp;off&nbsp;the&nbsp;flag,&nbsp;it&nbsp;doesn't&nbsp;convert&nbsp;it&nbsp;to&nbsp;bool.<br>
<br>
&lt;DT&gt;dotdotdot_flag()&nbsp;const;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;DD&gt;&nbsp;non-zero&nbsp;if&nbsp;this&nbsp;is&nbsp;&quot;...&quot;.&nbsp;&nbsp;This&nbsp;just<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;masks&nbsp;off&nbsp;the&nbsp;flag,&nbsp;it&nbsp;doesn't&nbsp;convert&nbsp;it&nbsp;to&nbsp;bool.<br>
&lt;/DL&gt;<br>
<br>
&lt;H3&gt;Issues&nbsp;with&nbsp;RTTI&nbsp;blocks&nbsp;still&nbsp;open&nbsp;to&nbsp;change.&lt;/H3&gt;<br>
<br>
&lt;P&gt;Polymorphic&nbsp;classes&nbsp;have&nbsp;references&nbsp;to&nbsp;static_type_info&nbsp;blocks&nbsp;in&nbsp;their<br>
virtual&nbsp;tables.&nbsp;&nbsp;Virtual&nbsp;table&nbsp;entries&nbsp;are&nbsp;of&nbsp;type<br>
&lt;PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;union&nbsp;vtab_entry&nbsp;{&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;(*f)();&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;function&nbsp;pointer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr_diff_t&nbsp;o;&nbsp;&nbsp;&nbsp;//&nbsp;offset&nbsp;adjustment<br>
&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/PRE&gt;<br>
If&nbsp;the&nbsp;virtual&nbsp;pointer&nbsp;in&nbsp;a&nbsp;class&nbsp;is&nbsp;denoted&nbsp;by&nbsp;&quot;virt_ptr&quot;,&nbsp;then<br>
&lt;PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;virt_ptr[0].o<br>
&lt;/PRE&gt;<br>
is&nbsp;a&nbsp;self-relative&nbsp;pointer&nbsp;to&nbsp;static&nbsp;type&nbsp;data&nbsp;for&nbsp;the&nbsp;most-derived&nbsp;class,<br>
and<br>
&lt;PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;virt_ptr[1].o<br>
&lt;/PRE&gt;<br>
is&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;subobject&nbsp;with&nbsp;the&nbsp;virtual&nbsp;pointer&nbsp;in&nbsp;the&nbsp;entire<br>
class&nbsp;object.<br>
<br>
&lt;H3&gt;Dynamic&nbsp;Casts&lt;/H3&gt;<br>
<br>
&lt;P&gt;Dynamic&nbsp;casts&nbsp;are&nbsp;divided&nbsp;into&nbsp;cases&nbsp;at&nbsp;compile&nbsp;time,&nbsp;and&nbsp;each&nbsp;case<br>
generates&nbsp;different&nbsp;code.<br>
<br>
&lt;DL&gt;<br>
&lt;DT&gt;&lt;P&gt;&lt;B&gt;Up&nbsp;cast&nbsp;to&nbsp;a&nbsp;base&nbsp;class:&lt;/B&gt;<br>
<br>
&lt;DD&gt;&lt;P&gt;Handled&nbsp;as&nbsp;a&nbsp;normal&nbsp;static&nbsp;cast.&nbsp;&nbsp;No&nbsp;dynamic&nbsp;code&nbsp;is&nbsp;generated<br>
<br>
&lt;DT&gt;&lt;P&gt;&lt;B&gt;Cast&nbsp;to&nbsp;void*&lt;/B&gt;<br>
<br>
&lt;DD&gt;&lt;P&gt;This&nbsp;is&nbsp;defined&nbsp;as&nbsp;returning&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;entire<br>
&nbsp;&nbsp;&nbsp;&nbsp;object.&nbsp;&nbsp;Code&nbsp;is&nbsp;generated&nbsp;inline.<br>
&lt;UL&gt;<br>
&lt;PRE&gt;<br>
static_type*&nbsp;temp;<br>
(temp&nbsp;=&nbsp;opnd,<br>
(temp&nbsp;!=&nbsp;NULL)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?&nbsp;(void*)(((char*)temp)&nbsp;-&nbsp;temp-&gt;virtualsym[1].o)<br>
&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;(void*)&nbsp;temp<br>
)&nbsp;<br>
&lt;/PRE&gt;<br>
&lt;/UL&gt;<br>
&lt;DT&gt;&lt;P&gt;&lt;B&gt;Source&nbsp;class&nbsp;is&nbsp;a&nbsp;unique&nbsp;non-virtual&nbsp;base&nbsp;class&nbsp;of&nbsp;destination&nbsp;class&lt;/B&gt;<br>
<br>
&lt;DD&gt;&nbsp;This&nbsp;generates&nbsp;a&nbsp;call&nbsp;to&nbsp;the&nbsp;function<br>
&lt;PRE&gt;<br>
&lt;UL&gt;<br>
void*&nbsp;__Crun::simple_down_cast(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void*&nbsp;opnd,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;original&nbsp;pointer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_type_info*&nbsp;sclass,&nbsp;&nbsp;&nbsp;//&nbsp;source&nbsp;class<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_type_info*&nbsp;dclass);&nbsp;&nbsp;//&nbsp;destination&nbsp;class<br>
&lt;/UL&gt;<br>
&lt;/PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;this&nbsp;case&nbsp;there&nbsp;can&nbsp;be&nbsp;only&nbsp;one&nbsp;subobject&nbsp;of&nbsp;the&nbsp;static&nbsp;source<br>
&nbsp;&nbsp;&nbsp;&nbsp;type,&nbsp;and&nbsp;the&nbsp;only&nbsp;piece&nbsp;of&nbsp;information&nbsp;needed&nbsp;is&nbsp;the&nbsp;offset&nbsp;within<br>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;entire&nbsp;object,&nbsp;which&nbsp;the&nbsp;routine&nbsp;picks&nbsp;up&nbsp;from&nbsp;the&nbsp;virtual&nbsp;table.<br>
<br>
&lt;P&gt;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;algorithm&nbsp;is:<br>
&lt;OL&gt;<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;opnd&nbsp;is&nbsp;NULL,&nbsp;return&nbsp;NULL.<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Search&nbsp;the&nbsp;base&nbsp;class&nbsp;table&nbsp;looking&nbsp;for&nbsp;an&nbsp;entry&nbsp;with&nbsp;the&nbsp;proper<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;class&nbsp;at&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;static&nbsp;class.<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Search&nbsp;the&nbsp;base&nbsp;table&nbsp;from&nbsp;that&nbsp;point&nbsp;looking&nbsp;for&nbsp;a&nbsp;match<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;the&nbsp;destination&nbsp;class<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;destination&nbsp;class&nbsp;is&nbsp;not&nbsp;found&nbsp;the&nbsp;cast&nbsp;fails,&nbsp;return&nbsp;NULL<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;the&nbsp;cast&nbsp;succeeds,&nbsp;since&nbsp;other&nbsp;conditions&nbsp;have<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;been&nbsp;checked&nbsp;statically.&nbsp;&nbsp;Adjust&nbsp;the&nbsp;pointer&nbsp;using&nbsp;the&nbsp;two<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offsets.&nbsp;and&nbsp;return&nbsp;it.<br>
&lt;/OL&gt;<br>
&lt;DT&gt;&lt;P&gt;&lt;B&gt;Source&nbsp;is&nbsp;a&nbsp;public&nbsp;base&nbsp;class&nbsp;of&nbsp;dest,&nbsp;but&nbsp;there&nbsp;is&nbsp;some&nbsp;virtual<br>
&nbsp;&nbsp;&nbsp;&nbsp;inheritance&nbsp;involved&nbsp;so&nbsp;that&nbsp;there&nbsp;could&nbsp;be&nbsp;more&nbsp;than&nbsp;one&nbsp;class<br>
&nbsp;&nbsp;&nbsp;&nbsp;derived&nbsp;from&nbsp;this&nbsp;subobject.&lt;/B&gt;<br>
<br>
&lt;DD&gt;&nbsp;This&nbsp;generates&nbsp;a&nbsp;call&nbsp;to&nbsp;the&nbsp;function<br>
&lt;UL&gt;<br>
&lt;PRE&gt;<br>
void*&nbsp;__Crun::down_cast(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void*&nbsp;opnd,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Original&nbsp;pointer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_type_info*&nbsp;sclass,&nbsp;&nbsp;&nbsp;//&nbsp;source&nbsp;class<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_type_info*&nbsp;dclass);&nbsp;&nbsp;//&nbsp;destination&nbsp;class<br>
&lt;/PRE&gt;<br>
&lt;/UL&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;this&nbsp;case&nbsp;the&nbsp;dynamic&nbsp;table&nbsp;is&nbsp;searched&nbsp;to&nbsp;find&nbsp;subobjects&nbsp;of&nbsp;type<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;sclass&quot;&nbsp;at&nbsp;the&nbsp;offset&nbsp;obtained&nbsp;from&nbsp;the&nbsp;virtual&nbsp;table.&nbsp;&nbsp;Then&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;cast&nbsp;to&nbsp;&quot;dclass&quot;&nbsp;proceeds&nbsp;from&nbsp;that&nbsp;object.<br>
<br>
&lt;P&gt;The&nbsp;algorithm&nbsp;is:<br>
&lt;OL&gt;<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;opnd&nbsp;is&nbsp;NULL,&nbsp;return&nbsp;NULL.<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Search&nbsp;the&nbsp;base&nbsp;table&nbsp;from&nbsp;first&nbsp;to&nbsp;last,&nbsp;looking&nbsp;for&nbsp;a&nbsp;match<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;the&nbsp;source&nbsp;class&nbsp;that&nbsp;has&nbsp;the&nbsp;same&nbsp;offset&nbsp;as&nbsp;the&nbsp;original<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subobject.<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;this&nbsp;search&nbsp;fails,&nbsp;we&nbsp;have&nbsp;an&nbsp;internal&nbsp;error.<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;&quot;private&quot;&nbsp;bit&nbsp;is&nbsp;set&nbsp;in&nbsp;this&nbsp;base&nbsp;entry,&nbsp;the&nbsp;cast&nbsp;fails,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;From&nbsp;that&nbsp;point,&nbsp;search&nbsp;the&nbsp;base&nbsp;table&nbsp;toward&nbsp;the&nbsp;last,&nbsp;looking<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;a&nbsp;match&nbsp;with&nbsp;the&nbsp;destination&nbsp;class.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;destination&nbsp;class&nbsp;is&nbsp;not&nbsp;found,&nbsp;or&nbsp;if&nbsp;the&nbsp;&quot;private&quot;&nbsp;bit<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;set,&nbsp;the&nbsp;cast&nbsp;fails,&nbsp;return&nbsp;NULL<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Continue&nbsp;searching&nbsp;for&nbsp;the&nbsp;destination&nbsp;class.&nbsp;&nbsp;If&nbsp;it&nbsp;is&nbsp;found,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;cast&nbsp;fails,&nbsp;return&nbsp;NULL<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;the&nbsp;cast&nbsp;succeeds,&nbsp;and&nbsp;the&nbsp;pointer&nbsp;is&nbsp;adjusted&nbsp;using<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;offset&nbsp;from&nbsp;the&nbsp;vtable&nbsp;and&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;destination<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;entry.<br>
&lt;/OL&gt;<br>
<br>
&lt;DT&gt;&lt;P&gt;&lt;B&gt;There&nbsp;is&nbsp;no&nbsp;relationship&nbsp;between&nbsp;the&nbsp;types,&nbsp;so&nbsp;the&nbsp;cast&nbsp;must&nbsp;cross&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;hierarchy&nbsp;in&nbsp;the&nbsp;most-derived&nbsp;class&lt;/B&gt;<br>
&lt;DD&gt;<br>
&lt;UL&gt;<br>
&lt;PRE&gt;<br>
void*&nbsp;__Crun::cross_cast(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void*&nbsp;opnd,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;original&nbsp;pointer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_type_info*&nbsp;sclass,&nbsp;&nbsp;&nbsp;//&nbsp;source&nbsp;class<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_type_info*&nbsp;dclass);&nbsp;&nbsp;//&nbsp;destination&nbsp;class<br>
&lt;/PRE&gt;<br>
&lt;/UL&gt;<br>
&lt;P&gt;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;algorithm&nbsp;is:<br>
&lt;oL&gt;<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;opnd&nbsp;is&nbsp;NULL,&nbsp;return&nbsp;NULL.<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Search&nbsp;the&nbsp;base&nbsp;table&nbsp;from&nbsp;first&nbsp;to&nbsp;last,&nbsp;looking&nbsp;for&nbsp;a&nbsp;match<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;the&nbsp;source&nbsp;class&nbsp;that&nbsp;has&nbsp;the&nbsp;same&nbsp;offset&nbsp;as&nbsp;the&nbsp;original<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subobject.<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;this&nbsp;search&nbsp;fails,&nbsp;we&nbsp;have&nbsp;an&nbsp;internal&nbsp;error.<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;&quot;private&quot;&nbsp;bit&nbsp;is&nbsp;set&nbsp;in&nbsp;this&nbsp;base&nbsp;entry,&nbsp;the&nbsp;cast&nbsp;fails,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Beginning&nbsp;again&nbsp;from&nbsp;the&nbsp;start,&nbsp;search&nbsp;the&nbsp;base&nbsp;table&nbsp;toward<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;last,&nbsp;looking&nbsp;for&nbsp;a&nbsp;match&nbsp;with&nbsp;the&nbsp;destination&nbsp;class.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;destination&nbsp;class&nbsp;is&nbsp;not&nbsp;found,&nbsp;or&nbsp;if&nbsp;the&nbsp;&quot;private&quot;&nbsp;bit<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;set,&nbsp;the&nbsp;cast&nbsp;fails,&nbsp;return&nbsp;NULL<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Continue&nbsp;searching&nbsp;for&nbsp;the&nbsp;destination&nbsp;class.&nbsp;&nbsp;If&nbsp;it&nbsp;is&nbsp;found,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;cast&nbsp;fails,&nbsp;return&nbsp;NULL<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;the&nbsp;cast&nbsp;succeeds,&nbsp;and&nbsp;the&nbsp;pointer&nbsp;is&nbsp;adjusted&nbsp;using<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;offset&nbsp;from&nbsp;the&nbsp;vtable&nbsp;and&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;destination<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;entry.<br>
&lt;/OL&gt;<br>
&lt;/DL&gt;<br>
&lt;P&gt;The&nbsp;reference&nbsp;casts&nbsp;are&nbsp;identical,&nbsp;except&nbsp;that&nbsp;they&nbsp;throw&nbsp;an&nbsp;exception<br>
instead&nbsp;of&nbsp;returning&nbsp;NULL.&nbsp;&nbsp;The&nbsp;corresponding&nbsp;functions&nbsp;are:<br>
&lt;UL&gt;<br>
&lt;PRE&gt;<br>
void*&nbsp;__Crun::ref_simple_down_cast(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void*&nbsp;opnd,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;original&nbsp;pointer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_type_info*&nbsp;dclass);&nbsp;&nbsp;//&nbsp;destination&nbsp;class<br>
<br>
void*&nbsp;__Crun::ref_down_cast(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void*&nbsp;opnd,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Original&nbsp;pointer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_type_info*&nbsp;sclass,&nbsp;&nbsp;&nbsp;//&nbsp;source&nbsp;class<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_type_info*&nbsp;dclass);&nbsp;&nbsp;//&nbsp;destination&nbsp;class<br>
<br>
void*&nbsp;__Crun::ref_cross_cast(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void*&nbsp;opnd,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;original&nbsp;pointer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_type_info*&nbsp;sclass,&nbsp;&nbsp;&nbsp;//&nbsp;source&nbsp;class<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_type_info*&nbsp;dclass);&nbsp;&nbsp;//&nbsp;destination&nbsp;class<br>
&lt;/PRE&gt;<br>
&lt;/UL&gt;<br>
&lt;H3&gt;Typeid&lt;/H3&gt;<br>
<br>
&lt;P&gt;Objects&nbsp;of&nbsp;type&nbsp;&quot;type_info&quot;&nbsp;are&nbsp;required&nbsp;to&nbsp;be&nbsp;polymorphic,&nbsp;which&nbsp;means<br>
that&nbsp;they&nbsp;have&nbsp;vtable&nbsp;pointers,&nbsp;and&nbsp;these&nbsp;pointers&nbsp;are&nbsp;not&nbsp;self-relative<br>
or&nbsp;position-independent.&nbsp;&nbsp;The&nbsp;practical&nbsp;consequence&nbsp;of&nbsp;this&nbsp;is&nbsp;that&nbsp;<br>
type_info&nbsp;objects&nbsp;cannot&nbsp;be&nbsp;allocated&nbsp;in&nbsp;readonly&nbsp;memory.&nbsp;&nbsp;They&nbsp;could<br>
be&nbsp;statically&nbsp;allocated,&nbsp;but&nbsp;this&nbsp;has&nbsp;the&nbsp;disadvantage&nbsp;that&nbsp;they&nbsp;then<br>
go&nbsp;into&nbsp;global&nbsp;data,&nbsp;expanding&nbsp;that&nbsp;area&nbsp;and&nbsp;forcing&nbsp;the&nbsp;program&nbsp;toward<br>
big&nbsp;PIC&nbsp;code,&nbsp;with&nbsp;attendent&nbsp;overheads.<br>
<br>
&lt;P&gt;Since&nbsp;the&nbsp;use&nbsp;of&nbsp;type_info&nbsp;objects&nbsp;is&nbsp;probably&nbsp;going&nbsp;to&nbsp;be&nbsp;rare,&nbsp;and<br>
in&nbsp;many&nbsp;cases&nbsp;will&nbsp;be&nbsp;associated&nbsp;with&nbsp;expensive&nbsp;operations&nbsp;like&nbsp;IO,<br>
it&nbsp;seems&nbsp;better&nbsp;to&nbsp;allocate&nbsp;them&nbsp;dynamically&nbsp;as&nbsp;needed.<br>
&lt;PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;type_info&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;public:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Operators&nbsp;ignored<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;private:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;static_type_info*&nbsp;data;<br>
&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/PRE&gt;<br>
Type_info&nbsp;objects&nbsp;then&nbsp;will&nbsp;consist&nbsp;of&nbsp;two&nbsp;pointers,&nbsp;on&nbsp;to&nbsp;the&nbsp;virtual<br>
table&nbsp;and&nbsp;one&nbsp;to&nbsp;the&nbsp;corresponding&nbsp;static_type_info&nbsp;object&nbsp;generated<br>
by&nbsp;the&nbsp;compiler.&nbsp;There&nbsp;is&nbsp;no&nbsp;need&nbsp;for&nbsp;the&nbsp;objects&nbsp;to&nbsp;be&nbsp;unique,&nbsp;as&nbsp;all<br>
comparisons&nbsp;are&nbsp;done&nbsp;on&nbsp;the&nbsp;type&nbsp;hash&nbsp;and&nbsp;pointer&nbsp;data.&nbsp;&nbsp;It&nbsp;would&nbsp;probably<br>
be&nbsp;well&nbsp;to&nbsp;allocate&nbsp;space&nbsp;in&nbsp;groups,&nbsp;and&nbsp;to&nbsp;use&nbsp;a&nbsp;small&nbsp;hash&nbsp;table&nbsp;based<br>
on&nbsp;the&nbsp;address&nbsp;of&nbsp;the&nbsp;static&nbsp;information&nbsp;to&nbsp;keep&nbsp;allocation&nbsp;down.<br>
<br>
&lt;P&gt;&quot;typeid&quot;&nbsp;can&nbsp;be&nbsp;applied&nbsp;either&nbsp;statically&nbsp;or&nbsp;dynamically.<br>
&lt;OL&gt;<br>
&lt;LI&gt;&nbsp;&nbsp;Dynamic&nbsp;determination,&nbsp;must&nbsp;be&nbsp;a&nbsp;polymorphic&nbsp;class<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;P&gt;Calls&nbsp;the&nbsp;function<br>
&lt;PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;type_info&amp;&nbsp;__Crun::get_typeid(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void*&nbsp;opnd);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;object&nbsp;pointer<br>
&lt;/PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;function&nbsp;extracts&nbsp;the&nbsp;static_type_info&nbsp;from&nbsp;the&nbsp;virtual&nbsp;table<br>
&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;creates&nbsp;a&nbsp;type_info&nbsp;object.&nbsp;&nbsp;If&nbsp;&quot;opnd&quot;&nbsp;is&nbsp;void&nbsp;it&nbsp;throws&nbsp;an<br>
&nbsp;&nbsp;&nbsp;&nbsp;exception.<br>
<br>
&lt;LI&gt;&nbsp;&nbsp;Static&nbsp;determination,&nbsp;could&nbsp;be&nbsp;any&nbsp;type<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;P&gt;Calls&nbsp;the&nbsp;function<br>
&lt;PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;type_info&amp;&nbsp;__Crun::make_typeid(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static_type_info*&nbsp;data);&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;static&nbsp;data<br>
&lt;/PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;function&nbsp;creates&nbsp;a&nbsp;type_info&nbsp;object&nbsp;with&nbsp;the&nbsp;supplied&nbsp;static&nbsp;data.<br>
&lt;/OL&gt;<br>
&lt;H3&gt;Exception&nbsp;Interface&lt;/H3&gt;<br>
The&nbsp;exception&nbsp;matching&nbsp;and&nbsp;casting&nbsp;rules&nbsp;are&nbsp;not&nbsp;the&nbsp;same&nbsp;as&nbsp;dynamic&nbsp;cast,<br>
so&nbsp;we&nbsp;need&nbsp;an&nbsp;interface&nbsp;to&nbsp;provide&nbsp;RTTI&nbsp;services&nbsp;for&nbsp;exceptions.<br>
&lt;DL&gt;<br>
&lt;DT&gt;<br>
&lt;pre&gt;<br>
bool&nbsp;__Cimpl::exception_matches(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;__Crun::static_type_info*&nbsp;src,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;__Crun::static_type_info*&nbsp;dest);<br>
&lt;/pre&gt;<br>
&lt;DD&gt;True&nbsp;if&nbsp;the&nbsp;catch&nbsp;type&nbsp;represented&nbsp;by&nbsp;&quot;dest&quot;&nbsp;is&nbsp;a&nbsp;valid&nbsp;match&nbsp;for&nbsp;the<br>
static&nbsp;exception&nbsp;type,&nbsp;represented&nbsp;by&nbsp;&quot;src&quot;.<br>
&lt;DT&gt;<br>
&lt;pre&gt;<br>
void*&nbsp;__Cimpl::exception_adjust(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;__Crun::static_type_info*&nbsp;src,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;__Crun::static_type_info*&nbsp;dest,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void*&nbsp;obj);<br>
&lt;/pre&gt;<br>
&lt;DD&gt;Assuming&nbsp;that&nbsp;we&nbsp;have&nbsp;found&nbsp;an&nbsp;exception&nbsp;match,&nbsp;make&nbsp;any&nbsp;necessary<br>
offset&nbsp;adjustment&nbsp;required&nbsp;to&nbsp;cast&nbsp;from&nbsp;the&nbsp;source&nbsp;type&nbsp;to&nbsp;the<br>
destination&nbsp;type.&nbsp;&nbsp;This&nbsp;always&nbsp;casts&nbsp;up&nbsp;the&nbsp;hierarchy,&nbsp;doing&nbsp;the<br>
equivalent&nbsp;of&nbsp;a&nbsp;static_cast.&nbsp;&nbsp;Note&nbsp;when&nbsp;using&nbsp;this&nbsp;that&nbsp;if&nbsp;the<br>
thrown&nbsp;type&nbsp;is&nbsp;a&nbsp;pointer&nbsp;this&nbsp;adjustment&nbsp;should&nbsp;be&nbsp;applied&nbsp;to&nbsp;the<br>
thrown&nbsp;value&nbsp;itself,&nbsp;rather&nbsp;than&nbsp;to&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;thrown&nbsp;object.<br>
&lt;DT&gt;<br>
&lt;PRE&gt;<br>
bool&nbsp;__Cimpl::is_bad_exception(const&nbsp;__Crun::static_type_info*&nbsp;src);<br>
&lt;/pre&gt;<br>
&lt;DD&gt;&nbsp;True&nbsp;if&nbsp;the&nbsp;argument&nbsp;is&nbsp;the&nbsp;static&nbsp;type&nbsp;info&nbsp;object&nbsp;for&nbsp;the<br>
&quot;bad_exception&quot;&nbsp;type.&nbsp;&nbsp;This&nbsp;is&nbsp;needed&nbsp;while&nbsp;handling&nbsp;unexpected()&nbsp;calls<br>
&lt;/DL&gt;<br>
<br>
&lt;H3&gt;Generation&nbsp;Strategy&lt;/H3&gt;<br>
<br>
&lt;P&gt;Static&nbsp;type&nbsp;info&nbsp;blocks&nbsp;have&nbsp;a&nbsp;name&nbsp;formed&nbsp;by&nbsp;appending&nbsp;the&nbsp;mangled<br>
name&nbsp;for&nbsp;the&nbsp;represented&nbsp;type&nbsp;to&nbsp;&quot;__RTTI__&quot;.&nbsp;&nbsp;The&nbsp;namespace&nbsp;in&nbsp;which<br>
the&nbsp;blocks&nbsp;are&nbsp;placed&nbsp;will&nbsp;depend&nbsp;on&nbsp;where&nbsp;the&nbsp;block&nbsp;is&nbsp;generated,<br>
not&nbsp;on&nbsp;the&nbsp;type&nbsp;represented.<br>
<br>
&lt;P&gt;There&nbsp;are&nbsp;three&nbsp;algorithms&nbsp;for&nbsp;determining&nbsp;the&nbsp;location&nbsp;of&nbsp;static<br>
information&nbsp;blocks.<br>
&lt;OL&gt;<br>
&lt;LI&gt;For&nbsp;a&nbsp;polymorphic&nbsp;class&nbsp;with&nbsp;a&nbsp;non-inline,&nbsp;non-pure&nbsp;virtual&nbsp;function,<br>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;virtual&nbsp;table&nbsp;and&nbsp;static&nbsp;type&nbsp;data&nbsp;for&nbsp;that&nbsp;class&nbsp;are&nbsp;generated<br>
&nbsp;&nbsp;&nbsp;&nbsp;as&nbsp;global&nbsp;definitions&nbsp;in&nbsp;the&nbsp;compilation&nbsp;unit&nbsp;containing&nbsp;the&nbsp;definition<br>
&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;that&nbsp;function.&nbsp;&nbsp;The&nbsp;static&nbsp;type&nbsp;data&nbsp;will&nbsp;be&nbsp;generated&nbsp;in&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;innermost&nbsp;namespace&nbsp;enclosing&nbsp;the&nbsp;class.<br>
&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;the&nbsp;same&nbsp;compilation&nbsp;unit&nbsp;we&nbsp;will&nbsp;generate<br>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;static&nbsp;data&nbsp;for&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;class&nbsp;and&nbsp;a&nbsp;pointer&nbsp;to&nbsp;const<br>
&nbsp;&nbsp;&nbsp;&nbsp;class.&nbsp;&nbsp;These&nbsp;will&nbsp;share&nbsp;a&nbsp;single&nbsp;base&nbsp;class&nbsp;table,&nbsp;which&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;considered&nbsp;a&nbsp;static&nbsp;member&nbsp;of&nbsp;the&nbsp;class&nbsp;and&nbsp;will&nbsp;also&nbsp;be&nbsp;generated&nbsp;there.<br>
&nbsp;&nbsp;&nbsp;&nbsp;That&nbsp;is,&nbsp;for&nbsp;&quot;class&nbsp;ns::foo&quot;,&nbsp;we&nbsp;will&nbsp;generate<br>
&lt;UL&gt;<br>
&lt;TABLE&gt;<br>
&lt;TR&gt;&lt;TD&gt;&nbsp;&nbsp;&nbsp;&nbsp;ns::foo::_vtbl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;TD&gt;The&nbsp;virtual&nbsp;table<br>
&lt;TR&gt;&lt;TD&gt;&nbsp;&nbsp;&nbsp;&nbsp;ns::foo::__BASE_TABLE__&nbsp;&lt;TD&gt;The&nbsp;base&nbsp;table&nbsp;for&nbsp;foo<br>
&lt;TR&gt;&lt;TD&gt;&nbsp;&nbsp;&nbsp;&nbsp;ns::__RTTI__&lt;foo&gt;&nbsp;&lt;TD&gt;foo&nbsp;static&nbsp;data<br>
&lt;TR&gt;&lt;TD&gt;&nbsp;&nbsp;&nbsp;&nbsp;ns::__RTTI__&lt;foo&gt;&nbsp;&lt;TD&gt;foo*&nbsp;static&nbsp;data<br>
&lt;TR&gt;&lt;TD&gt;&nbsp;&nbsp;&nbsp;&nbsp;ns::__RTTI__&lt;const&nbsp;foo*&gt;&nbsp;&nbsp;&lt;TD&gt;const&nbsp;foo*&nbsp;static&nbsp;data<br>
&lt;/TABLE&gt;<br>
&lt;/UL&gt;<br>
&lt;LI&gt;&nbsp;&nbsp;For&nbsp;builtin&nbsp;and&nbsp;very&nbsp;common&nbsp;types&nbsp;the&nbsp;static&nbsp;data&nbsp;will&nbsp;be&nbsp;generated&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;support&nbsp;library.&nbsp;&nbsp;These&nbsp;will&nbsp;be&nbsp;generated&nbsp;in&nbsp;namespace&nbsp;&quot;__Crun&quot;.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Generation&nbsp;of&nbsp;library&nbsp;type_info&nbsp;data&nbsp;can&nbsp;be&nbsp;enabled&nbsp;with&nbsp;the&nbsp;pragma:<br>
&lt;PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#pragma&nbsp;generate_library(static_type_info)<br>
&lt;/PRE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;tentative&nbsp;list&nbsp;of&nbsp;library&nbsp;type&nbsp;data&nbsp;is:<br>
&lt;UL&gt;<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;All&nbsp;builtin&nbsp;types<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void*<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char*<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char*<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wchar_t*<br>
&lt;LI&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;wchar_t*<br>
&lt;/UL&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;P&gt;&nbsp;NOTE:&nbsp;&nbsp;This&nbsp;is&nbsp;not&nbsp;yet&nbsp;implemented.&nbsp;&nbsp;Currently,&nbsp;these&nbsp;types&nbsp;are&nbsp;handled<br>
&nbsp;&nbsp;&nbsp;&nbsp;as&nbsp;in&nbsp;case&nbsp;3.<br>
<br>
&lt;LI&gt;For&nbsp;all&nbsp;other&nbsp;types,&nbsp;static&nbsp;type&nbsp;information&nbsp;is&nbsp;generated&nbsp;as&nbsp;a&nbsp;weak<br>
&nbsp;&nbsp;&nbsp;&nbsp;global&nbsp;variable&nbsp;in&nbsp;any&nbsp;compilation&nbsp;unit&nbsp;in&nbsp;which&nbsp;it&nbsp;is&nbsp;needed.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Such&nbsp;blocks&nbsp;are&nbsp;generated&nbsp;in&nbsp;file_scope.&nbsp;&nbsp;The<br>
&nbsp;&nbsp;&nbsp;&nbsp;symbol&nbsp;is&nbsp;made&nbsp;a&nbsp;weak&nbsp;global&nbsp;rather&nbsp;than&nbsp;a&nbsp;static&nbsp;to&nbsp;simplify<br>
&nbsp;&nbsp;&nbsp;&nbsp;generation&nbsp;of&nbsp;unique&nbsp;type_info&nbsp;objects.<br>
&lt;/OL&gt;<br>
&lt;H3&gt;Debugger&nbsp;interface&lt;/H3&gt;<br>
&lt;P&gt;When&nbsp;compiled&nbsp;with&nbsp;debugging&nbsp;enabled,&nbsp;each&nbsp;generated&nbsp;RTTI<br>
block&nbsp;will&nbsp;have&nbsp;a&nbsp;corresponding&nbsp;RTTI&nbsp;stab&nbsp;to&nbsp;map&nbsp;the&nbsp;type&nbsp;onto&nbsp;the&nbsp;symbol<br>
name.&nbsp;&nbsp;The&nbsp;following&nbsp;functions&nbsp;provide&nbsp;a&nbsp;relatively&nbsp;simple&nbsp;interface<br>
to&nbsp;the&nbsp;rtti&nbsp;functionality<br>
<br>
&lt;DL&gt;<br>
&lt;DT&gt;<br>
&lt;PRE&gt;<br>
extern&nbsp;&quot;C&quot;&nbsp;const&nbsp;type_info*&nbsp;__exdbg_get_typeinfo(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;static_type_info*);&nbsp;&lt;/PRE&gt;<br>
&lt;DD&gt;<br>
Obtains&nbsp;a&nbsp;pointer&nbsp;to&nbsp;a&nbsp;type_info&nbsp;object&nbsp;corresponding&nbsp;to&nbsp;the&nbsp;pointer&nbsp;to<br>
a&nbsp;static_type_info&nbsp;object.&nbsp;&nbsp;There&nbsp;is&nbsp;no&nbsp;guarantee&nbsp;that&nbsp;there&nbsp;is&nbsp;only<br>
one&nbsp;type_info&nbsp;object&nbsp;per&nbsp;type.<br>
&lt;DT&gt;<br>
&lt;PRE&gt;<br>
extern&nbsp;&quot;C&quot;&nbsp;void*&nbsp;__exdbg_dynamic_cast(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void*&nbsp;obj,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;static_type_info*&nbsp;source,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;static_type_info*&nbsp;dest);&nbsp;&lt;/PRE&gt;<br>
&lt;DD&gt;<br>
Given&nbsp;a&nbsp;pointer&nbsp;to&nbsp;a&nbsp;polymorphic&nbsp;object,&nbsp;apply&nbsp;a&nbsp;dynamic&nbsp;cast&nbsp;to&nbsp;that<br>
object.&nbsp;&nbsp;&quot;source&quot;&nbsp;is&nbsp;the&nbsp;static_type_info&nbsp;for&nbsp;the&nbsp;static&nbsp;type&nbsp;of&nbsp;the<br>
object&nbsp;and&nbsp;&quot;dest&quot;&nbsp;is&nbsp;the&nbsp;static_type_info&nbsp;for&nbsp;the&nbsp;desired&nbsp;type.&nbsp;&nbsp;The<br>
result&nbsp;will&nbsp;be&nbsp;an&nbsp;appropriately&nbsp;adjusted&nbsp;pointer&nbsp;if&nbsp;the&nbsp;cast&nbsp;succeeds<br>
or&nbsp;NULL&nbsp;if&nbsp;the&nbsp;cast&nbsp;fails.&nbsp;&nbsp;A&nbsp;NULL&nbsp;pointer&nbsp;will&nbsp;also&nbsp;return&nbsp;NULL&nbsp;rather<br>
than&nbsp;throwing&nbsp;an&nbsp;exception<br>
&lt;/DL&gt;<br>
&lt;/BODY&gt;<br>
&lt;/HTML&gt;<br>

</tt>
