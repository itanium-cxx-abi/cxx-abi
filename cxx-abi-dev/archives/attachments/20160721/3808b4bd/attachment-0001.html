<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;21&nbsp;July&nbsp;2016&nbsp;at&nbsp;11:02,&nbsp;Jason&nbsp;Merrill&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:jason@redhat.com&quot;&nbsp;target=&quot;_blank&quot;&gt;jason@redhat.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;P0135&nbsp;seems&nbsp;to&nbsp;require&nbsp;that&nbsp;we&nbsp;elide&nbsp;the&nbsp;copy&nbsp;when&nbsp;using&nbsp;the&nbsp;result&nbsp;of&lt;br&gt;<br>
a&nbsp;function&nbsp;returning&nbsp;by&nbsp;value&nbsp;to&nbsp;initialize&nbsp;a&nbsp;base&nbsp;class&nbsp;subobject,&lt;br&gt;<br>
but&nbsp;the&nbsp;ABI&nbsp;doesn&#39;t&nbsp;currently&nbsp;require&nbsp;that&nbsp;such&nbsp;a&nbsp;function&nbsp;avoid&lt;br&gt;<br>
clobbering&nbsp;tail&nbsp;padding&nbsp;when&nbsp;initializing&nbsp;its&nbsp;return&nbsp;object.&lt;br&gt;<br>
Thoughts?&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;the&nbsp;function&nbsp;clobbers&nbsp;the&nbsp;tail&nbsp;padding&nbsp;of&nbsp;its&nbsp;return&nbsp;object,&nbsp;at&nbsp;least&nbsp;GCC&nbsp;and&nbsp;Clang&nbsp;will&nbsp;miscompile&nbsp;the&nbsp;program&nbsp;today,&nbsp;without&nbsp;P0135:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;#include&nbsp;&lt;string.h&gt;&lt;/div&gt;&lt;div&gt;struct&nbsp;X&nbsp;{&nbsp;~X()&nbsp;{}&nbsp;int&nbsp;n;&nbsp;char&nbsp;d;&nbsp;};&lt;/div&gt;&lt;div&gt;struct&nbsp;Y&nbsp;{&nbsp;Y();&nbsp;char&nbsp;c[3];&nbsp;};&lt;/div&gt;&lt;div&gt;struct&nbsp;Z&nbsp;:&nbsp;X,&nbsp;virtual&nbsp;Y&nbsp;{&nbsp;Z();&nbsp;};&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;X&nbsp;f()&nbsp;{&nbsp;X&nbsp;nrvo;&nbsp;memset(&amp;nrvo,&nbsp;0,&nbsp;sizeof(X));&nbsp;return&nbsp;nrvo;&nbsp;}&lt;br&gt;&lt;/div&gt;&lt;div&gt;Z::Z()&nbsp;:&nbsp;Y(),&nbsp;X(f())&nbsp;{}&lt;/div&gt;&lt;div&gt;Y::Y()&nbsp;:&nbsp;c{1,&nbsp;2,&nbsp;3}&nbsp;{}&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;int&nbsp;main()&nbsp;{&lt;/div&gt;&lt;div&gt; &nbsp;Z&nbsp;z;&lt;/div&gt;&lt;div&gt; &nbsp;return&nbsp;z.c[0];&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;GCC&nbsp;-O0&nbsp;returns&nbsp;1&nbsp;from&nbsp;main,&nbsp;as&nbsp;it&nbsp;should.&nbsp;GCC&nbsp;-O2&nbsp;and&nbsp;Clang&nbsp;(any&nbsp;optimization&nbsp;level,&nbsp;even&nbsp;with&nbsp;-fno-elide-constructors)&nbsp;returns&nbsp;0.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;(It&nbsp;looks&nbsp;like&nbsp;Clang&nbsp;gets&nbsp;this&nbsp;&quot;wrong&quot;&nbsp;in&nbsp;two&nbsp;ways:&nbsp;first,&nbsp;NRVO&nbsp;is&nbsp;apprently&nbsp;never&nbsp;correct&nbsp;on&nbsp;a&nbsp;type&nbsp;whose&nbsp;tail&nbsp;padding&nbsp;could&nbsp;be&nbsp;reused,&nbsp;and&nbsp;second,&nbsp;we&nbsp;assume&nbsp;that&nbsp;we&nbsp;can&nbsp;memcpy&nbsp;a&nbsp;trivially-copyable&nbsp;base&nbsp;class&nbsp;at&nbsp;its&nbsp;full&nbsp;size&nbsp;--&nbsp;effectively,&nbsp;we&nbsp;seem&nbsp;to&nbsp;assume&nbsp;that&nbsp;we&nbsp;won&#39;t&nbsp;initialize&nbsp;the&nbsp;tail&nbsp;padding&nbsp;of&nbsp;a&nbsp;base&nbsp;class&nbsp;before&nbsp;we&nbsp;initialize&nbsp;the&nbsp;base&nbsp;class&nbsp;itself.)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;At&nbsp;this&nbsp;point&nbsp;I&#39;m&nbsp;questioning&nbsp;the&nbsp;wisdom&nbsp;of&nbsp;allowing&nbsp;a&nbsp;virtual&nbsp;base&nbsp;to&nbsp;be&nbsp;allocated&nbsp;into&nbsp;tail&nbsp;padding.&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
