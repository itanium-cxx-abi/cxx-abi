<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=us-ascii&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;Jul&nbsp;21,&nbsp;2016,&nbsp;at&nbsp;1:31&nbsp;PM,&nbsp;Richard&nbsp;Smith&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:richardsmith@googlers.com&quot;&nbsp;class=&quot;&quot;&gt;richardsmith@googlers.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;21&nbsp;July&nbsp;2016&nbsp;at&nbsp;13:20,&nbsp;Jason&nbsp;Merrill&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:jason@redhat.com&quot;&nbsp;target=&quot;_blank&quot;&nbsp;class=&quot;&quot;&gt;jason@redhat.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;Thu,&nbsp;Jul&nbsp;21,&nbsp;2016&nbsp;at&nbsp;2:45&nbsp;PM,&nbsp;Richard&nbsp;Smith&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;&lt;a&nbsp;href=&quot;mailto:richardsmith@googlers.com&quot;&nbsp;class=&quot;&quot;&gt;richardsmith@googlers.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;On&nbsp;21&nbsp;July&nbsp;2016&nbsp;at&nbsp;11:02,&nbsp;Jason&nbsp;Merrill&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:jason@redhat.com&quot;&nbsp;class=&quot;&quot;&gt;jason@redhat.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&gt;&nbsp;P0135&nbsp;seems&nbsp;to&nbsp;require&nbsp;that&nbsp;we&nbsp;elide&nbsp;the&nbsp;copy&nbsp;when&nbsp;using&nbsp;the&nbsp;result&nbsp;of&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&gt;&nbsp;a&nbsp;function&nbsp;returning&nbsp;by&nbsp;value&nbsp;to&nbsp;initialize&nbsp;a&nbsp;base&nbsp;class&nbsp;subobject,&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&gt;&nbsp;but&nbsp;the&nbsp;ABI&nbsp;doesn't&nbsp;currently&nbsp;require&nbsp;that&nbsp;such&nbsp;a&nbsp;function&nbsp;avoid&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&gt;&nbsp;clobbering&nbsp;tail&nbsp;padding&nbsp;when&nbsp;initializing&nbsp;its&nbsp;return&nbsp;object.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&gt;&nbsp;Thoughts?&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;If&nbsp;the&nbsp;function&nbsp;clobbers&nbsp;the&nbsp;tail&nbsp;padding&nbsp;of&nbsp;its&nbsp;return&nbsp;object,&nbsp;at&nbsp;least&nbsp;GCC&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;and&nbsp;Clang&nbsp;will&nbsp;miscompile&nbsp;the&nbsp;program&nbsp;today,&nbsp;without&nbsp;P0135:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;#include&nbsp;&lt;string.h&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;struct&nbsp;X&nbsp;{&nbsp;~X()&nbsp;{}&nbsp;int&nbsp;n;&nbsp;char&nbsp;d;&nbsp;};&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;struct&nbsp;Y&nbsp;{&nbsp;Y();&nbsp;char&nbsp;c[3];&nbsp;};&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;struct&nbsp;Z&nbsp;:&nbsp;X,&nbsp;virtual&nbsp;Y&nbsp;{&nbsp;Z();&nbsp;};&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;X&nbsp;f()&nbsp;{&nbsp;X&nbsp;nrvo;&nbsp;memset(&amp;nrvo,&nbsp;0,&nbsp;sizeof(X));&nbsp;return&nbsp;nrvo;&nbsp;}&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;Z::Z()&nbsp;:&nbsp;Y(),&nbsp;X(f())&nbsp;{}&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;Y::Y()&nbsp;:&nbsp;c{1,&nbsp;2,&nbsp;3}&nbsp;{}&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;int&nbsp;main()&nbsp;{&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;Z&nbsp;z;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;return&nbsp;z.c[0];&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;}&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;GCC&nbsp;-O0&nbsp;returns&nbsp;1&nbsp;from&nbsp;main,&nbsp;as&nbsp;it&nbsp;should.&nbsp;GCC&nbsp;-O2&nbsp;and&nbsp;Clang&nbsp;(any&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;optimization&nbsp;level,&nbsp;even&nbsp;with&nbsp;-fno-elide-constructors)&nbsp;returns&nbsp;0.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/span&gt;Thanks&nbsp;for&nbsp;the&nbsp;testcase.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;(It&nbsp;looks&nbsp;like&nbsp;Clang&nbsp;gets&nbsp;this&nbsp;&quot;wrong&quot;&nbsp;in&nbsp;two&nbsp;ways:&nbsp;first,&nbsp;NRVO&nbsp;is&nbsp;apprently&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;never&nbsp;correct&nbsp;on&nbsp;a&nbsp;type&nbsp;whose&nbsp;tail&nbsp;padding&nbsp;could&nbsp;be&nbsp;reused&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/span&gt;Hmm,&nbsp;I&nbsp;was&nbsp;thinking&nbsp;that&nbsp;the&nbsp;NRVO&nbsp;was&nbsp;fine,&nbsp;but&nbsp;the&nbsp;caller&nbsp;shouldn't&lt;br&nbsp;class=&quot;&quot;&gt;<br>
elide&nbsp;the&nbsp;copy&nbsp;because&nbsp;the&nbsp;function&nbsp;might&nbsp;clobber&nbsp;tail&nbsp;padding.&nbsp;&nbsp;But&lt;br&nbsp;class=&quot;&quot;&gt;<br>
that&nbsp;gets&nbsp;back&nbsp;to&nbsp;my&nbsp;initial&nbsp;question,&nbsp;since&nbsp;P0135&nbsp;requires&nbsp;that&lt;br&nbsp;class=&quot;&quot;&gt;<br>
elision.&nbsp;&nbsp;Avoiding&nbsp;NRVO&nbsp;here&nbsp;doesn't&nbsp;conflict&nbsp;with&nbsp;P0135,&nbsp;but&nbsp;it&nbsp;does&lt;br&nbsp;class=&quot;&quot;&gt;<br>
create&nbsp;a&nbsp;new&nbsp;ABI&nbsp;requirement&nbsp;that&nbsp;existing&nbsp;code&nbsp;might&nbsp;violate.&lt;/blockquote&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Given&nbsp;John's&nbsp;observation&nbsp;that&nbsp;P0135&nbsp;can't&nbsp;even&nbsp;work&nbsp;in&nbsp;theory&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;a&nbsp;base&nbsp;class&nbsp;with&nbsp;virtual&nbsp;bases,&nbsp;it&nbsp;seems&nbsp;like&nbsp;disabling&nbsp;P0135&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;initializing&nbsp;a&nbsp;base&nbsp;class&nbsp;of&nbsp;a&nbsp;class&nbsp;with&nbsp;vbases&nbsp;may&nbsp;be&nbsp;the&nbsp;simplest&nbsp;way&nbsp;forward.&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;We&nbsp;re-use&nbsp;tail&nbsp;padding&nbsp;of&nbsp;all&nbsp;bases,&nbsp;not&nbsp;just&nbsp;virtual&nbsp;bases.&nbsp;&nbsp;It's&nbsp;true&nbsp;that&nbsp;the&nbsp;Itanium&nbsp;ABI&nbsp;generally&nbsp;initializes&nbsp;things&nbsp;in&nbsp;ascending&nbsp;address&nbsp;order,&nbsp;but&nbsp;there&nbsp;are&nbsp;*two*&nbsp;exceptions.&nbsp;&nbsp;The&nbsp;first,&nbsp;as&nbsp;you've&nbsp;noted,&nbsp;is&nbsp;virtual&nbsp;bases.&nbsp;&nbsp;The&nbsp;second&nbsp;is&nbsp;when&nbsp;the&nbsp;primary&nbsp;base&nbsp;class&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;base&nbsp;class&nbsp;in&nbsp;inheritance&nbsp;order:&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;A&nbsp;{&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;c;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A()&nbsp;:&nbsp;c(15)&nbsp;{}&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;};&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;B&nbsp;{&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;virtual&nbsp;void&nbsp;foo()&nbsp;{}&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;d;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;};&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;C&nbsp;:&nbsp;A,&nbsp;B&nbsp;{};&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;main()&nbsp;{&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C&nbsp;c;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Here&nbsp;the&nbsp;'A'&nbsp;base&nbsp;is&nbsp;allocated&nbsp;in&nbsp;the&nbsp;tail&nbsp;padding&nbsp;of&nbsp;the&nbsp;'B'&nbsp;base.&nbsp;&nbsp;Now,&nbsp;'B'&nbsp;is&nbsp;not&nbsp;technically&nbsp;trivially-copyable,&nbsp;but...&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Also,&nbsp;it's&nbsp;a&nbsp;big&nbsp;world,&nbsp;and&nbsp;other/alternative/future&nbsp;ABIs&nbsp;might&nbsp;want&nbsp;to&nbsp;do&nbsp;all&nbsp;sorts&nbsp;of&nbsp;things.&nbsp;&nbsp;It's&nbsp;also&nbsp;not&nbsp;that&nbsp;hard&nbsp;to&nbsp;imagine&nbsp;future&nbsp;language&nbsp;features&nbsp;that&nbsp;would&nbsp;rely&nbsp;on&nbsp;knowing&nbsp;whether&nbsp;a&nbsp;constructor&nbsp;is&nbsp;initializing&nbsp;a&nbsp;base&nbsp;sub-object&nbsp;or&nbsp;a&nbsp;complete&nbsp;object&nbsp;(for&nbsp;example,&nbsp;the&nbsp;language&nbsp;could&nbsp;provide&nbsp;a&nbsp;way&nbsp;to&nbsp;declare&nbsp;constructors&nbsp;that&nbsp;are&nbsp;only&nbsp;allowed&nbsp;to&nbsp;initialize&nbsp;one&nbsp;or&nbsp;the&nbsp;other).&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;seems&nbsp;to&nbsp;me&nbsp;that&nbsp;the&nbsp;maximally&nbsp;correct&nbsp;thing&nbsp;is&nbsp;to&nbsp;disable&nbsp;the&nbsp;P0135&nbsp;mandate&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;initializing&nbsp;a&nbsp;base&nbsp;sub-object,&nbsp;full&nbsp;stop.&nbsp;&nbsp;If&nbsp;we&nbsp;can&nbsp;define&nbsp;conditions&nbsp;in&nbsp;which&nbsp;it's&nbsp;acceptable&nbsp;to&nbsp;elide&nbsp;the&nbsp;copy,&nbsp;great,&nbsp;but&nbsp;that&nbsp;should&nbsp;be&nbsp;up&nbsp;to&nbsp;the&nbsp;implementation&nbsp;/&nbsp;ABI.&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;(Semantic&nbsp;features&nbsp;like&nbsp;base-only&nbsp;constructors&nbsp;wouldn't&nbsp;prevent&nbsp;us&nbsp;from&nbsp;doing&nbsp;this&nbsp;best-effort&nbsp;today&nbsp;because&nbsp;adding&nbsp;one&nbsp;to&nbsp;an&nbsp;existing&nbsp;type&nbsp;is&nbsp;an&nbsp;ODR&nbsp;violation&nbsp;anyway.&nbsp;&nbsp;We&nbsp;could&nbsp;easily&nbsp;adjust&nbsp;the&nbsp;ABI&nbsp;rule&nbsp;to&nbsp;disable&nbsp;in-place&nbsp;copy&nbsp;elision&nbsp;into&nbsp;base&nbsp;subobjects&nbsp;when&nbsp;the&nbsp;chosen&nbsp;copy&nbsp;constructor&nbsp;is&nbsp;base-only&nbsp;or&nbsp;something.)&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;John.&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
