<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;div&gt;&lt;div&gt;On&nbsp;Feb&nbsp;2,&nbsp;2011,&nbsp;at&nbsp;3:35&nbsp;PM,&nbsp;Michael&nbsp;Wong&nbsp;wrote:&lt;/div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&gt;&lt;p&gt;Hi,&nbsp;I&nbsp;wonder&nbsp;if&nbsp;Nathan&nbsp;Sidwell,&nbsp;Mark&nbsp;Michell&nbsp;or&nbsp;others&nbsp;can&nbsp;comment&nbsp;on&nbsp;the&nbsp;feasibility&nbsp;of&nbsp;these&nbsp;2&nbsp;enhancement&nbsp;choices&nbsp;to&nbsp;enable&nbsp;copyable&nbsp;exception&nbsp;objects.&lt;br&gt;<br>
A&nbsp;solution&nbsp;to&nbsp;this&nbsp;is&nbsp;required&nbsp;by&nbsp;C++0x&nbsp;LWG&nbsp;issue&nbsp;1369&nbsp;which&nbsp;is&nbsp;in&nbsp;review&nbsp;status&nbsp;now:&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lwg.github.com/issues/lwg-active.html#1369&quot;&gt;http://lwg.github.com/issues/lwg-active.html#1369&lt;/a&gt;&lt;br&gt;&lt;/p&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;I'm&nbsp;generally&nbsp;skeptical&nbsp;of&nbsp;the&nbsp;original&nbsp;language&nbsp;proposal,&nbsp;the&nbsp;allowance&nbsp;of&nbsp;&quot;forking&quot;&nbsp;rethrows,&nbsp;and&nbsp;the&nbsp;effort&nbsp;to&nbsp;impose&nbsp;these&nbsp;specific&nbsp;semantics&nbsp;retroactively&nbsp;onto&nbsp;the&nbsp;Itanium&nbsp;ABI,&nbsp;but&nbsp;this&nbsp;isn't&nbsp;the&nbsp;forum&nbsp;for&nbsp;that,&nbsp;so&nbsp;I'll&nbsp;try&nbsp;to&nbsp;limit&nbsp;my&nbsp;comments&nbsp;to&nbsp;technical&nbsp;aspects&nbsp;of&nbsp;the&nbsp;concrete&nbsp;proposals.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Proposal&nbsp;1&nbsp;(RTTI&nbsp;enhancement).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Adding&nbsp;a&nbsp;virtual&nbsp;method&nbsp;to&nbsp;RTTI&nbsp;objects&nbsp;is&nbsp;a&nbsp;non-starter.&nbsp;&nbsp;This&nbsp;method&nbsp;would&nbsp;need&nbsp;to&nbsp;overridden&nbsp;in&nbsp;every&nbsp;class&nbsp;with&nbsp;a&nbsp;public&nbsp;non-trivial&nbsp;copy&nbsp;constructor;&nbsp;&nbsp;that&nbsp;in&nbsp;turn&nbsp;requires&nbsp;all&nbsp;these&nbsp;RTTI&nbsp;objects&nbsp;to&nbsp;have&nbsp;custom&nbsp;classes.&nbsp;&nbsp;That's&nbsp;a&nbsp;huge&nbsp;explosion&nbsp;in&nbsp;the&nbsp;amount&nbsp;of&nbsp;type&nbsp;metadata&nbsp;required.&nbsp;&nbsp;It&nbsp;also&nbsp;forces&nbsp;compilers&nbsp;to&nbsp;hard-code&nbsp;a&nbsp;lot&nbsp;of&nbsp;information&nbsp;about&nbsp;the&nbsp;vtables&nbsp;in&nbsp;std::type_info's&nbsp;type&nbsp;hierarchy.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;There's&nbsp;a&nbsp;fix&nbsp;to&nbsp;this,&nbsp;which&nbsp;is&nbsp;to&nbsp;make&nbsp;this&nbsp;a&nbsp;function&nbsp;pointer&nbsp;in&nbsp;the&nbsp;RTTI&nbsp;object&nbsp;instead.&nbsp;&nbsp;The&nbsp;signature&nbsp;should&nbsp;also&nbsp;be&nbsp;adjusted&nbsp;so&nbsp;that,&nbsp;in&nbsp;the&nbsp;extremely&nbsp;common&nbsp;case&nbsp;of&nbsp;a&nbsp;copy&nbsp;ctor&nbsp;without&nbsp;default&nbsp;arguments,&nbsp;we&nbsp;can&nbsp;just&nbsp;initialize&nbsp;this&nbsp;with&nbsp;the&nbsp;address&nbsp;of&nbsp;the&nbsp;copy&nbsp;ctor.&nbsp;&nbsp;So&nbsp;the&nbsp;workable&nbsp;proposal&nbsp;is&nbsp;to&nbsp;add&nbsp;three&nbsp;new&nbsp;type_info&nbsp;subclasses&nbsp;with&nbsp;two&nbsp;new&nbsp;subclasses:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;size_t&nbsp;__object_size;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;void&nbsp;(*__copy_construct)(void&nbsp;*__dest,&nbsp;void&nbsp;*__src);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Note&nbsp;that&nbsp;there&nbsp;are&nbsp;derived&nbsp;ABIs,&nbsp;like&nbsp;the&nbsp;ARM&nbsp;C++&nbsp;ABI,&nbsp;where&nbsp;constructors&nbsp;don't&nbsp;return&nbsp;void.&nbsp;&nbsp;Either&nbsp;we'd&nbsp;have&nbsp;to&nbsp;ignore&nbsp;that&nbsp;—&nbsp;and&nbsp;I&nbsp;don't&nbsp;know&nbsp;of&nbsp;any&nbsp;architectures&nbsp;where&nbsp;it's&nbsp;unsafe&nbsp;to&nbsp;do&nbsp;so&nbsp;—&nbsp;or&nbsp;the&nbsp;type&nbsp;of&nbsp;this&nbsp;field&nbsp;would&nbsp;not&nbsp;be&nbsp;portable.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;proposal&nbsp;would&nbsp;require&nbsp;us&nbsp;to&nbsp;instantiate&nbsp;and&nbsp;emit&nbsp;the&nbsp;copy&nbsp;constructor&nbsp;of&nbsp;every&nbsp;class&nbsp;we&nbsp;emit&nbsp;RTTI&nbsp;for.&nbsp;&nbsp;This&nbsp;is&nbsp;actually&nbsp;prohibited&nbsp;by&nbsp;the&nbsp;current&nbsp;language&nbsp;spec,&nbsp;so&nbsp;we'd&nbsp;need&nbsp;language&nbsp;sanction&nbsp;for&nbsp;this.&nbsp;&nbsp;This&nbsp;is&nbsp;also&nbsp;a&nbsp;potentially&nbsp;significant&nbsp;code-size&nbsp;and&nbsp;compile-time&nbsp;issue.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Proposal&nbsp;2&nbsp;(prepending&nbsp;fields&nbsp;to&nbsp;the&nbsp;exception&nbsp;data).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;think&nbsp;this&nbsp;is&nbsp;a&nbsp;somewhat&nbsp;more&nbsp;elegant&nbsp;implementation&nbsp;choice,&nbsp;particularly&nbsp;since&nbsp;the&nbsp;original&nbsp;design&nbsp;was&nbsp;intended&nbsp;to&nbsp;be&nbsp;extended&nbsp;in&nbsp;this&nbsp;way,&nbsp;and&nbsp;it's&nbsp;been&nbsp;done&nbsp;before&nbsp;on&nbsp;some&nbsp;major&nbsp;platforms&nbsp;(in&nbsp;service&nbsp;of&nbsp;std::rethrow_exception,&nbsp;in&nbsp;fact).&nbsp;&nbsp;IIRC,&nbsp;there&nbsp;exist&nbsp;(or&nbsp;at&nbsp;least&nbsp;there&nbsp;did&nbsp;exist)&nbsp;programs&nbsp;which&nbsp;rely&nbsp;on&nbsp;an&nbsp;exact&nbsp;size&nbsp;for&nbsp;the&nbsp;exception&nbsp;data,&nbsp;but&nbsp;I&nbsp;don't&nbsp;recall&nbsp;which&nbsp;and&nbsp;whether&nbsp;they've&nbsp;been&nbsp;fixed.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We'd&nbsp;need&nbsp;a&nbsp;new&nbsp;__cxa_throw&nbsp;variant&nbsp;called&nbsp;something&nbsp;like&nbsp;__cxa_throw_copyable.&nbsp;&nbsp;I&nbsp;presume&nbsp;that&nbsp;throwing&nbsp;a&nbsp;trivially-copyable&nbsp;class&nbsp;would&nbsp;pass&nbsp;a&nbsp;null&nbsp;copy-ctor&nbsp;to&nbsp;the&nbsp;new&nbsp;variant,&nbsp;whereas&nbsp;throwing&nbsp;a&nbsp;class&nbsp;with&nbsp;an&nbsp;inaccessible&nbsp;or&nbsp;deleted&nbsp;copy&nbsp;ctor&nbsp;would&nbsp;just&nbsp;use&nbsp;__cxa_throw.&nbsp;&nbsp;Code&nbsp;throwing&nbsp;a&nbsp;non-class&nbsp;would&nbsp;still&nbsp;be&nbsp;allowed&nbsp;to&nbsp;throw&nbsp;with&nbsp;__cxa_throw,&nbsp;and&nbsp;std::rethrow_exception&nbsp;would&nbsp;just&nbsp;have&nbsp;to&nbsp;look&nbsp;for&nbsp;such&nbsp;types&nbsp;and&nbsp;DTRT.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Under&nbsp;either&nbsp;proposal,&nbsp;the&nbsp;C++0x&nbsp;standard&nbsp;library&nbsp;would&nbsp;need&nbsp;to&nbsp;export&nbsp;new&nbsp;symbols&nbsp;(either&nbsp;the&nbsp;new&nbsp;vtables&nbsp;or&nbsp;a&nbsp;new&nbsp;__cxa_throw&nbsp;variant)&nbsp;which&nbsp;would&nbsp;be&nbsp;used&nbsp;by&nbsp;a&nbsp;lot&nbsp;of&nbsp;code&nbsp;compiled&nbsp;for&nbsp;'0x&nbsp;regardless&nbsp;of&nbsp;whether&nbsp;that&nbsp;code&nbsp;actually&nbsp;used&nbsp;std::rethrow_exception.&nbsp;&nbsp;This&nbsp;means&nbsp;that&nbsp;programs&nbsp;compiled&nbsp;for&nbsp;'0x&nbsp;would&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;link&nbsp;against&nbsp;an&nbsp;'03&nbsp;standard&nbsp;library&nbsp;even&nbsp;if&nbsp;they&nbsp;didn't&nbsp;actually&nbsp;use&nbsp;any&nbsp;'0x&nbsp;features&nbsp;requiring&nbsp;runtime&nbsp;support,&nbsp;which&nbsp;is&nbsp;actually&nbsp;a&nbsp;pretty&nbsp;serious&nbsp;concern.&nbsp;&nbsp;It's&nbsp;a&nbsp;much&nbsp;bigger&nbsp;problem&nbsp;for&nbsp;Proposal&nbsp;1,&nbsp;where&nbsp;all&nbsp;code&nbsp;emitting&nbsp;RTTI&nbsp;for&nbsp;classes&nbsp;with&nbsp;public&nbsp;copy&nbsp;ctors&nbsp;would&nbsp;suddenly&nbsp;use&nbsp;the&nbsp;new&nbsp;symbols,&nbsp;whereas&nbsp;Proposal&nbsp;2&nbsp;would&nbsp;only&nbsp;affect&nbsp;code&nbsp;that&nbsp;actually&nbsp;contains&nbsp;throws.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;John.&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
