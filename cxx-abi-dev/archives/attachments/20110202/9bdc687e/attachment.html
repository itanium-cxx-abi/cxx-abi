<tt>
&lt;html&gt;&lt;body&gt;<br>
&lt;p&gt;Hi,&nbsp;I&nbsp;wonder&nbsp;if&nbsp;Nathan&nbsp;Sidwell,&nbsp;Mark&nbsp;Michell&nbsp;or&nbsp;others&nbsp;can&nbsp;comment&nbsp;on&nbsp;the&nbsp;feasibility&nbsp;of&nbsp;these&nbsp;2&nbsp;enhancement&nbsp;choices&nbsp;to&nbsp;enable&nbsp;copyable&nbsp;exception&nbsp;objects.&lt;br&gt;<br>
A&nbsp;solution&nbsp;to&nbsp;this&nbsp;is&nbsp;required&nbsp;by&nbsp;C++0x&nbsp;LWG&nbsp;issue&nbsp;1369&nbsp;which&nbsp;is&nbsp;in&nbsp;review&nbsp;status&nbsp;now:&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lwg.github.com/issues/lwg-active.html#1369&quot;&gt;http://lwg.github.com/issues/lwg-active.html#1369&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
We&nbsp;discussed&nbsp;this&nbsp;at&nbsp;Fermi&nbsp;Lab&nbsp;and&nbsp;one&nbsp;solution&nbsp;is&nbsp;that&nbsp;we&nbsp;need&nbsp;to&nbsp;start&nbsp;by&nbsp;requiring&nbsp;one&nbsp;of&nbsp;the&nbsp;many&nbsp;ABI's&nbsp;out&nbsp;there&nbsp;starting&nbsp;with&nbsp;the&nbsp;C++ABI.&nbsp;I&nbsp;realize&nbsp;there&nbsp;are&nbsp;other&nbsp;ABIs&nbsp;out&nbsp;there&nbsp;but&nbsp;it&nbsp;would&nbsp;be&nbsp;good&nbsp;to&nbsp;support&nbsp;&lt;br&gt;<br>
I&nbsp;like&nbsp;the&nbsp;second&nbsp;option,&nbsp;and&nbsp;it&nbsp;seems&nbsp;the&nbsp;spec&nbsp;as&nbsp;Anthony&nbsp;mention&nbsp;already&nbsp;make&nbsp;provisions&nbsp;for&nbsp;enhancing&nbsp;the&nbsp;exception&nbsp;object&nbsp;header&nbsp;in&nbsp;the&nbsp;negative&nbsp;direction,&nbsp;and&nbsp;in&nbsp;fact&nbsp;complete&nbsp;replace&nbsp;that&nbsp;header&nbsp;to&nbsp;allow&nbsp;a&nbsp;copyable&nbsp;version&nbsp;of&nbsp;the&nbsp;exception&nbsp;object.&lt;br&gt;<br>
&lt;br&gt;<br>
We&nbsp;just&nbsp;would&nbsp;like&nbsp;some&nbsp;confirmation&nbsp;that&nbsp;this&nbsp;is&nbsp;allowed&nbsp;from&nbsp;others&nbsp;who&nbsp;have&nbsp;designed&nbsp;the&nbsp;original&nbsp;C++&nbsp;ABI&nbsp;exception.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Regards,&nbsp;Michael&lt;br&gt;<br>
&lt;br&gt;<br>
Rational&nbsp;C/C++&nbsp;cafe:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://www.ibm.com/software/rational/cafe/community/ccpp&quot;&gt;http://www.ibm.com/software/rational/cafe/community/ccpp&lt;/a&gt;&lt;br&gt;<br>
My&nbsp;Blogs:&nbsp;&lt;br&gt;<br>
Parallel&nbsp;&amp;&nbsp;Multi-Core&nbsp;Computing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://www.ibm.com/software/rational/cafe/blogs/ccpp-parallel-multicore&quot;&gt;http://www.ibm.com/software/rational/cafe/blogs/ccpp-parallel-multicore&lt;/a&gt;&lt;br&gt;<br>
C++&nbsp;Language&nbsp;&amp;&nbsp;Standard&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://www.ibm.com/software/rational/cafe/blogs/cpp-standard&quot;&gt;http://www.ibm.com/software/rational/cafe/blogs/cpp-standard&lt;/a&gt;&lt;br&gt;<br>
Commercial&nbsp;Computing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://www.ibm.com/software/rational/cafe/blogs/ccpp-commercial&quot;&gt;http://www.ibm.com/software/rational/cafe/blogs/ccpp-commercial&lt;/a&gt;&lt;br&gt;<br>
Boost&nbsp;test&nbsp;results&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://www.ibm.com/support/docview.wss?rs=2239&amp;context=SSJT9L&amp;uid=swg27006911&quot;&gt;http://www.ibm.com/support/docview.wss?rs=2239&amp;context=SSJT9L&amp;uid=swg27006911&lt;/a&gt;&lt;br&gt;<br>
C/C++&nbsp;Compilers&nbsp;Support&nbsp;Page&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://www.ibm.com/software/awdtools/ccompilers/support/&quot;&gt;http://www.ibm.com/software/awdtools/ccompilers/support/&lt;/a&gt;&lt;br&gt;<br>
C/C++&nbsp;Feature&nbsp;Request&nbsp;Interface&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://www.ibm.com/support/docview.wss?uid=swg27005811&quot;&gt;http://www.ibm.com/support/docview.wss?uid=swg27005811&lt;/a&gt;&lt;br&gt;<br>
XL&nbsp;Fortran&nbsp;Compiler&nbsp;Support&nbsp;Page&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://www.ibm.com/software/awdtools/fortran/xlfortran/support/&quot;&gt;http://www.ibm.com/software/awdtools/fortran/xlfortran/support/&lt;/a&gt;&lt;br&gt;<br>
XL&nbsp;Fortran&nbsp;Feature&nbsp;Request&nbsp;Interface&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://www.ibm.com/support/docview.wss?uid=swg27005812&quot;&gt;http://www.ibm.com/support/docview.wss?uid=swg27005812&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Michael&nbsp;Wong&lt;br&gt;<br>
XL&nbsp;C++&nbsp;Compiler&nbsp;kernel&nbsp;Development&lt;br&gt;<br>
IBM&nbsp;Canada&nbsp;Ltd.,&nbsp;C2/KD2/8200/MKM&lt;br&gt;<br>
8200&nbsp;Warden&nbsp;Avenue&lt;br&gt;<br>
Markham,&nbsp;Ontario&nbsp;&nbsp;L6G&nbsp;1C7&lt;br&gt;<br>
W:905-413-3283&nbsp;F:905-413-4839&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;tt&gt;Anthony&nbsp;Williams&nbsp;&lt;anthony@justsoftwaresolutions.co.uk&gt;&nbsp;wrote&nbsp;on&nbsp;11/17/2010&nbsp;03:32:59&nbsp;AM:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;[image&nbsp;removed]&nbsp;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;[cxx-abi-dev]&nbsp;C++0x&nbsp;std::rethrow_exception,&nbsp;data&nbsp;races&nbsp;and&nbsp;the&nbsp;Itanium&nbsp;ABI&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Anthony&nbsp;Williams&nbsp;&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;to:&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;cxx-abi-dev&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;11/17/2010&nbsp;04:05&nbsp;AM&lt;/tt&gt;&lt;br&gt;<br>
&lt;tt&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Hi,&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;With&nbsp;the&nbsp;current&nbsp;draft&nbsp;of&nbsp;the&nbsp;upcoming&nbsp;C++0x&nbsp;standard,&nbsp;it&nbsp;is&nbsp;unclear&nbsp;&lt;br&gt;<br>
&gt;&nbsp;whether&nbsp;the&nbsp;exception&nbsp;thrown&nbsp;by&nbsp;std::rethrow_exception&nbsp;is&nbsp;the&nbsp;same&nbsp;&lt;br&gt;<br>
&gt;&nbsp;exception&nbsp;object&nbsp;that&nbsp;was&nbsp;originally&nbsp;thrown,&nbsp;or&nbsp;a&nbsp;copy&nbsp;thereof.&nbsp;Indeed,&nbsp;&lt;br&gt;<br>
&gt;&nbsp;different&nbsp;implementations&nbsp;do&nbsp;different&nbsp;things:&nbsp;gcc&nbsp;rethrows&nbsp;the&nbsp;same&nbsp;&lt;br&gt;<br>
&gt;&nbsp;exception&nbsp;object,&nbsp;and&nbsp;MSVC2010&nbsp;throws&nbsp;a&nbsp;copy.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;believe&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;mistake;&nbsp;std::rethrow_exception&nbsp;should&nbsp;always&nbsp;&lt;br&gt;<br>
&gt;&nbsp;throw&nbsp;a&nbsp;copy.&nbsp;If&nbsp;it&nbsp;rethrows&nbsp;the&nbsp;same&nbsp;exception&nbsp;then&nbsp;the&nbsp;same&nbsp;exception&nbsp;&lt;br&gt;<br>
&gt;&nbsp;object&nbsp;may&nbsp;now&nbsp;become&nbsp;active&nbsp;in&nbsp;multiple&nbsp;threads.&nbsp;This&nbsp;then&nbsp;exposes&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&nbsp;**handlers**&nbsp;to&nbsp;data&nbsp;races&nbsp;should&nbsp;they&nbsp;catch&nbsp;by&nbsp;reference&nbsp;and&nbsp;call&nbsp;any&nbsp;&lt;br&gt;<br>
&gt;&nbsp;member&nbsp;functions&nbsp;that&nbsp;modify&nbsp;the&nbsp;exception&nbsp;object.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;One&nbsp;use&nbsp;case&nbsp;I&nbsp;have&nbsp;seen&nbsp;for&nbsp;this&nbsp;is&nbsp;to&nbsp;add&nbsp;call&nbsp;stack&nbsp;information&nbsp;to&nbsp;an&nbsp;&lt;br&gt;<br>
&gt;&nbsp;exception&nbsp;for&nbsp;logging&nbsp;purposes.&nbsp;e.g.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;void&nbsp;g();&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;struct&nbsp;my_exception&lt;br&gt;<br>
&gt;&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;add_caller(std::string&nbsp;const&amp;&nbsp;function_name,int&nbsp;arg1,int&nbsp;arg2);&lt;br&gt;<br>
&gt;&nbsp;};&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;void&nbsp;f(int&nbsp;arg1,int&nbsp;arg2){&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g();&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch(my_exception&amp;&nbsp;e)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.add_caller(&quot;f(int,int)&quot;,arg1,arg2);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Under&nbsp;C++03,&nbsp;any&nbsp;exception&nbsp;thrown&nbsp;by&nbsp;g()&nbsp;must&nbsp;originate&nbsp;in&nbsp;this&nbsp;thread,&nbsp;&lt;br&gt;<br>
&gt;&nbsp;so&nbsp;there&nbsp;is&nbsp;no&nbsp;possibility&nbsp;of&nbsp;a&nbsp;data&nbsp;race&nbsp;in&nbsp;f().&nbsp;Under&nbsp;C++0x&nbsp;we&nbsp;must&nbsp;&lt;br&gt;<br>
&gt;&nbsp;contend&nbsp;with&nbsp;the&nbsp;possibility&nbsp;that&nbsp;the&nbsp;exception&nbsp;originated&nbsp;in&nbsp;another&nbsp;&lt;br&gt;<br>
&gt;&nbsp;thread.&nbsp;e.g.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;std::mutex&nbsp;m;&lt;br&gt;<br>
&gt;&nbsp;std::exception_ptr&nbsp;ep;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;void&nbsp;g()&lt;br&gt;<br>
&gt;&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::lock_guard&lt;std::mutex&gt;&nbsp;lk(m);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(ep)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::rethrow_exception(ep);&lt;br&gt;<br>
&gt;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;If&nbsp;multiple&nbsp;threads&nbsp;call&nbsp;g()&nbsp;they&nbsp;may&nbsp;thus&nbsp;each&nbsp;rethrow&nbsp;the&nbsp;same&nbsp;&lt;br&gt;<br>
&gt;&nbsp;exception.&nbsp;If&nbsp;this&nbsp;truly&nbsp;is&nbsp;the&nbsp;**same**&nbsp;exception&nbsp;object&nbsp;(and&nbsp;not&nbsp;a&nbsp;&lt;br&gt;<br>
&gt;&nbsp;copy)&nbsp;then&nbsp;callers&nbsp;such&nbsp;as&nbsp;f()&nbsp;have&nbsp;now&nbsp;been&nbsp;exposed&nbsp;to&nbsp;a&nbsp;data&nbsp;race,&nbsp;&lt;br&gt;<br>
&gt;&nbsp;**without&nbsp;changing&nbsp;f()**.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Also,&nbsp;under&nbsp;the&nbsp;latitude&nbsp;provided&nbsp;by&nbsp;the&nbsp;C++0x&nbsp;draft,&nbsp;this&nbsp;behaviour&nbsp;may&nbsp;&lt;br&gt;<br>
&gt;&nbsp;vary&nbsp;from&nbsp;compiler&nbsp;to&nbsp;compiler.&nbsp;I&nbsp;can&nbsp;write&nbsp;some&nbsp;code&nbsp;that&nbsp;is&nbsp;race-free&nbsp;&lt;br&gt;<br>
&gt;&nbsp;under&nbsp;MSVC2010,&nbsp;but&nbsp;if&nbsp;I&nbsp;then&nbsp;recompile&nbsp;it&nbsp;with&nbsp;gcc&nbsp;then&nbsp;I&nbsp;have&nbsp;a&nbsp;data&nbsp;&lt;br&gt;<br>
&gt;&nbsp;race,&nbsp;**without&nbsp;any&nbsp;indication&nbsp;from&nbsp;the&nbsp;compiler**.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;am&nbsp;aware&nbsp;that&nbsp;the&nbsp;reason&nbsp;for&nbsp;gcc's&nbsp;behaviour&nbsp;in&nbsp;this&nbsp;case&nbsp;is&nbsp;that&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Itanium&nbsp;ABI&nbsp;does&nbsp;not&nbsp;provide&nbsp;the&nbsp;necessary&nbsp;information&nbsp;to&nbsp;copy&nbsp;an&nbsp;&lt;br&gt;<br>
&gt;&nbsp;exception&nbsp;object,&nbsp;which&nbsp;is&nbsp;why&nbsp;I&nbsp;am&nbsp;posting&nbsp;here.&nbsp;I&nbsp;would&nbsp;like&nbsp;to&nbsp;&lt;br&gt;<br>
&gt;&nbsp;propose&nbsp;changing&nbsp;the&nbsp;Itanium&nbsp;ABI&nbsp;to&nbsp;provide&nbsp;the&nbsp;necessary&nbsp;information&nbsp;to&nbsp;&lt;br&gt;<br>
&gt;&nbsp;copy&nbsp;the&nbsp;exception&nbsp;object,&nbsp;**whilst&nbsp;remaining&nbsp;backwards&nbsp;compatible**.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Based&nbsp;on&nbsp;the&nbsp;documentation&nbsp;at&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://www.codesourcery.com/public/cxx-abi/abi.html&quot;&gt;http://www.codesourcery.com/public/cxx-abi/abi.html&lt;/a&gt;&nbsp;I&nbsp;have&nbsp;a&nbsp;couple&nbsp;of&nbsp;&lt;br&gt;<br>
&gt;&nbsp;ideas&nbsp;on&nbsp;how&nbsp;this&nbsp;could&nbsp;be&nbsp;done.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;One&nbsp;option&nbsp;I&nbsp;see&nbsp;would&nbsp;be&nbsp;to&nbsp;add&nbsp;a&nbsp;new&nbsp;class&nbsp;derived&nbsp;from&nbsp;&lt;br&gt;<br>
&gt;&nbsp;abi::__class_type_info&nbsp;that&nbsp;had&nbsp;virtual&nbsp;member&nbsp;functions&nbsp;for&nbsp;the&nbsp;size&nbsp;&lt;br&gt;<br>
&gt;&nbsp;and&nbsp;copy&nbsp;constructor:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;class&nbsp;__copyable_class_type_info:&nbsp;public&nbsp;__class_type_info&lt;br&gt;<br>
&gt;&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;public:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;__object_size;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;virtual&nbsp;void&nbsp;__copy_construct(void*&nbsp;__source,&nbsp;void*&nbsp;__dest)=0;&lt;br&gt;<br>
&gt;&nbsp;};&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;You&nbsp;would&nbsp;need&nbsp;similar&nbsp;derived&nbsp;classes&nbsp;for&nbsp;__si_class_type_info&nbsp;and&nbsp;&lt;br&gt;<br>
&gt;&nbsp;__vmi_class_type_info.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Because&nbsp;these&nbsp;are&nbsp;derived&nbsp;classes,&nbsp;they&nbsp;shouldn't&nbsp;affect&nbsp;the&nbsp;existing&nbsp;&lt;br&gt;<br>
&gt;&nbsp;ABI&nbsp;structures.&nbsp;The&nbsp;size&nbsp;of&nbsp;non-class&nbsp;types&nbsp;can&nbsp;be&nbsp;determined&nbsp;from&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&nbsp;type&nbsp;directly,&nbsp;since&nbsp;all&nbsp;pointers&nbsp;have&nbsp;the&nbsp;same&nbsp;size&nbsp;and&nbsp;fundamental&nbsp;&lt;br&gt;<br>
&gt;&nbsp;types&nbsp;have&nbsp;a&nbsp;fixed&nbsp;size&nbsp;under&nbsp;the&nbsp;ABI.&nbsp;Such&nbsp;types&nbsp;can&nbsp;also&nbsp;be&nbsp;copied&nbsp;&lt;br&gt;<br>
&gt;&nbsp;with&nbsp;memcpy().&nbsp;The&nbsp;type_info&nbsp;for&nbsp;classes&nbsp;for&nbsp;which&nbsp;there&nbsp;is&nbsp;no&nbsp;public&nbsp;&lt;br&gt;<br>
&gt;&nbsp;copy&nbsp;constructor&nbsp;would&nbsp;not&nbsp;derive&nbsp;from&nbsp;these&nbsp;new&nbsp;type-info&nbsp;classes.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;rethrow_exception&nbsp;can&nbsp;then&nbsp;check&nbsp;the&nbsp;type_info&nbsp;pointed&nbsp;to&nbsp;by&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&nbsp;exceptionType&nbsp;member&nbsp;of&nbsp;the&nbsp;__cxa_exception&nbsp;header,&nbsp;and&nbsp;either&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;(i)&nbsp;copy&nbsp;the&nbsp;exception&nbsp;with&nbsp;memcpy&nbsp;(because&nbsp;it's&nbsp;a&nbsp;fundamental&nbsp;type&nbsp;or&nbsp;&lt;br&gt;<br>
&gt;&nbsp;pointer)&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;(ii)&nbsp;throw&nbsp;bad_alloc&nbsp;because&nbsp;this&nbsp;is&nbsp;an&nbsp;exception&nbsp;that&nbsp;cannot&nbsp;therefore&nbsp;&lt;br&gt;<br>
&gt;&nbsp;be&nbsp;copied&nbsp;(i.e.&nbsp;it&nbsp;has&nbsp;no&nbsp;public&nbsp;copy&nbsp;constructor,&nbsp;or&nbsp;because&nbsp;it&nbsp;is&nbsp;from&nbsp;&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;old&nbsp;ABI)&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;(iii)&nbsp;dynamic_cast&nbsp;the&nbsp;type&nbsp;info&nbsp;to&nbsp;__copyable_class_type_info&nbsp;use&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&nbsp;new&nbsp;__object_size&nbsp;and&nbsp;__copy_construct&nbsp;virtual&nbsp;functions&nbsp;to&nbsp;clone&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&nbsp;exception&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;A&nbsp;second&nbsp;option&nbsp;is&nbsp;to&nbsp;add&nbsp;the&nbsp;size&nbsp;and&nbsp;copy&nbsp;construction&nbsp;functions&nbsp;to&nbsp;&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;__cxa_exception&nbsp;header.&nbsp;The&nbsp;ABI&nbsp;says&nbsp;&quot;By&nbsp;convention,&nbsp;a&nbsp;&lt;br&gt;<br>
&gt;&nbsp;__cxa_exception&nbsp;pointer&nbsp;points&nbsp;at&nbsp;the&nbsp;C++&nbsp;object&nbsp;representing&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&nbsp;exception&nbsp;being&nbsp;thrown,&nbsp;immediately&nbsp;following&nbsp;the&nbsp;header.&nbsp;The&nbsp;header&nbsp;&lt;br&gt;<br>
&gt;&nbsp;structure&nbsp;is&nbsp;accessed&nbsp;at&nbsp;a&nbsp;negative&nbsp;offset&nbsp;from&nbsp;the&nbsp;__cxa_exception&nbsp;&lt;br&gt;<br>
&gt;&nbsp;pointer.&nbsp;This&nbsp;layout&nbsp;allows&nbsp;consistent&nbsp;treatment&nbsp;of&nbsp;exception&nbsp;objects&nbsp;&lt;br&gt;<br>
&gt;&nbsp;from&nbsp;different&nbsp;languages&nbsp;(or&nbsp;different&nbsp;implementations&nbsp;of&nbsp;the&nbsp;same&nbsp;&lt;br&gt;<br>
&gt;&nbsp;language),&nbsp;and&nbsp;allows&nbsp;future&nbsp;extensions&nbsp;of&nbsp;the&nbsp;header&nbsp;structure&nbsp;while&nbsp;&lt;br&gt;<br>
&gt;&nbsp;maintaining&nbsp;binary&nbsp;compatibility.&nbsp;&quot;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;We&nbsp;could&nbsp;therefore&nbsp;take&nbsp;advantage&nbsp;of&nbsp;this&nbsp;leeway&nbsp;to&nbsp;&quot;extend&nbsp;the&nbsp;header&nbsp;&lt;br&gt;<br>
&gt;&nbsp;structure&nbsp;while&nbsp;maintaining&nbsp;binary&nbsp;compatibility&quot;&nbsp;to&nbsp;add&nbsp;the&nbsp;new&nbsp;size&nbsp;&lt;br&gt;<br>
&gt;&nbsp;and&nbsp;copy&nbsp;construction&nbsp;members.&nbsp;In&nbsp;this&nbsp;case,&nbsp;the&nbsp;stored&nbsp;copy&nbsp;constructor&nbsp;&lt;br&gt;<br>
&gt;&nbsp;could&nbsp;be&nbsp;NULL&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;public&nbsp;copy&nbsp;constructor&nbsp;for&nbsp;the&nbsp;class.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;In&nbsp;either&nbsp;case,&nbsp;the&nbsp;intention&nbsp;is&nbsp;that&nbsp;old&nbsp;code&nbsp;would&nbsp;work&nbsp;without&nbsp;&lt;br&gt;<br>
&gt;&nbsp;recompilation&nbsp;even&nbsp;if&nbsp;the&nbsp;library&nbsp;code&nbsp;that&nbsp;it&nbsp;called&nbsp;was&nbsp;changed&nbsp;to&nbsp;use&nbsp;&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;new&nbsp;ABI,&nbsp;and&nbsp;new&nbsp;code&nbsp;could&nbsp;take&nbsp;advantage&nbsp;of&nbsp;the&nbsp;ability&nbsp;to&nbsp;copy&nbsp;&lt;br&gt;<br>
&gt;&nbsp;exceptions&nbsp;where&nbsp;the&nbsp;exception&nbsp;was&nbsp;thrown&nbsp;from&nbsp;code&nbsp;that&nbsp;used&nbsp;the&nbsp;new&nbsp;ABI.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;What&nbsp;do&nbsp;you&nbsp;think?&nbsp;Are&nbsp;these&nbsp;options&nbsp;implementable&nbsp;in&nbsp;a&nbsp;&lt;br&gt;<br>
&gt;&nbsp;backwards-binary-compatible&nbsp;way?&nbsp;Is&nbsp;there&nbsp;an&nbsp;alternative&nbsp;implementation&nbsp;&lt;br&gt;<br>
&gt;&nbsp;option?&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Thanks,&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Anthony&lt;br&gt;<br>
&gt;&nbsp;--&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Author&nbsp;of&nbsp;C++&nbsp;Concurrency&nbsp;in&nbsp;Action&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://www.stdthread.co.uk/book/&quot;&gt;http://www.stdthread.co.uk/book/&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;just::thread&nbsp;C++0x&nbsp;thread&nbsp;library&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://www.stdthread.co.uk&quot;&gt;http://www.stdthread.co.uk&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;Just&nbsp;Software&nbsp;Solutions&nbsp;Ltd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://www.justsoftwaresolutions.co.uk&quot;&gt;http://www.justsoftwaresolutions.co.uk&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;15&nbsp;Carrallack&nbsp;Mews,&nbsp;St&nbsp;Just,&nbsp;Cornwall,&nbsp;TR19&nbsp;7UL,&nbsp;UK.&nbsp;Company&nbsp;No.&nbsp;5478976&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;/tt&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
