<tt>
&lt;HTML&gt;<br>
<br>
&lt;HEAD&gt;<br>
&lt;title&gt;C++&nbsp;ABI&nbsp;for&nbsp;IA-64:&nbsp;Data&nbsp;Layout&lt;/title&gt;<br>
<br>
&lt;link&nbsp;rel=stylesheet&nbsp;href=small-table.css&nbsp;type=&quot;text/css&quot;&gt;<br>
&lt;link&nbsp;rel=stylesheet&nbsp;href=code.css&nbsp;type=&quot;text/css&quot;&gt;<br>
<br>
&lt;hr&gt;<br>
<br>
&lt;font&nbsp;size=6&gt;&lt;i&gt;&lt;b&gt;<br>
&lt;p&gt;<br>
C++&nbsp;ABI&nbsp;for&nbsp;IA-64:&nbsp;Data&nbsp;Layout<br>
&lt;/b&gt;&lt;/i&gt;&lt;/font&gt;<br>
<br>
&lt;font&nbsp;size=-1&gt;<br>
&lt;p&gt;<br>
&lt;i&gt;Revised&nbsp;17&nbsp;August&nbsp;1999&lt;/i&gt;<br>
<br>
&lt;/center&gt;<br>
<br>
&lt;/HEAD&gt;<br>
<br>
&lt;BODY&gt;<br>
<br>
&lt;p&gt;&nbsp;&lt;hr&gt;&nbsp;&lt;p&gt;<br>
&lt;h3&gt;&nbsp;Revisions&nbsp;&lt;/h3&gt;<br>
<br>
&lt;p&gt;<br>
&lt;font&nbsp;color=blue&gt;[990811]&lt;/font&gt;<br>
Described&nbsp;member&nbsp;pointer&nbsp;representations,&nbsp;virtual&nbsp;table&nbsp;layout.<br>
<br>
&lt;p&gt;<br>
&lt;font&nbsp;color=blue&gt;[990730]&lt;/font&gt;<br>
Selected&nbsp;first&nbsp;variant&nbsp;for&nbsp;empty&nbsp;base&nbsp;allocation;&nbsp;removed&nbsp;others.<br>
<br>
<br>
&lt;p&gt;&nbsp;&lt;hr&gt;&nbsp;&lt;p&gt;<br>
&lt;h3&gt;&nbsp;General&nbsp;&lt;/h3&gt;<br>
<br>
In&nbsp;what&nbsp;follows,&nbsp;we&nbsp;define&nbsp;the&nbsp;memory&nbsp;layout&nbsp;for&nbsp;C++&nbsp;data&nbsp;objects.<br>
Specifically,&nbsp;for&nbsp;each&nbsp;type,&nbsp;we&nbsp;specify&nbsp;the&nbsp;following&nbsp;information&nbsp;about<br>
an&nbsp;object&nbsp;O&nbsp;of&nbsp;that&nbsp;type:<br>
&lt;ul&gt;<br>
&lt;li&gt;&nbsp;the&nbsp;&lt;i&gt;size&lt;/i&gt;&nbsp;of&nbsp;an&nbsp;object,&nbsp;&lt;i&gt;sizeof&lt;/i&gt;(O);<br>
&lt;li&gt;&nbsp;the&nbsp;&lt;i&gt;alignment&lt;/i&gt;&nbsp;of&nbsp;an&nbsp;object,&nbsp;&lt;i&gt;align&lt;/i&gt;(O);&nbsp;and<br>
&lt;li&gt;&nbsp;the&nbsp;&lt;i&gt;offset&lt;/i&gt;&nbsp;within&nbsp;O,&nbsp;&lt;i&gt;offset&lt;/i&gt;(C),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;each&nbsp;data&nbsp;component&nbsp;C,&nbsp;i.e.&nbsp;base&nbsp;or&nbsp;member.<br>
&lt;/ul&gt;<br>
<br>
&lt;p&gt;&nbsp;For&nbsp;purposes&nbsp;internal&nbsp;to&nbsp;the&nbsp;specification,<br>
we&nbsp;also&nbsp;specify&nbsp;the&nbsp;&lt;i&gt;data&nbsp;size&lt;/i&gt;&nbsp;of&nbsp;an&nbsp;object,&nbsp;&lt;i&gt;dsize&lt;/i&gt;(O),<br>
which&nbsp;intuitively&nbsp;is&nbsp;sizeof(O)&nbsp;minus&nbsp;the&nbsp;size&nbsp;of&nbsp;tail&nbsp;padding.<br>
<br>
&lt;p&gt;&nbsp;&lt;hr&gt;&nbsp;&lt;p&gt;<br>
&lt;h3&gt;&nbsp;Definitions&nbsp;&lt;/h3&gt;<br>
<br>
&lt;p&gt;<br>
The&nbsp;descriptions&nbsp;below&nbsp;make&nbsp;use&nbsp;of&nbsp;the&nbsp;following&nbsp;definitions:<br>
<br>
&lt;dl&gt;<br>
<br>
&lt;p&gt;<br>
&lt;dt&gt;&nbsp;&lt;i&gt;alignment&lt;/i&gt;&nbsp;of&nbsp;a&nbsp;type&nbsp;T&nbsp;(or&nbsp;object&nbsp;X)&lt;/dt&gt;<br>
&lt;dd&gt;<br>
A&nbsp;value&nbsp;A&nbsp;such&nbsp;that&nbsp;any&nbsp;object&nbsp;X&nbsp;of&nbsp;type&nbsp;T&nbsp;has&nbsp;an&nbsp;address&nbsp;satisfying<br>
the&nbsp;constraint&nbsp;that&nbsp;&amp;X&nbsp;modulo&nbsp;A&nbsp;==&nbsp;0.<br>
<br>
&lt;p&gt;<br>
&lt;dt&gt;&nbsp;&lt;i&gt;empty&nbsp;class&lt;/i&gt;&nbsp;&lt;/dt&gt;<br>
&lt;dd&gt;<br>
A&nbsp;class&nbsp;with&nbsp;no&nbsp;non-static&nbsp;data&nbsp;members,<br>
no&nbsp;virtual&nbsp;functions,&nbsp;no&nbsp;virtual&nbsp;base&nbsp;classes,<br>
and&nbsp;no&nbsp;non-empty&nbsp;non-virtual&nbsp;base&nbsp;classes.<br>
<br>
&lt;p&gt;<br>
&lt;dt&gt;&nbsp;&lt;i&gt;nearly&nbsp;empty&nbsp;class&lt;/i&gt;&nbsp;&lt;/dt&gt;<br>
&lt;dd&gt;<br>
A&nbsp;class,&nbsp;the&nbsp;objects&nbsp;of&nbsp;which&nbsp;contain&nbsp;only&nbsp;a&nbsp;Vptr.<br>
<br>
&lt;p&gt;<br>
&lt;dt&gt;&nbsp;&lt;i&gt;polymorphic&nbsp;class&lt;/i&gt;&nbsp;&lt;/dt&gt;<br>
&lt;dd&gt;<br>
A&nbsp;class&nbsp;requiring&nbsp;a&nbsp;virtual&nbsp;table&nbsp;pointer<br>
(because&nbsp;it&nbsp;or&nbsp;its&nbsp;bases&nbsp;have&nbsp;one&nbsp;or&nbsp;more&nbsp;virtual&nbsp;member&nbsp;functions&nbsp;or<br>
virtual&nbsp;base&nbsp;classes).<br>
<br>
&lt;p&gt;<br>
&lt;dt&gt;&nbsp;&lt;i&gt;primary&nbsp;base&nbsp;class&lt;/i&gt;&nbsp;&lt;/dt&gt;<br>
&lt;dd&gt;<br>
For&nbsp;a&nbsp;polymorphic&nbsp;class,<br>
the&nbsp;unique&nbsp;base&nbsp;class&nbsp;(if&nbsp;any)&nbsp;with&nbsp;which&nbsp;it&nbsp;shares&nbsp;the&nbsp;Vptr&nbsp;at&nbsp;offset&nbsp;0.<br>
<br>
&lt;/dl&gt;<br>
<br>
&lt;p&gt;&nbsp;&lt;hr&gt;&nbsp;&lt;p&gt;<br>
&lt;h3&gt;&nbsp;POD&nbsp;Data&nbsp;Types&nbsp;&lt;/h3&gt;<br>
<br>
The&nbsp;size&nbsp;and&nbsp;alignment&nbsp;of&nbsp;C&nbsp;POD&nbsp;types&nbsp;is&nbsp;as&nbsp;specified&nbsp;by&nbsp;the&nbsp;base&nbsp;(C)&nbsp;ABI.<br>
Type&nbsp;bool&nbsp;has&nbsp;size&nbsp;and&nbsp;alignment&nbsp;1.<br>
All&nbsp;of&nbsp;these&nbsp;types&nbsp;have&nbsp;data&nbsp;size&nbsp;equal&nbsp;to&nbsp;their&nbsp;size.<br>
(We&nbsp;ignore&nbsp;tail&nbsp;padding&nbsp;for&nbsp;PODs&nbsp;because&nbsp;the&nbsp;Standard&nbsp;does&nbsp;not&nbsp;allow&nbsp;us<br>
to&nbsp;use&nbsp;it&nbsp;for&nbsp;anything&nbsp;else.)<br>
<br>
<br>
&lt;p&gt;&nbsp;&lt;hr&gt;&nbsp;&lt;p&gt;<br>
&lt;a&nbsp;name=member-pointers&gt;&lt;/a&gt;<br>
&lt;h3&gt;&nbsp;Member&nbsp;Pointers&nbsp;&lt;/h3&gt;<br>
<br>
&lt;p&gt;<br>
A&nbsp;pointer&nbsp;to&nbsp;data&nbsp;member&nbsp;is&nbsp;an&nbsp;offset&nbsp;from&nbsp;the&nbsp;base<br>
address&nbsp;of&nbsp;the&nbsp;class&nbsp;object&nbsp;containing&nbsp;it,<br>
represented&nbsp;as&nbsp;a&nbsp;&lt;code&gt;ptrdiff_t&lt;/code&gt;.<br>
It&nbsp;has&nbsp;the&nbsp;size,&nbsp;data&nbsp;size,&nbsp;and&nbsp;alignment&nbsp;of&nbsp;a&nbsp;&lt;code&gt;ptrdiff_t&lt;/code&gt;.<br>
<br>
&lt;p&gt;<br>
A&nbsp;pointer&nbsp;to&nbsp;member&nbsp;function&nbsp;is&nbsp;a&nbsp;pair&nbsp;&lt;ptr,&nbsp;adj&gt;&nbsp;as&nbsp;follows:<br>
<br>
&lt;dl&gt;<br>
&lt;p&gt;<br>
&lt;dt&gt;&nbsp;&lt;code&gt;ptr&lt;/code&gt;:<br>
&lt;dd&gt;&nbsp;For&nbsp;a&nbsp;non-virtual&nbsp;function,&nbsp;this&nbsp;field&nbsp;is&nbsp;a&nbsp;simple&nbsp;function&nbsp;pointer.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Under&nbsp;current&nbsp;base&nbsp;IA-64&nbsp;psABI&nbsp;conventions,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;that&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;a&nbsp;GP/function&nbsp;address&nbsp;pair.)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;For&nbsp;a&nbsp;virtual&nbsp;function,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;is&nbsp;1&nbsp;plus&nbsp;twice&nbsp;the&nbsp;Vtable&nbsp;offset&nbsp;of&nbsp;the&nbsp;function.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;value&nbsp;zero&nbsp;is&nbsp;a&nbsp;NULL&nbsp;pointer.<br>
<br>
&lt;p&gt;<br>
&lt;dt&gt;&nbsp;&lt;code&gt;adj&lt;/code&gt;:<br>
&lt;dd&gt;&nbsp;The&nbsp;required&nbsp;adjustment&nbsp;to&nbsp;&lt;i&gt;this&lt;/i&gt;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;represented&nbsp;as&nbsp;a&nbsp;&lt;code&gt;ptrdiff_t&lt;/code&gt;.<br>
&lt;/dl&gt;<br>
<br>
&lt;p&gt;<br>
It&nbsp;has&nbsp;the&nbsp;size,&nbsp;data&nbsp;size,&nbsp;and&nbsp;alignment<br>
of&nbsp;a&nbsp;class&nbsp;containing&nbsp;those&nbsp;two&nbsp;members,&nbsp;in&nbsp;that&nbsp;order.<br>
(For&nbsp;64-bit&nbsp;IA-64,&nbsp;that&nbsp;will&nbsp;be&nbsp;16,&nbsp;16,&nbsp;and&nbsp;8&nbsp;bytes&nbsp;respectively.)<br>
<br>
<br>
<br>
&lt;p&gt;&nbsp;&lt;hr&gt;&nbsp;&lt;p&gt;<br>
&lt;a&nbsp;name=class-types&gt;&lt;/a&gt;<br>
&lt;h3&gt;&nbsp;Non-POD&nbsp;Class&nbsp;Types&nbsp;&lt;/h3&gt;<br>
<br>
For&nbsp;non-POD&nbsp;class&nbsp;types&nbsp;C,&nbsp;assume&nbsp;that&nbsp;all&nbsp;component&nbsp;types<br>
(i.e.&nbsp;base&nbsp;classes&nbsp;and&nbsp;non-static&nbsp;data&nbsp;member&nbsp;types)<br>
have&nbsp;been&nbsp;laid&nbsp;out,&nbsp;defining&nbsp;size,&nbsp;data&nbsp;size,&nbsp;and&nbsp;alignment.<br>
Layout&nbsp;(of&nbsp;type&nbsp;C)&nbsp;is&nbsp;done&nbsp;using&nbsp;the&nbsp;following&nbsp;procedure.<br>
<br>
&lt;ol&nbsp;type=I&gt;<br>
&lt;p&gt;<br>
&lt;li&gt;&nbsp;&lt;h5&gt;&nbsp;Initialization&nbsp;&lt;/h5&gt;<br>
&nbsp;&nbsp;&lt;ol&nbsp;type=1&gt;<br>
&nbsp;&nbsp;&lt;p&gt;<br>
&nbsp;&nbsp;&lt;li&gt;&nbsp;Initialize&nbsp;sizeof(C)&nbsp;to&nbsp;zero,&nbsp;align(C)&nbsp;to&nbsp;one,&nbsp;dsize(C)&nbsp;to&nbsp;zero.<br>
&nbsp;&nbsp;&lt;p&gt;<br>
&nbsp;&nbsp;&lt;li&gt;&nbsp;If&nbsp;C&nbsp;is&nbsp;a&nbsp;polymorphic&nbsp;type:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ol&nbsp;type=a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&nbsp;If&nbsp;C&nbsp;has&nbsp;a&nbsp;polymorphic&nbsp;base&nbsp;class,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attempt&nbsp;to&nbsp;choose&nbsp;a&nbsp;primary&nbsp;base&nbsp;class&nbsp;B.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;first&nbsp;non-virtual&nbsp;polymorphic&nbsp;base&nbsp;class,&nbsp;if&nbsp;any,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or&nbsp;else&nbsp;the&nbsp;first&nbsp;nearly&nbsp;empty&nbsp;virtual&nbsp;base&nbsp;class.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Allocate&nbsp;it&nbsp;at&nbsp;offset&nbsp;zero,&nbsp;and&nbsp;set<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sizeof(C)&nbsp;to&nbsp;sizeof(B),&nbsp;align(C)&nbsp;to&nbsp;align(B),&nbsp;dsize(C)&nbsp;to&nbsp;dsize(B).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&nbsp;Otherwise,&nbsp;allocate&nbsp;the&nbsp;vtable&nbsp;pointer&nbsp;for&nbsp;C&nbsp;at&nbsp;offset&nbsp;zero,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;set&nbsp;sizeof(C),&nbsp;align(C),&nbsp;and&nbsp;dsize(C)&nbsp;to&nbsp;the&nbsp;appropriate<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;values&nbsp;for&nbsp;a&nbsp;pointer&nbsp;(all&nbsp;8&nbsp;bytes&nbsp;for&nbsp;IA-64&nbsp;64-bit&nbsp;ABI).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/ol&gt;<br>
&nbsp;&nbsp;&lt;/ol&gt;<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;&nbsp;&lt;h5&gt;&nbsp;Non-Virtual-Base&nbsp;Allocation&nbsp;&lt;/h5&gt;<br>
&lt;p&gt;<br>
For&nbsp;each&nbsp;data&nbsp;component&nbsp;D&nbsp;(i.e.&nbsp;base&nbsp;or&nbsp;non-static&nbsp;data&nbsp;member)<br>
except&nbsp;virtual&nbsp;bases,<br>
first&nbsp;the&nbsp;non-virtual&nbsp;base&nbsp;classes&nbsp;in&nbsp;declaration&nbsp;order<br>
and&nbsp;then&nbsp;the&nbsp;non-static&nbsp;data&nbsp;members&nbsp;in&nbsp;declaration&nbsp;order,<br>
allocate&nbsp;as&nbsp;follows:<br>
<br>
&nbsp;&nbsp;&lt;ol&nbsp;type=1&gt;<br>
<br>
&nbsp;&nbsp;&lt;p&gt;<br>
&nbsp;&nbsp;&lt;li&gt;&nbsp;If&nbsp;D&nbsp;is&nbsp;not&nbsp;an&nbsp;empty&nbsp;base&nbsp;class,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start&nbsp;at&nbsp;offset&nbsp;dsize(C),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incremented&nbsp;if&nbsp;necessary&nbsp;to&nbsp;alignment&nbsp;align(type(D)).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Place&nbsp;D&nbsp;at&nbsp;this&nbsp;offset&nbsp;unless&nbsp;doing&nbsp;so&nbsp;would&nbsp;result&nbsp;in&nbsp;two<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;components&nbsp;(direct&nbsp;or&nbsp;indirect)&nbsp;of&nbsp;the&nbsp;same&nbsp;type&nbsp;having&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;same&nbsp;offset.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;such&nbsp;a&nbsp;component&nbsp;type&nbsp;conflict&nbsp;occurs,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;increment&nbsp;the&nbsp;candidate&nbsp;offset&nbsp;by&nbsp;align(type(D)),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;try&nbsp;again,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;repeating&nbsp;until&nbsp;success&nbsp;occurs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(which&nbsp;will&nbsp;occur&nbsp;no&nbsp;later&nbsp;than&nbsp;sizeof(C)&nbsp;incremented&nbsp;to&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;required&nbsp;alignment).<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Update&nbsp;sizeof(C)&nbsp;to&nbsp;max&nbsp;(sizeof(C),&nbsp;offset(D)+sizeof(D)).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Update&nbsp;align(C)&nbsp;to&nbsp;max&nbsp;(align(C),&nbsp;align(D)).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;D&nbsp;is&nbsp;a&nbsp;base&nbsp;class&nbsp;(not&nbsp;empty&nbsp;in&nbsp;this&nbsp;case),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;update&nbsp;dsize(C)&nbsp;to&nbsp;offset(D)+dsize(D).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;D&nbsp;is&nbsp;a&nbsp;data&nbsp;member,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;update&nbsp;dsize(C)&nbsp;to&nbsp;max&nbsp;(offset(D)+dsize(D),&nbsp;offset(D)+1).<br>
<br>
&nbsp;&nbsp;&lt;p&gt;<br>
&nbsp;&nbsp;&lt;li&gt;&nbsp;If&nbsp;D&nbsp;is&nbsp;an&nbsp;empty&nbsp;base&nbsp;class,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;its&nbsp;allocation&nbsp;is&nbsp;similar&nbsp;to&nbsp;the&nbsp;first&nbsp;case&nbsp;above,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;that&nbsp;additional&nbsp;candidate&nbsp;offsets&nbsp;are&nbsp;considered&nbsp;before<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;starting&nbsp;at&nbsp;dsize(C).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;First,&nbsp;attempt&nbsp;to&nbsp;place&nbsp;D&nbsp;at&nbsp;offset&nbsp;zero.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;unsuccessful&nbsp;(due&nbsp;to&nbsp;a&nbsp;component&nbsp;type&nbsp;conflict),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proceed&nbsp;with&nbsp;attempts&nbsp;at&nbsp;dsize(C)&nbsp;as&nbsp;for&nbsp;non-empty&nbsp;bases.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Once&nbsp;offset(D)&nbsp;has&nbsp;been&nbsp;chosen,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;update&nbsp;sizeof(C)&nbsp;to&nbsp;max&nbsp;(sizeof(C),&nbsp;offset(D)+sizeof(D)).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Note&nbsp;that&nbsp;align(D)&nbsp;is&nbsp;1,&nbsp;so&nbsp;no&nbsp;update&nbsp;of&nbsp;align(C)&nbsp;is&nbsp;needed.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Similarly,&nbsp;since&nbsp;D&nbsp;is&nbsp;an&nbsp;empty&nbsp;base&nbsp;class,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no&nbsp;update&nbsp;of&nbsp;dsize(C)&nbsp;is&nbsp;needed.<br>
<br>
&nbsp;&nbsp;&lt;/ol&gt;<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;&nbsp;&lt;h5&gt;&nbsp;Virtual&nbsp;Base&nbsp;Allocation&nbsp;&lt;/h5&gt;<br>
&lt;p&gt;<br>
Finally&nbsp;allocate&nbsp;any&nbsp;virtual&nbsp;base&nbsp;classes<br>
(except&nbsp;one&nbsp;selected&nbsp;as&nbsp;the&nbsp;primary&nbsp;base&nbsp;class&nbsp;in&nbsp;I-2a,&nbsp;if&nbsp;any)<br>
as&nbsp;we&nbsp;did&nbsp;non-virtual&nbsp;base&nbsp;classes&nbsp;in&nbsp;step&nbsp;II-1,<br>
in&nbsp;declaration&nbsp;order.<br>
Update&nbsp;sizeof(C)&nbsp;to&nbsp;max&nbsp;(sizeof(C),&nbsp;offset(D)+sizeof(D)).<br>
If&nbsp;non-empty,&nbsp;also&nbsp;update&nbsp;align(C)&nbsp;and&nbsp;dsize(C)&nbsp;as&nbsp;in&nbsp;II-1.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;&nbsp;&lt;h5&gt;&nbsp;Finalization&nbsp;&lt;/h5&gt;<br>
&lt;p&gt;<br>
Round&nbsp;sizeof(C)&nbsp;up&nbsp;to&nbsp;a&nbsp;non-zero&nbsp;multiple&nbsp;of&nbsp;align(C).<br>
<br>
&lt;/ol&gt;<br>
<br>
<br>
&lt;p&gt;&nbsp;&lt;hr&gt;&nbsp;&lt;p&gt;<br>
&lt;a&nbsp;name=vtable&gt;&lt;/a&gt;<br>
&lt;h3&gt;&nbsp;Virtual&nbsp;Table&nbsp;Layout&nbsp;&lt;/h3&gt;<br>
<br>
&lt;p&gt;<br>
&lt;h4&gt;&nbsp;General&nbsp;&lt;/h4&gt;<br>
<br>
&lt;p&gt;<br>
A&nbsp;&lt;i&gt;virtual&nbsp;table&lt;/i&gt;&nbsp;(&lt;i&gt;vtable&lt;/i&gt;)&nbsp;is&nbsp;a&nbsp;table&nbsp;of&nbsp;information&nbsp;used<br>
to&nbsp;dispatch&nbsp;virtual&nbsp;functions,<br>
to&nbsp;access&nbsp;virtual&nbsp;base&nbsp;class&nbsp;subobjects,<br>
and&nbsp;to&nbsp;access&nbsp;information&nbsp;for&nbsp;runtime&nbsp;type&nbsp;identification&nbsp;(RTTI).<br>
Each&nbsp;class&nbsp;that&nbsp;has&nbsp;virtual&nbsp;member&nbsp;functions&nbsp;or&nbsp;virtual&nbsp;bases<br>
has&nbsp;an&nbsp;associated&nbsp;set&nbsp;of&nbsp;vtables.<br>
There&nbsp;may&nbsp;be&nbsp;multiple&nbsp;vtables&nbsp;for&nbsp;a&nbsp;particular&nbsp;class,<br>
if&nbsp;it&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;base&nbsp;class&nbsp;for&nbsp;other&nbsp;classes.<br>
However,&nbsp;the&nbsp;vtable&nbsp;pointers&nbsp;within&nbsp;all&nbsp;the&nbsp;objects&nbsp;(instances)<br>
of&nbsp;a&nbsp;particular&nbsp;most-derived&nbsp;class&nbsp;point&nbsp;to&nbsp;the&nbsp;same&nbsp;set&nbsp;of&nbsp;vtables.<br>
<br>
&lt;p&gt;<br>
A&nbsp;vtable&nbsp;consists&nbsp;of&nbsp;a&nbsp;sequence&nbsp;of&nbsp;offsets,&nbsp;data&nbsp;pointers,<br>
and&nbsp;function&nbsp;pointers,&nbsp;as&nbsp;well&nbsp;as&nbsp;structures&nbsp;composed&nbsp;of&nbsp;such&nbsp;items.<br>
We&nbsp;will&nbsp;describe&nbsp;below&nbsp;the&nbsp;sequence&nbsp;of&nbsp;such&nbsp;items.<br>
Their&nbsp;offsets&nbsp;within&nbsp;the&nbsp;vtable&nbsp;are&nbsp;determined&nbsp;by&nbsp;that&nbsp;allocation<br>
sequence&nbsp;and&nbsp;the&nbsp;natural&nbsp;ABI&nbsp;size&nbsp;and&nbsp;alignment,<br>
just&nbsp;as&nbsp;a&nbsp;data&nbsp;struct&nbsp;would&nbsp;be.&nbsp;&nbsp;In&nbsp;particular:<br>
&lt;ul&gt;<br>
&lt;li&gt;&nbsp;Offsets&nbsp;are&nbsp;of&nbsp;type&nbsp;&lt;code&gt;ptrdiff_t&lt;/code&gt;&nbsp;unless&nbsp;otherwise&nbsp;stated.<br>
&lt;li&gt;&nbsp;Data&nbsp;pointers&nbsp;have&nbsp;normal&nbsp;pointer&nbsp;size&nbsp;and&nbsp;alignment.<br>
&lt;li&gt;&nbsp;Function&nbsp;pointers&nbsp;remain&nbsp;to&nbsp;be&nbsp;defined.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;One&nbsp;possibility&nbsp;is&nbsp;that&nbsp;they&nbsp;will&nbsp;be<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;function&nbsp;address,&nbsp;GP&nbsp;address&gt;&nbsp;pairs,&nbsp;with&nbsp;pointer&nbsp;alignment.<br>
&lt;/ul&gt;<br>
<br>
&lt;p&gt;<br>
In&nbsp;general,&nbsp;what&nbsp;we&nbsp;consider&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;vtable<br>
(i.e.&nbsp;the&nbsp;address&nbsp;contained&nbsp;in&nbsp;objects&nbsp;pointing&nbsp;to&nbsp;a&nbsp;vtable)<br>
may&nbsp;not&nbsp;be&nbsp;the&nbsp;beginning&nbsp;of&nbsp;the&nbsp;vtable.<br>
We&nbsp;call&nbsp;it&nbsp;the&nbsp;&lt;i&gt;address&nbsp;point&lt;/i&gt;&nbsp;of&nbsp;the&nbsp;vtable.<br>
The&nbsp;vtable&nbsp;may&nbsp;therefore&nbsp;contain&nbsp;components&nbsp;at&nbsp;either&nbsp;positive&nbsp;or<br>
negative&nbsp;offsets&nbsp;from&nbsp;its&nbsp;address&nbsp;point.<br>
<br>
&lt;p&gt;<br>
&lt;h4&gt;&nbsp;Components&nbsp;&lt;/h4&gt;<br>
<br>
&lt;p&gt;<br>
Each&nbsp;vtable&nbsp;consists&nbsp;of&nbsp;the&nbsp;following&nbsp;components:<br>
<br>
&lt;ul&gt;<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
&lt;i&gt;Base&nbsp;offsets&lt;/i&gt;&nbsp;are&nbsp;used&nbsp;to&nbsp;access<br>
the&nbsp;virtual&nbsp;bases&nbsp;of&nbsp;an&nbsp;object,<br>
or&nbsp;non-virtual&nbsp;bases&nbsp;when&nbsp;pointer&nbsp;adjustment&nbsp;is&nbsp;required<br>
for&nbsp;some&nbsp;overriden&nbsp;virtual&nbsp;function.<br>
Such&nbsp;an&nbsp;entry&nbsp;is&nbsp;a&nbsp;displacement&nbsp;to&nbsp;a&nbsp;virtual&nbsp;base&nbsp;subobject&nbsp;from&nbsp;the<br>
location&nbsp;within&nbsp;the&nbsp;object&nbsp;of&nbsp;the&nbsp;vtable&nbsp;pointer&nbsp;that&nbsp;addresses&nbsp;this&nbsp;vtable.<br>
These&nbsp;entries&nbsp;are&nbsp;only&nbsp;necessary&nbsp;if&nbsp;the&nbsp;class&nbsp;directly&nbsp;or&nbsp;indirectly<br>
inherits&nbsp;from&nbsp;virtual&nbsp;base&nbsp;classes,<br>
or&nbsp;if&nbsp;it&nbsp;overrides&nbsp;a&nbsp;virtual&nbsp;function&nbsp;defined&nbsp;in&nbsp;a&nbsp;base&nbsp;class&nbsp;and&nbsp;if<br>
adjustment&nbsp;from&nbsp;the&nbsp;base&nbsp;to&nbsp;the&nbsp;derived&nbsp;class&nbsp;is&nbsp;needed.<br>
The&nbsp;values&nbsp;can&nbsp;be&nbsp;positive&nbsp;or&nbsp;negative.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
The&nbsp;&lt;i&gt;offset&nbsp;to&nbsp;top&lt;/i&gt;&nbsp;holds&nbsp;the&nbsp;displacement&nbsp;to&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;object<br>
from&nbsp;the&nbsp;location&nbsp;within&nbsp;the&nbsp;object&nbsp;of&nbsp;the&nbsp;vtable&nbsp;pointer&nbsp;that&nbsp;addresses<br>
this&nbsp;vtable,<br>
as&nbsp;a&nbsp;&lt;code&gt;ptrdiff_t&lt;/code&gt;.<br>
A&nbsp;negative&nbsp;value&nbsp;indicates&nbsp;the&nbsp;vtable&nbsp;pointer&nbsp;is&nbsp;part&nbsp;of&nbsp;an&nbsp;embedded<br>
base&nbsp;class&nbsp;subobject;&nbsp;otherwise&nbsp;it&nbsp;is&nbsp;zero.<br>
The&nbsp;offset&nbsp;provides&nbsp;a&nbsp;way&nbsp;to&nbsp;find&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;object&nbsp;from&nbsp;any&nbsp;base<br>
subobject&nbsp;with&nbsp;a&nbsp;vtable&nbsp;pointer.<br>
This&nbsp;is&nbsp;necessary&nbsp;for&nbsp;dynamic_cast&lt;void*&gt;&nbsp;in&nbsp;particular.<br>
<br>
&lt;p&gt;<br>
The&nbsp;virtual&nbsp;pointer&nbsp;points&nbsp;to&nbsp;the&nbsp;&quot;offset&nbsp;to&nbsp;top&quot;&nbsp;field.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
The&nbsp;&lt;i&gt;typeinfo&nbsp;pointer&lt;/i&gt;&nbsp;points&nbsp;to&nbsp;the&nbsp;typeinfo&nbsp;object&nbsp;used&nbsp;for&nbsp;RTTI.<br>
All&nbsp;entries&nbsp;in&nbsp;each&nbsp;of&nbsp;the&nbsp;vtables&nbsp;for&nbsp;a&nbsp;given&nbsp;class&nbsp;point&nbsp;to&nbsp;the&nbsp;same<br>
typeinfo&nbsp;object.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
The&nbsp;&lt;i&gt;duplicate&nbsp;base&nbsp;information&nbsp;pointer&lt;/i&gt;&nbsp;points&nbsp;to&nbsp;a&nbsp;table&nbsp;used&nbsp;to<br>
perform&nbsp;runtime&nbsp;disambiguation&nbsp;of&nbsp;duplicate&nbsp;base&nbsp;classes&nbsp;for&nbsp;dynamic&nbsp;casts.<br>
The&nbsp;entries&nbsp;in&nbsp;the&nbsp;vtables&nbsp;for&nbsp;a&nbsp;given&nbsp;class&nbsp;do&nbsp;not&nbsp;necessarily<br>
all&nbsp;point&nbsp;to&nbsp;the&nbsp;same&nbsp;table&nbsp;of&nbsp;duplicate&nbsp;base&nbsp;information.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
&lt;i&gt;Virtual&nbsp;function&nbsp;pointers&lt;/i&gt;&nbsp;are&nbsp;used&nbsp;for&nbsp;virtual&nbsp;function&nbsp;dispatch.<br>
Each&nbsp;pointer&nbsp;holds&nbsp;either&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;virtual&nbsp;function&nbsp;of&nbsp;the&nbsp;class<br>
(or&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;secondary&nbsp;entry&nbsp;point&nbsp;that&nbsp;performs&nbsp;certain<br>
adjustments&nbsp;before&nbsp;transferring&nbsp;control&nbsp;to&nbsp;a&nbsp;virtual&nbsp;function.)<br>
In&nbsp;the&nbsp;case&nbsp;of&nbsp;shared&nbsp;library&nbsp;builds,<br>
a&nbsp;virtual&nbsp;function&nbsp;pointer&nbsp;entry&nbsp;contains&nbsp;a&nbsp;pair&nbsp;of&nbsp;components<br>
(each&nbsp;64&nbsp;bits&nbsp;in&nbsp;the&nbsp;64-bit&nbsp;IA-64&nbsp;ABI):<br>
the&nbsp;value&nbsp;of&nbsp;the&nbsp;target&nbsp;GP&nbsp;value&nbsp;and&nbsp;the&nbsp;actual&nbsp;function&nbsp;address.<br>
That&nbsp;is,&nbsp;rather&nbsp;than&nbsp;being&nbsp;a&nbsp;normal&nbsp;function&nbsp;pointer,<br>
which&nbsp;points&nbsp;to&nbsp;such&nbsp;a&nbsp;two-component&nbsp;descriptor,<br>
a&nbsp;virtual&nbsp;function&nbsp;pointer&nbsp;entry&nbsp;is&nbsp;the&nbsp;descriptor.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
&lt;i&gt;Base&nbsp;vtables&lt;/i&gt;&nbsp;are&nbsp;copies&nbsp;of&nbsp;the&nbsp;vtables&nbsp;for&nbsp;base&nbsp;classes&nbsp;of&nbsp;the<br>
current&nbsp;class<br>
(copies&nbsp;in&nbsp;the&nbsp;sense&nbsp;that&nbsp;they&nbsp;have&nbsp;the&nbsp;same&nbsp;layout,<br>
though&nbsp;virtual&nbsp;function&nbsp;pointers&nbsp;may&nbsp;point&nbsp;to&nbsp;overriding&nbsp;functions).<br>
<br>
&lt;/ul&gt;<br>
<br>
&lt;p&gt;<br>
&lt;h4&gt;&nbsp;Virtual&nbsp;Table&nbsp;Order&nbsp;&lt;/h4&gt;<br>
<br>
&lt;p&gt;<br>
A&nbsp;virtual&nbsp;table's&nbsp;components&nbsp;are&nbsp;laid&nbsp;out&nbsp;in&nbsp;the&nbsp;following&nbsp;order,<br>
analogous&nbsp;to&nbsp;the&nbsp;corresponding&nbsp;object&nbsp;layout.<br>
<br>
&lt;ol&gt;<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
If&nbsp;virtual&nbsp;base&nbsp;offsets&nbsp;are&nbsp;required,<br>
they&nbsp;come&nbsp;first,&nbsp;with&nbsp;ordering&nbsp;as&nbsp;defined&nbsp;in&nbsp;categories&nbsp;3&nbsp;and&nbsp;4&nbsp;below.<br>
&lt;font&nbsp;color=red&gt;&nbsp;&lt;i&gt;Question:&lt;/i&gt;<br>
Is&nbsp;the&nbsp;characterization&nbsp;of&nbsp;which&nbsp;bases&nbsp;need&nbsp;offsets&nbsp;above&nbsp;adequate?<br>
&lt;i&gt;Note:&lt;/i&gt;&nbsp;The&nbsp;non-virtual&nbsp;cases&nbsp;need&nbsp;to&nbsp;be&nbsp;reflected&nbsp;in&nbsp;the<br>
descriptions&nbsp;below&nbsp;of&nbsp;categories&nbsp;3&nbsp;and&nbsp;4.<br>
&lt;/font&gt;<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
The&nbsp;vtable&nbsp;address&nbsp;point&nbsp;points&nbsp;here,<br>
i.e.&nbsp;this&nbsp;is&nbsp;the&nbsp;address&nbsp;of&nbsp;the&nbsp;vtable&nbsp;contained&nbsp;in&nbsp;an&nbsp;object's&nbsp;vptr.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
The&nbsp;offset&nbsp;to&nbsp;top&nbsp;field&nbsp;is&nbsp;next&nbsp;(therefore&nbsp;at&nbsp;the&nbsp;vtable&nbsp;address),<br>
if&nbsp;required&nbsp;(always&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;virtual&nbsp;function&nbsp;declared&nbsp;in&nbsp;the&nbsp;class).<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
The&nbsp;typeinfo&nbsp;pointer&nbsp;field&nbsp;is&nbsp;next.<br>
It&nbsp;is&nbsp;always&nbsp;present.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
The&nbsp;duplicate&nbsp;base&nbsp;information&nbsp;pointer&nbsp;comes&nbsp;next,&nbsp;if&nbsp;required.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
Virtual&nbsp;function&nbsp;pointers&nbsp;come&nbsp;next,<br>
in&nbsp;order&nbsp;of&nbsp;declaration&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;member&nbsp;function&nbsp;in&nbsp;the&nbsp;class.<br>
They&nbsp;appear&nbsp;only&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;suitable&nbsp;entry&nbsp;in&nbsp;one&nbsp;of&nbsp;the&nbsp;base&nbsp;vtables,<br>
i.e.&nbsp;if&nbsp;the&nbsp;return&nbsp;type&nbsp;is&nbsp;overridden&nbsp;or&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;declared&nbsp;in&nbsp;a&nbsp;base.<br>
&lt;font&nbsp;color=red&gt;&nbsp;&lt;i&gt;Question:&lt;/i&gt;<br>
Is&nbsp;this&nbsp;a&nbsp;correct&nbsp;characterization?<br>
&lt;/font&gt;<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;<br>
The&nbsp;base&nbsp;vtables&nbsp;are&nbsp;last,<br>
except&nbsp;for&nbsp;the&nbsp;primary&nbsp;base&nbsp;class&nbsp;vtable,<br>
which&nbsp;is&nbsp;a&nbsp;subtable&nbsp;of&nbsp;the&nbsp;derived&nbsp;class&nbsp;vtable.<br>
They&nbsp;are&nbsp;in&nbsp;order&nbsp;of&nbsp;base&nbsp;class&nbsp;declaration,<br>
with&nbsp;the&nbsp;vtables&nbsp;for&nbsp;a&nbsp;virtual&nbsp;base&nbsp;class&nbsp;coming&nbsp;after<br>
the&nbsp;vtable&nbsp;for&nbsp;the&nbsp;first&nbsp;base&nbsp;class&nbsp;defining&nbsp;it.<br>
&lt;font&nbsp;color=red&gt;&nbsp;&lt;i&gt;Question:&lt;/i&gt;<br>
Can&nbsp;we&nbsp;just&nbsp;use&nbsp;the&nbsp;first&nbsp;vtable&nbsp;for&nbsp;the&nbsp;virtual&nbsp;base&nbsp;class&nbsp;embedded&nbsp;in<br>
another&nbsp;of&nbsp;the&nbsp;base&nbsp;vtables?<br>
&lt;/font&gt;<br>
<br>
&lt;/ol&gt;<br>
<br>
&lt;p&gt;<br>
&lt;h4&gt;&nbsp;Virtual&nbsp;Table&nbsp;Construction&nbsp;&lt;/h4&gt;<br>
<br>
&lt;p&gt;<br>
In&nbsp;this&nbsp;section,&nbsp;we&nbsp;describe&nbsp;how&nbsp;to&nbsp;construct&nbsp;the&nbsp;vtable&nbsp;for&nbsp;an&nbsp;class,<br>
given&nbsp;vtables&nbsp;for&nbsp;all&nbsp;of&nbsp;its&nbsp;base&nbsp;classes.<br>
To&nbsp;do&nbsp;so,&nbsp;we&nbsp;divide&nbsp;classes&nbsp;into&nbsp;several&nbsp;categories,<br>
based&nbsp;on&nbsp;their&nbsp;base&nbsp;class&nbsp;structure.<br>
<br>
&lt;p&gt;<br>
&lt;h5&gt;&nbsp;Category&nbsp;0:&nbsp;Trivial&nbsp;&lt;/h5&gt;<br>
<br>
Structure:<br>
&lt;ul&gt;<br>
&lt;li&gt;&nbsp;No&nbsp;inherited&nbsp;base&nbsp;classes.<br>
&lt;li&gt;&nbsp;No&nbsp;virtual&nbsp;functions.<br>
&lt;/ul&gt;<br>
<br>
&lt;p&gt;<br>
Such&nbsp;a&nbsp;class&nbsp;has&nbsp;no&nbsp;associated&nbsp;vtable,<br>
and&nbsp;its&nbsp;objects&nbsp;contain&nbsp;no&nbsp;vptr.<br>
<br>
&lt;p&gt;<br>
&lt;h5&gt;&nbsp;Category&nbsp;1:&nbsp;Leaf&nbsp;&lt;/h5&gt;<br>
<br>
Structure:<br>
&lt;ul&gt;<br>
&lt;li&gt;&nbsp;No&nbsp;inherited&nbsp;base&nbsp;classes.<br>
&lt;li&gt;&nbsp;Declares&nbsp;virtual&nbsp;functions.<br>
&lt;/ul&gt;<br>
<br>
&lt;p&gt;<br>
The&nbsp;vtable&nbsp;contains&nbsp;an&nbsp;RTTI&nbsp;field&nbsp;followed&nbsp;by&nbsp;virtual&nbsp;function&nbsp;pointers.<br>
There&nbsp;is&nbsp;one&nbsp;function&nbsp;pointer&nbsp;entry&nbsp;for&nbsp;each<br>
virtual&nbsp;function&nbsp;declared&nbsp;in&nbsp;the&nbsp;class.<br>
<br>
&lt;p&gt;<br>
&lt;h5&gt;&nbsp;Category&nbsp;2:&nbsp;Non-Virtual&nbsp;Bases&nbsp;&lt;/h5&gt;<br>
<br>
Structure:<br>
&lt;ul&gt;<br>
&lt;li&gt;&nbsp;Only&nbsp;non-virtual&nbsp;base&nbsp;classes.<br>
&lt;li&gt;&nbsp;Base&nbsp;classes&nbsp;are&nbsp;trivial&nbsp;or&nbsp;leaf&nbsp;(they&nbsp;have&nbsp;no&nbsp;base&nbsp;classes).<br>
&lt;li&gt;&nbsp;No&nbsp;adjustment&nbsp;is&nbsp;required&nbsp;in&nbsp;any&nbsp;overridden&nbsp;virtual&nbsp;functions.<br>
&lt;/ul&gt;<br>
<br>
&lt;p&gt;<br>
If&nbsp;none&nbsp;of&nbsp;the&nbsp;base&nbsp;classes&nbsp;have&nbsp;vtables,<br>
a&nbsp;vtable&nbsp;is&nbsp;constructed&nbsp;for&nbsp;the&nbsp;class<br>
according&nbsp;to&nbsp;the&nbsp;Category&nbsp;1&nbsp;rules.<br>
<br>
&lt;p&gt;<br>
Otherwise,&nbsp;the&nbsp;class&nbsp;has&nbsp;a&nbsp;vtable&nbsp;for&nbsp;each&nbsp;base&nbsp;class&nbsp;that&nbsp;has&nbsp;a&nbsp;vtable.<br>
The&nbsp;class's&nbsp;vtables&nbsp;are&nbsp;constructed&nbsp;from&nbsp;copies&nbsp;of&nbsp;the&nbsp;base&nbsp;class&nbsp;vtables.<br>
The&nbsp;entries&nbsp;are&nbsp;the&nbsp;same,&nbsp;except:<br>
<br>
&lt;ul&gt;<br>
&lt;p&gt;<br>
&lt;li&gt;&nbsp;The&nbsp;RTTI&nbsp;fields&nbsp;contain&nbsp;information&nbsp;for&nbsp;the&nbsp;class,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rather&nbsp;than&nbsp;for&nbsp;the&nbsp;base&nbsp;class.&nbsp;<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;&nbsp;The&nbsp;function&nbsp;pointer&nbsp;entries&nbsp;for&nbsp;virtual&nbsp;functions&nbsp;inherited&nbsp;from<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;base&nbsp;class&nbsp;and&nbsp;overridden&nbsp;by&nbsp;this&nbsp;class&nbsp;are&nbsp;replaced&nbsp;with&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addresses&nbsp;of&nbsp;the&nbsp;overriding&nbsp;functions<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(or&nbsp;the&nbsp;corresponding&nbsp;adjustor&nbsp;secondary&nbsp;entry&nbsp;points).<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;&nbsp;At&nbsp;negative&nbsp;offsets,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offsets&nbsp;to&nbsp;the&nbsp;base&nbsp;classes&nbsp;are&nbsp;generated&nbsp;if&nbsp;used&nbsp;by&nbsp;adjustor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;secondary&nbsp;entry&nbsp;points.&nbsp;<br>
&lt;/ul&gt;<br>
<br>
&lt;p&gt;<br>
For&nbsp;a&nbsp;base&nbsp;class&nbsp;&lt;code&gt;Base&lt;/code&gt;,<br>
and&nbsp;a&nbsp;derived&nbsp;class&nbsp;&lt;code&gt;Derived&lt;/code&gt;&nbsp;for&nbsp;which&nbsp;we&nbsp;are&nbsp;constructing<br>
this&nbsp;set&nbsp;of&nbsp;vtables,<br>
we&nbsp;shall&nbsp;refer&nbsp;to&nbsp;the&nbsp;vtable&nbsp;for&nbsp;&lt;code&gt;Base&lt;/code&gt;&nbsp;as<br>
&lt;code&gt;Base-in-Derived&lt;/code&gt;.<br>
The&nbsp;vptr&nbsp;of&nbsp;each&nbsp;base&nbsp;subobject&nbsp;of&nbsp;an&nbsp;object&nbsp;of&nbsp;the&nbsp;derived&nbsp;class&nbsp;will<br>
point&nbsp;to&nbsp;the&nbsp;corresponding&nbsp;base&nbsp;vtable&nbsp;in&nbsp;this&nbsp;set.<br>
<br>
&lt;p&gt;<br>
The&nbsp;vtable&nbsp;copied&nbsp;from&nbsp;the&nbsp;primary&nbsp;base&nbsp;class&nbsp;is&nbsp;also&nbsp;called&nbsp;the<br>
primary&nbsp;vtable;<br>
it&nbsp;is&nbsp;addressed&nbsp;by&nbsp;the&nbsp;vtable&nbsp;pointer&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;object.<br>
The&nbsp;other&nbsp;vtables&nbsp;of&nbsp;the&nbsp;class&nbsp;are&nbsp;called&nbsp;secondary&nbsp;vtables;<br>
they&nbsp;are&nbsp;addressed&nbsp;by&nbsp;vtable&nbsp;pointers&nbsp;inside&nbsp;the&nbsp;object.<br>
<br>
&lt;p&gt;<br>
Following&nbsp;the&nbsp;function&nbsp;pointer&nbsp;entries&nbsp;that&nbsp;correspond&nbsp;to&nbsp;those&nbsp;of&nbsp;the<br>
primary&nbsp;base&nbsp;class,<br>
the&nbsp;primary&nbsp;vtable&nbsp;holds&nbsp;the&nbsp;following&nbsp;additional&nbsp;entries&nbsp;at&nbsp;its&nbsp;tail:<br>
&lt;ul&gt;<br>
&lt;li&gt;&nbsp;Entries&nbsp;for&nbsp;virtual&nbsp;functions&nbsp;introduced&nbsp;by&nbsp;this&nbsp;class.<br>
&lt;li&gt;&nbsp;Entries&nbsp;for&nbsp;overridden&nbsp;virtual&nbsp;functions&nbsp;not&nbsp;already&nbsp;in&nbsp;the&nbsp;vtable.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(These&nbsp;are&nbsp;also&nbsp;called&nbsp;replicated&nbsp;entries&nbsp;because&nbsp;they&nbsp;are&nbsp;already<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in&nbsp;the&nbsp;secondary&nbsp;vtables&nbsp;of&nbsp;the&nbsp;class.)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;font&nbsp;color=red&gt;&nbsp;&lt;i&gt;Question:&lt;/i&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Are&nbsp;these&nbsp;really&nbsp;needed?<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/font&gt;<br>
&lt;/ul&gt;<br>
<br>
The&nbsp;primary&nbsp;vtable,&nbsp;therefore,<br>
has&nbsp;the&nbsp;base&nbsp;class&nbsp;functions&nbsp;appearing&nbsp;before&nbsp;the&nbsp;derived&nbsp;class&nbsp;functions.<br>
The&nbsp;primary&nbsp;vtable&nbsp;can&nbsp;be&nbsp;viewed&nbsp;as&nbsp;two&nbsp;vtables&nbsp;accessed<br>
from&nbsp;a&nbsp;shared&nbsp;vtable&nbsp;pointer.&nbsp;<br>
<br>
&lt;p&gt;<br>
&lt;i&gt;Note&lt;/i&gt;:<br>
Another&nbsp;benefit&nbsp;of&nbsp;replicating&nbsp;virtual&nbsp;function&nbsp;entries&nbsp;is&nbsp;that&nbsp;it<br>
reduces&nbsp;the&nbsp;number&nbsp;of&nbsp;this&nbsp;pointer&nbsp;adjustments&nbsp;during&nbsp;virtual&nbsp;calls.<br>
Without&nbsp;replication,<br>
there&nbsp;would&nbsp;be&nbsp;more&nbsp;cases&nbsp;where&nbsp;the&nbsp;this&nbsp;pointer&nbsp;would&nbsp;have&nbsp;to&nbsp;be<br>
adjusted&nbsp;to&nbsp;access&nbsp;a&nbsp;secondary&nbsp;vtable&nbsp;prior&nbsp;to&nbsp;the&nbsp;call.<br>
These&nbsp;additional&nbsp;cases&nbsp;would&nbsp;be&nbsp;exactly&nbsp;those&nbsp;where&nbsp;the&nbsp;function<br>
is&nbsp;overridden&nbsp;in&nbsp;the&nbsp;derived&nbsp;class,<br>
implying&nbsp;an&nbsp;additional&nbsp;thunk&nbsp;adjustment&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;pointer.<br>
Thus&nbsp;replication&nbsp;saves&nbsp;two&nbsp;adjustments&nbsp;for&nbsp;each&nbsp;virtual&nbsp;call&nbsp;to&nbsp;an<br>
overridden&nbsp;function&nbsp;introduced&nbsp;by&nbsp;a&nbsp;non-primary&nbsp;base&nbsp;class.&nbsp;<br>
<br>
&lt;p&gt;<br>
&lt;h5&gt;&nbsp;Category&nbsp;3:&nbsp;Virtual&nbsp;Bases&nbsp;Only&nbsp;&lt;/h5&gt;<br>
<br>
Structure:<br>
&lt;ul&gt;<br>
&lt;li&gt;&nbsp;Only&nbsp;virtual&nbsp;base&nbsp;classes.<br>
&lt;li&gt;&nbsp;Base&nbsp;classes&nbsp;are&nbsp;not&nbsp;empty&nbsp;or&nbsp;nearly&nbsp;empty.<br>
&lt;li&gt;&nbsp;Base&nbsp;classes&nbsp;are&nbsp;trivial&nbsp;or&nbsp;leaf&nbsp;(they&nbsp;have&nbsp;no&nbsp;base&nbsp;classes).<br>
&lt;/ul&gt;<br>
<br>
&lt;p&gt;<br>
The&nbsp;class&nbsp;has&nbsp;a&nbsp;vtable&nbsp;for&nbsp;each&nbsp;virtual&nbsp;base&nbsp;class&nbsp;that&nbsp;has&nbsp;a&nbsp;vtable.<br>
These&nbsp;are&nbsp;all&nbsp;secondary&nbsp;vtables&nbsp;and&nbsp;are&nbsp;constructed&nbsp;from&nbsp;copies&nbsp;of&nbsp;the<br>
base&nbsp;class&nbsp;vtables&nbsp;according&nbsp;to&nbsp;the&nbsp;same&nbsp;rules&nbsp;as&nbsp;in&nbsp;Category&nbsp;2.<br>
The&nbsp;vtable&nbsp;pointers&nbsp;of&nbsp;the&nbsp;virtual&nbsp;base&nbsp;subobjects&nbsp;within&nbsp;the&nbsp;object<br>
address&nbsp;these&nbsp;vtables.&nbsp;<br>
<br>
&lt;p&gt;<br>
The&nbsp;class&nbsp;also&nbsp;has&nbsp;a&nbsp;vtable&nbsp;that&nbsp;is&nbsp;not&nbsp;copied&nbsp;from&nbsp;the&nbsp;virtual&nbsp;base<br>
class&nbsp;vtables.<br>
This&nbsp;vtable&nbsp;is&nbsp;the&nbsp;primary&nbsp;vtable&nbsp;of&nbsp;the&nbsp;class&nbsp;and&nbsp;addressed&nbsp;by&nbsp;the<br>
vtable&nbsp;pointer&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;object,&nbsp;which&nbsp;is&nbsp;not&nbsp;shared.<br>
It&nbsp;holds&nbsp;the&nbsp;following&nbsp;function&nbsp;pointer&nbsp;entries:&nbsp;<br>
<br>
&lt;ul&gt;<br>
&lt;p&gt;<br>
&lt;li&gt;&nbsp;Entries&nbsp;for&nbsp;virtual&nbsp;functions&nbsp;introduced&nbsp;by&nbsp;this&nbsp;class.<br>
<br>
&lt;p&gt;<br>
&lt;li&gt;&nbsp;Entries&nbsp;for&nbsp;overridden&nbsp;virtual&nbsp;functions.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(These&nbsp;are&nbsp;also&nbsp;called&nbsp;replicated&nbsp;entries,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;because&nbsp;they&nbsp;are&nbsp;already&nbsp;in&nbsp;the&nbsp;secondary&nbsp;vtables&nbsp;of&nbsp;the&nbsp;class.)<br>
&lt;/ul&gt;<br>
<br>
&lt;p&gt;<br>
The&nbsp;primary&nbsp;vtable&nbsp;also&nbsp;has&nbsp;virtual&nbsp;base&nbsp;offset&nbsp;entries<br>
to&nbsp;allow&nbsp;finding&nbsp;the&nbsp;virtual&nbsp;base&nbsp;subobjects.<br>
There&nbsp;is&nbsp;one&nbsp;virtual&nbsp;base&nbsp;offset&nbsp;entry&nbsp;for&nbsp;each&nbsp;virtual&nbsp;base&nbsp;class.<br>
For&nbsp;a&nbsp;class&nbsp;that&nbsp;inherits&nbsp;only&nbsp;virtual&nbsp;bases,<br>
the&nbsp;entries&nbsp;are&nbsp;in&nbsp;the&nbsp;reverse&nbsp;order&nbsp;in&nbsp;which&nbsp;the<br>
virtual&nbsp;bases&nbsp;appear&nbsp;in&nbsp;the&nbsp;class&nbsp;declaration,<br>
that&nbsp;is,&nbsp;the&nbsp;entry&nbsp;for&nbsp;the&nbsp;leftmost&nbsp;virtual<br>
base&nbsp;is&nbsp;closest&nbsp;to&nbsp;the&nbsp;address&nbsp;point&nbsp;of&nbsp;the&nbsp;vtable.&nbsp;<br>
<br>
<br>
&lt;p&gt;<br>
&lt;h5&gt;&nbsp;Category&nbsp;4:&nbsp;Complex&nbsp;&lt;/h5&gt;<br>
<br>
Structure:<br>
&lt;ul&gt;<br>
&lt;li&gt;&nbsp;None&nbsp;of&nbsp;the&nbsp;above,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i.e.&nbsp;directly&nbsp;or&nbsp;indirectly&nbsp;inherits&nbsp;both&nbsp;virtual&nbsp;and&nbsp;non-virtual<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base&nbsp;classes,&nbsp;or&nbsp;at&nbsp;least&nbsp;one&nbsp;nearly&nbsp;empty&nbsp;virtual&nbsp;base&nbsp;class.<br>
&lt;/ul&gt;<br>
<br>
&lt;p&gt;<br>
The&nbsp;rules&nbsp;for&nbsp;constructing&nbsp;vtables&nbsp;of&nbsp;the&nbsp;class&nbsp;are&nbsp;a&nbsp;combination&nbsp;of<br>
the&nbsp;rules&nbsp;from&nbsp;Categories&nbsp;2&nbsp;and&nbsp;3,<br>
and&nbsp;for&nbsp;the&nbsp;most&nbsp;part&nbsp;can&nbsp;be&nbsp;determined&nbsp;inductively.<br>
However&nbsp;the&nbsp;rules&nbsp;for&nbsp;placing&nbsp;virtual&nbsp;base&nbsp;offset&nbsp;entries&nbsp;in&nbsp;the<br>
vtables&nbsp;requires&nbsp;elaboration.&nbsp;<br>
<br>
&lt;p&gt;<br>
The&nbsp;primary&nbsp;vtable&nbsp;has&nbsp;virtual&nbsp;base&nbsp;offset&nbsp;entries&nbsp;for&nbsp;all&nbsp;virtual<br>
bases&nbsp;directly&nbsp;or&nbsp;indirectly&nbsp;inherited&nbsp;by&nbsp;the&nbsp;class.<br>
Each&nbsp;secondary&nbsp;vtable&nbsp;has&nbsp;entries&nbsp;only&nbsp;for&nbsp;virtual<br>
bases&nbsp;visible&nbsp;to&nbsp;the&nbsp;corresponding&nbsp;base&nbsp;class.<br>
The&nbsp;entries&nbsp;in&nbsp;the&nbsp;primary&nbsp;vtable&nbsp;are&nbsp;ordered&nbsp;so&nbsp;that&nbsp;entries&nbsp;for<br>
virtual&nbsp;bases&nbsp;visible&nbsp;to&nbsp;the&nbsp;primary&nbsp;base&nbsp;class&nbsp;are&nbsp;placed&nbsp;closest<br>
to&nbsp;the&nbsp;vtable&nbsp;address&nbsp;point,&nbsp;i.e.&nbsp;at&nbsp;higher&nbsp;addresses,<br>
while&nbsp;entries&nbsp;for&nbsp;virtual&nbsp;bases&nbsp;only&nbsp;visible&nbsp;to&nbsp;this&nbsp;class&nbsp;are&nbsp;further<br>
from&nbsp;the&nbsp;vtable&nbsp;address&nbsp;point,&nbsp;i.e.&nbsp;at&nbsp;lower&nbsp;addresses.&nbsp;<br>
<br>
&lt;p&gt;<br>
For&nbsp;virtual&nbsp;bases&nbsp;only&nbsp;visible&nbsp;to&nbsp;this&nbsp;class,<br>
the&nbsp;entries&nbsp;are&nbsp;in&nbsp;the&nbsp;reverse&nbsp;order&nbsp;in&nbsp;which&nbsp;the&nbsp;virtual&nbsp;bases&nbsp;are<br>
encountered&nbsp;in&nbsp;a&nbsp;depth-first,&nbsp;left-to-right&nbsp;traversal&nbsp;of&nbsp;the<br>
inheritance&nbsp;graph&nbsp;formed&nbsp;by&nbsp;the&nbsp;class&nbsp;definitions.<br>
Note&nbsp;that&nbsp;this&nbsp;does&nbsp;not&nbsp;follow&nbsp;the<br>
order&nbsp;that&nbsp;virtual&nbsp;bases&nbsp;are&nbsp;placed&nbsp;in&nbsp;the&nbsp;object.&nbsp;<br>
<br>
<br>
<br>
&lt;i&gt;<br>
&lt;font&nbsp;color=red&gt;<br>
&lt;p&gt;<br>
&lt;h4&gt;&nbsp;Issues:&nbsp;&lt;/h4&gt;<br>
&lt;ul&gt;<br>
&lt;li&gt;&nbsp;A-6:&nbsp;&nbsp;RTTI&nbsp;representation.<br>
&lt;li&gt;&nbsp;A-6:&nbsp;&nbsp;Duplicate&nbsp;base&nbsp;structure&nbsp;representation.<br>
&lt;li&gt;&nbsp;B-2:&nbsp;&nbsp;Will&nbsp;contain&nbsp;one&nbsp;entry&nbsp;per&nbsp;return&nbsp;type&nbsp;for&nbsp;covariant&nbsp;returns.<br>
&lt;/ul&gt;<br>
&lt;/font&gt;<br>
&lt;/i&gt;<br>
<br>
<br>
&lt;p&gt;&nbsp;&lt;hr&gt;&nbsp;&lt;p&gt;<br>
&lt;h3&gt;&nbsp;External&nbsp;Names&nbsp;(a.k.a.&nbsp;Mangling)&nbsp;&lt;/h3&gt;<br>
<br>
&lt;i&gt;<br>
&lt;To&nbsp;be&nbsp;specified.&gt;<br>
<br>
&lt;p&gt;<br>
&lt;hr&gt;<br>
<br>
&lt;p&gt;<br>
Please&nbsp;send&nbsp;corrections&nbsp;to&nbsp;&lt;a&nbsp;href=mailto:dehnert@sgi.com&gt;Jim&nbsp;Dehnert&lt;/a&gt;.<br>
<br>
&lt;/BODY&gt;<br>
&lt;/HTML&gt;<br>

</tt>
