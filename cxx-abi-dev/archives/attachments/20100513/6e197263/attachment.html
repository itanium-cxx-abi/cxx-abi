<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;div&gt;I'm&nbsp;exploring&nbsp;adding&nbsp;some&nbsp;new&nbsp;interfaces&nbsp;(described&nbsp;below)&nbsp;to&nbsp;Apple's&nbsp;implementation&nbsp;of&nbsp;the&nbsp;C++&nbsp;ABI.&nbsp;&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;interest&nbsp;here&nbsp;in&nbsp;adding&nbsp;these&nbsp;to&nbsp;the&nbsp;base&nbsp;C++&nbsp;ABI,&nbsp;we&nbsp;can&nbsp;add&nbsp;them&nbsp;in&nbsp;a&nbsp;new&nbsp;namespace&nbsp;like&nbsp;__cxxabiapple&nbsp;(instead&nbsp;of&nbsp;__cxxabiv1).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;As&nbsp;you&nbsp;may&nbsp;have&nbsp;heard,&nbsp;&lt;a&nbsp;href=&quot;http://llvm.org/&quot;&gt;llvm.org&lt;/a&gt;&nbsp;is&nbsp;working&nbsp;on&nbsp;a&nbsp;new&nbsp;C++&nbsp;library&nbsp;implementation&nbsp;&lt;&lt;a&nbsp;href=&quot;http://libcxx.llvm.org/&quot;&gt;http://libcxx.llvm.org/&lt;/a&gt;&gt;.&nbsp;&nbsp;Apple&nbsp;would&nbsp;like&nbsp;to&nbsp;release&nbsp;a&nbsp;shared&nbsp;library&nbsp;version&nbsp;of&nbsp;this&nbsp;library&nbsp;(libc++.dylib)&nbsp;in&nbsp;parallel&nbsp;with&nbsp;the&nbsp;existing&nbsp;gcc&nbsp;based&nbsp;C++&nbsp;library&nbsp;(libstc++.dylib).&nbsp;&nbsp;&nbsp;In&nbsp;order&nbsp;to&nbsp;allow&nbsp;these&nbsp;libraries&nbsp;to&nbsp;inter-operate,&nbsp;we&nbsp;plan&nbsp;to&nbsp;factor&nbsp;out&nbsp;the&nbsp;C++&nbsp;ABI&nbsp;parts&nbsp;of&nbsp;libstdc++.dylib&nbsp;into&nbsp;a&nbsp;stand&nbsp;alone&nbsp;library&nbsp;(libc++abi.dylib)&nbsp;which&nbsp;will&nbsp;then&nbsp;be&nbsp;used&nbsp;by&nbsp;the&nbsp;higher&nbsp;level&nbsp;C++&nbsp;libraries.&lt;br&gt;&lt;br&gt;But&nbsp;there&nbsp;are&nbsp;a&nbsp;few&nbsp;extra&nbsp;things&nbsp;we&nbsp;need&nbsp;in&nbsp;libc++abi.dylib&nbsp;(beyond&nbsp;what&nbsp;the&nbsp;current&nbsp;ABI&nbsp;specifies)&nbsp;to&nbsp;support&nbsp;multiple&nbsp;C++&nbsp;libraries.&nbsp;&nbsp;I&nbsp;wanted&nbsp;to&nbsp;explain&nbsp;our&nbsp;current&nbsp;implementation&nbsp;to&nbsp;see&nbsp;if&nbsp;this&nbsp;might&nbsp;lead&nbsp;to&nbsp;future&nbsp;issues:&lt;br&gt;&lt;br&gt;1)&nbsp;std::set_terminate(),&nbsp;std::set_unexpected(),&nbsp;and&nbsp;std::set_new_handler()&nbsp;assume&nbsp;there&nbsp;is&nbsp;one&nbsp;process&nbsp;wide&nbsp;global&nbsp;holding&nbsp;the&nbsp;current&nbsp;handler.&nbsp;&nbsp;&nbsp;To&nbsp;support&nbsp;this&nbsp;we&nbsp;are&nbsp;adding&nbsp;three&nbsp;global&nbsp;variables&nbsp;to&nbsp;libc++abi.dylib:&nbsp;&nbsp;__cxa_terminate_handler,&nbsp;__cxa_unexpected_handler,&nbsp;and&nbsp;__cxa_new_handler.&nbsp;&nbsp;&nbsp;The&nbsp;two&nbsp;C++&nbsp;libraries&nbsp;atop&nbsp;libc++abi.dylib&nbsp;will&nbsp;use&nbsp;these&nbsp;global&nbsp;variables&nbsp;instead&nbsp;of&nbsp;having&nbsp;their&nbsp;own&nbsp;copy.&lt;br&gt;&lt;br&gt;2)&nbsp;C++&nbsp;0x&nbsp;introduces&nbsp;std::exception_ptr.&nbsp;&nbsp;Two&nbsp;years&nbsp;ago&nbsp;on&nbsp;this&nbsp;list,&nbsp;Sebastian&nbsp;Redl&nbsp;outlined&nbsp;&lt;&lt;a&nbsp;href=&quot;http://www.codesourcery.com/archives/cxx-abi-dev/msg01924.html&quot;&gt;http://www.codesourcery.com/archives/cxx-abi-dev/msg01924.html&lt;/a&gt;&gt;&nbsp;a&nbsp;way&nbsp;to&nbsp;support&nbsp;exception_ptr&nbsp;by&nbsp;adding&nbsp;a&nbsp;field&nbsp;to&nbsp;__cxa_exception&nbsp;and&nbsp;add&nbsp;a&nbsp;similar&nbsp;__cxa_dependent_exception&nbsp;struct.&nbsp;&nbsp;&nbsp;This&nbsp;implementation&nbsp;works,&nbsp;but&nbsp;it&nbsp;exposes&nbsp;some&nbsp;inner&nbsp;workings&nbsp;of&nbsp;libc++abi.dylib.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;only&nbsp;use&nbsp;of&nbsp;__cxa_exception&nbsp;needed&nbsp;in&nbsp;the&nbsp;higher&nbsp;level&nbsp;C++&nbsp;libraries.&nbsp;To&nbsp;provide&nbsp;better&nbsp;encapsulation,&nbsp;we've&nbsp;created&nbsp;a&nbsp;procedural&nbsp;interface&nbsp;in&nbsp;&nbsp;libc++abi.dylib&nbsp;for&nbsp;use&nbsp;by&nbsp;exception_ptr:&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;extern&nbsp;void&nbsp;*&nbsp;__cxa_current_primary_exception()&nbsp;throw();&lt;br&gt;&nbsp;&nbsp;extern&nbsp;void&nbsp;__cxa_rethrow_primary_exception(void*&nbsp;primary_exception);&lt;br&gt;&nbsp;&nbsp;extern&nbsp;void&nbsp;__cxa_increment_exception_refcount(void*&nbsp;primary_exception)&nbsp;throw();&lt;br&gt;&nbsp;&nbsp;extern&nbsp;void&nbsp;__cxa_decrement_exception_refcount(void*&nbsp;primary_exception)&nbsp;throw();&lt;br&gt;&lt;br&gt;These&nbsp;make&nbsp;the&nbsp;implementation&nbsp;of&nbsp;exception_ptr&nbsp;trivial:&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;exception_ptr::~exception_ptr()&nbsp;&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__cxa_decrement_exception_refcount(__ptr_);&lt;br&gt;&nbsp;&nbsp;}&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;exception_ptr::exception_ptr(const&nbsp;exception_ptr&amp;&nbsp;other)&nbsp;&nbsp;&nbsp;:&nbsp;__ptr_(other.__ptr_)&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__cxa_increment_exception_refcount(__ptr_);&lt;br&gt;&nbsp;&nbsp;}&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;std::exception_ptr&nbsp;std::current_exception()&nbsp;{&lt;br&gt;&nbsp;&nbsp;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:&nbsp;pre;&nbsp;&quot;&gt;&nbsp;&nbsp;&lt;/span&gt;return&nbsp;exception_ptr(__cxa_current_primary_exception());&lt;br&gt;&nbsp;&nbsp;}&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;void&nbsp;std::rethrow_exception(exception_ptr&nbsp;p)&nbsp;&nbsp;{&lt;br&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:&nbsp;pre;&nbsp;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;__cxa_rethrow_primary_exception(p.__ptr_);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::terminate();&lt;br&gt;&nbsp;&nbsp;}&lt;br&gt;&lt;br&gt;3)&nbsp;Lastly,&nbsp;the&nbsp;only&nbsp;use&nbsp;of&nbsp;__cxa_globals&nbsp;in&nbsp;the&nbsp;higher&nbsp;level&nbsp;C++&nbsp;libraries&nbsp;is&nbsp;to&nbsp;implement&nbsp;std::uncaught_exception().&nbsp;&nbsp;To&nbsp;keep&nbsp;__cxa_globals&nbsp;(like&nbsp;__cxa_exception)&nbsp;private&nbsp;to&nbsp;&nbsp;libc++abi.dylib,&nbsp;we've&nbsp;added&nbsp;a&nbsp;new&nbsp;function:&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;extern&nbsp;bool&nbsp;__cxa_uncaught_exception()&nbsp;throw();&lt;br&gt;&lt;br&gt;These&nbsp;new&nbsp;entry&nbsp;points&nbsp;will&nbsp;be&nbsp;in&nbsp;Apple's&nbsp;&lt;cxxabi.h&gt;.&nbsp;&nbsp;Is&nbsp;there&nbsp;any&nbsp;model&nbsp;for&nbsp;platform&nbsp;specific&nbsp;additions&nbsp;to&nbsp;the&nbsp;C++&nbsp;ABI&nbsp;like&nbsp;these?&lt;br&gt;&lt;br&gt;-------------&lt;br&gt;Nick&nbsp;Kledzik&lt;br&gt;Apple&nbsp;Inc.&lt;br&gt;&lt;br&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
