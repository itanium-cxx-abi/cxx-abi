<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=utf-8&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;Apr&nbsp;26,&nbsp;2015,&nbsp;at&nbsp;2:26&nbsp;PM,&nbsp;Richard&nbsp;Smith&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:richardsmith@googlers.com&quot;&nbsp;class=&quot;&quot;&gt;richardsmith@googlers.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;25&nbsp;April&nbsp;2015&nbsp;at&nbsp;21:10,&nbsp;John&nbsp;McCall&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:rjmccall@apple.com&quot;&nbsp;target=&quot;_blank&quot;&nbsp;class=&quot;&quot;&gt;rjmccall@apple.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;The&nbsp;standard&nbsp;says&nbsp;that&nbsp;std::is_empty&lt;T&gt;::value&nbsp;is&nbsp;true&nbsp;if:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;-&nbsp;T&nbsp;is&nbsp;a&nbsp;class&nbsp;type,&nbsp;but&nbsp;not&nbsp;a&nbsp;union&nbsp;type,&nbsp;with&nbsp;no&nbsp;non-static&nbsp;data&nbsp;members&nbsp;other&nbsp;than&nbsp;bit-fields&nbsp;of&nbsp;length&nbsp;0,&nbsp;no&nbsp;virtual&nbsp;member&nbsp;functions,&nbsp;no&nbsp;virtual&nbsp;base&nbsp;classes,&nbsp;and&nbsp;no&nbsp;base&nbsp;class&nbsp;B&nbsp;for&nbsp;which&nbsp;is_empty&lt;B&gt;::value&nbsp;is&nbsp;false.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
The&nbsp;standard&nbsp;also&nbsp;says&nbsp;that&nbsp;array&nbsp;bounds&nbsp;must&nbsp;be&nbsp;greater&nbsp;than&nbsp;zero,&nbsp;but&nbsp;there’s&nbsp;a&nbsp;common&nbsp;extension&nbsp;to&nbsp;permit&nbsp;zero-length&nbsp;array&nbsp;types&nbsp;(hereafter,&nbsp;ZLATs).&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
In&nbsp;GCC&nbsp;and&nbsp;Clang,&nbsp;at&nbsp;least,&nbsp;a&nbsp;ZLAT&nbsp;conventionally&nbsp;has&nbsp;size&nbsp;0,&nbsp;both&nbsp;formally&nbsp;(as&nbsp;a&nbsp;result&nbsp;of&nbsp;sizeof)&nbsp;and&nbsp;for&nbsp;struct&nbsp;layout&nbsp;(a&nbsp;ZLAT&nbsp;field&nbsp;takes&nbsp;up&nbsp;no&nbsp;direct&nbsp;space,&nbsp;although&nbsp;it&nbsp;does&nbsp;cause&nbsp;the&nbsp;next&nbsp;offset&nbsp;to&nbsp;be&nbsp;rounded&nbsp;up&nbsp;to&nbsp;the&nbsp;field’s&nbsp;alignment).&nbsp;&nbsp;Moreover,&nbsp;a&nbsp;ZLAT&nbsp;field&nbsp;inhibits&nbsp;the&nbsp;general&nbsp;rule&nbsp;rounding&nbsp;a&nbsp;class's&nbsp;size&nbsp;up&nbsp;to&nbsp;at&nbsp;least&nbsp;1,&nbsp;recursively.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
Oddly,&nbsp;though,&nbsp;GCC&nbsp;and&nbsp;Clang&nbsp;also&nbsp;say&nbsp;that&nbsp;a&nbsp;struct&nbsp;containing&nbsp;a&nbsp;ZLAT&nbsp;is&nbsp;not&nbsp;empty,&nbsp;at&nbsp;least&nbsp;as&nbsp;far&nbsp;as&nbsp;std::is_empty&nbsp;is&nbsp;concerned.&nbsp;&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;ICC&nbsp;says&nbsp;that&nbsp;a&nbsp;struct&nbsp;containing&nbsp;only&nbsp;one&nbsp;(or&nbsp;more)&nbsp;ZLATs&nbsp;is&nbsp;empty;&nbsp;as&nbsp;does&nbsp;MSVC,&nbsp;for&nbsp;what&nbsp;it’s&nbsp;worth.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
This&nbsp;touches&nbsp;on&nbsp;the&nbsp;ABI&nbsp;because:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;-&nbsp;the&nbsp;results&nbsp;of&nbsp;these&nbsp;metaprogramming&nbsp;traits&nbsp;can&nbsp;affect&nbsp;the&nbsp;ABI&nbsp;in&nbsp;a&nbsp;number&nbsp;of&nbsp;ways,&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;-&nbsp;class&nbsp;sizes&nbsp;are&nbsp;also&nbsp;obviously&nbsp;ABI,&nbsp;and&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;-&nbsp;whether&nbsp;a&nbsp;base&nbsp;class&nbsp;is&nbsp;empty&nbsp;dramatically&nbsp;affects&nbsp;Itanium&nbsp;class&nbsp;layout.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
The&nbsp;current&nbsp;Itanium&nbsp;definition&nbsp;mirrors&nbsp;the&nbsp;std::is_empty&nbsp;definition:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;[a]&nbsp;class&nbsp;with&nbsp;no&nbsp;non-static&nbsp;data&nbsp;members&nbsp;other&nbsp;than&nbsp;zero-width&nbsp;bitfields,&nbsp;no&nbsp;virtual&nbsp;functions,&nbsp;no&nbsp;virtual&nbsp;base&nbsp;classes,&nbsp;and&nbsp;no&nbsp;non-empty&nbsp;non-virtual&nbsp;proper&nbsp;base&nbsp;classes.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
Now,&nbsp;of&nbsp;course,&nbsp;this&nbsp;is&nbsp;an&nbsp;extension,&nbsp;and&nbsp;we&nbsp;don’t&nbsp;have&nbsp;to&nbsp;standardize&nbsp;behavior&nbsp;on&nbsp;it;&nbsp;but&nbsp;my&nbsp;preference&nbsp;is&nbsp;to&nbsp;specify&nbsp;this&nbsp;sort&nbsp;of&nbsp;common&nbsp;extension&nbsp;wherever&nbsp;possible.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;The&nbsp;point&nbsp;of&nbsp;is_empty&nbsp;is&nbsp;to&nbsp;allow&nbsp;detection&nbsp;of&nbsp;EBO&nbsp;opportunities,&nbsp;so&nbsp;I&nbsp;think&nbsp;it&nbsp;should&nbsp;return&nbsp;'true'&nbsp;in&nbsp;all&nbsp;cases&nbsp;where&nbsp;EBO&nbsp;would&nbsp;apply.&nbsp;It&nbsp;seems&nbsp;reasonable&nbsp;(if&nbsp;not&nbsp;very&nbsp;worthwhile)&nbsp;to&nbsp;ignore&nbsp;ZLATs&nbsp;when&nbsp;determining&nbsp;whether&nbsp;we&nbsp;can&nbsp;apply&nbsp;EBO.&nbsp;And&nbsp;I&nbsp;think&nbsp;this&nbsp;is&nbsp;a&nbsp;common&nbsp;enough&nbsp;extension&nbsp;for&nbsp;the&nbsp;ABI&nbsp;to&nbsp;specify&nbsp;how&nbsp;it&nbsp;should&nbsp;behave.&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&nbsp;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;<br>
I&nbsp;propose&nbsp;the&nbsp;following&nbsp;changes:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
1.&nbsp;&nbsp;Add&nbsp;“or&nbsp;members&nbsp;of&nbsp;zero-length&nbsp;array&nbsp;type”&nbsp;to&nbsp;the&nbsp;ABI&nbsp;definition&nbsp;of&nbsp;&quot;empty&nbsp;class”.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Is&nbsp;it&nbsp;worth&nbsp;explicitly&nbsp;calling&nbsp;out&nbsp;that&nbsp;flexible&nbsp;array&nbsp;members&nbsp;and&nbsp;zero-length&nbsp;array&nbsp;members&nbsp;are&nbsp;handled&nbsp;the&nbsp;same&nbsp;in&nbsp;this&nbsp;regard?&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;Yes,&nbsp;that’s&nbsp;probably&nbsp;a&nbsp;good&nbsp;idea.&lt;/div&gt;&lt;div&gt;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;<br>
2.&nbsp;&nbsp;Specify&nbsp;std::is_empty&nbsp;to&nbsp;behave&nbsp;as&nbsp;if&nbsp;the&nbsp;same&nbsp;clause&nbsp;were&nbsp;there.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
3.&nbsp;&nbsp;Change&nbsp;the&nbsp;ABI&nbsp;class&nbsp;layout&nbsp;rule&nbsp;(in&nbsp;IV.&nbsp;Finalization)&nbsp;to&nbsp;not&nbsp;require&nbsp;sizeof(C)&nbsp;to&nbsp;be&nbsp;non-zero&nbsp;if&nbsp;C&nbsp;contains&nbsp;a&nbsp;ZLAT&nbsp;subobject.&nbsp;&nbsp;That&nbsp;is,&nbsp;replace&nbsp;this&nbsp;sentence:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;Round&nbsp;sizeof(C)&nbsp;up&nbsp;to&nbsp;a&nbsp;non-zero&nbsp;multiple&nbsp;of&nbsp;align(C).&lt;br&nbsp;class=&quot;&quot;&gt;<br>
with:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;If&nbsp;C&nbsp;does&nbsp;not&nbsp;contain&nbsp;(recursively)&nbsp;a&nbsp;subobject&nbsp;of&nbsp;zero-length&nbsp;array&nbsp;type,&nbsp;and&nbsp;sizeof(C)&nbsp;is&nbsp;0,&nbsp;set&nbsp;sizeof(C)&nbsp;to&nbsp;align(C);&nbsp;otherwise,&nbsp;round&nbsp;sizeof(C)&nbsp;up&nbsp;to&nbsp;a&nbsp;multiple&nbsp;of&nbsp;align(C).&lt;/blockquote&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Perhaps:&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;If&nbsp;sizeof(C)&nbsp;is&nbsp;0&nbsp;and&nbsp;C&nbsp;has&nbsp;no&nbsp;non-static&nbsp;data&nbsp;members&nbsp;and&nbsp;no&nbsp;base&nbsp;classes,&nbsp;set&nbsp;sizeof(C)&nbsp;to&nbsp;align(C);&nbsp;otherwise,&nbsp;round&nbsp;sizeof(C)&nbsp;up&nbsp;to&nbsp;a&nbsp;multiple&nbsp;of&nbsp;align(C).&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;Wouldn’t&nbsp;this&nbsp;trigger&nbsp;for&nbsp;a&nbsp;class&nbsp;with&nbsp;an&nbsp;empty&nbsp;base?&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;I&nbsp;think&nbsp;that's&nbsp;equivalent,&nbsp;and&nbsp;it&nbsp;seems&nbsp;simpler&nbsp;and&nbsp;more&nbsp;general.&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Another&nbsp;problem&nbsp;is&nbsp;in&nbsp;step&nbsp;2&nbsp;of&nbsp;the&nbsp;layout&nbsp;algorithm:&nbsp;&quot;Place&nbsp;D&nbsp;at&nbsp;this&nbsp;offset&nbsp;unless&nbsp;doing&nbsp;so&nbsp;would&nbsp;result&nbsp;in&nbsp;two&nbsp;components&nbsp;(direct&nbsp;or&nbsp;indirect)&nbsp;of&nbsp;the&nbsp;same&nbsp;type&nbsp;having&nbsp;the&nbsp;same&nbsp;offset.&quot;.&nbsp;That&nbsp;does&nbsp;the&nbsp;wrong&nbsp;thing&nbsp;for:&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;struct&nbsp;A&nbsp;{&nbsp;int&nbsp;n[0];&nbsp;int&nbsp;m[0];&nbsp;};&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;where&nbsp;sizeof(A)&nbsp;should&nbsp;be&nbsp;zero,&nbsp;but&nbsp;will&nbsp;be&nbsp;4&nbsp;with&nbsp;this&nbsp;algorithm&nbsp;because&nbsp;putting&nbsp;m&nbsp;at&nbsp;offset&nbsp;0&nbsp;gives&nbsp;two&nbsp;components&nbsp;of&nbsp;type&nbsp;'int[0]'&nbsp;at&nbsp;the&nbsp;same&nbsp;offset.&nbsp;Perhaps&nbsp;replace&nbsp;&quot;components&nbsp;(direct&nbsp;or&nbsp;indirect)&quot;&nbsp;with&nbsp;&quot;non-array&nbsp;subobjects&quot;?&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;That&nbsp;seems&nbsp;reasonable.&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;John.&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
